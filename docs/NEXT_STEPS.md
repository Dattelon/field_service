# Field Service Admin Bot Progress

## Что сделано
- Заданы новые DTO для админ-бота (`field_service/bots/admin_bot/dto.py`): структуры персонала, очереди заказов, карточек заказов, комиссий и данных для создания заявок.
- Модели БД расширены (`field_service/db/models.py`): добавлен enum `OrderType`, в `orders` появились поля `category`, `description`, `order_type`, координаты, `company_payment`, `late_visit`; создана таблица `staff_access_code_cities` и расширена `staff_access_codes`.
- Реализован сервисный слой (`field_service/bots/admin_bot/services_db.py`):
  - `DBStaffService` управляет персоналом, кодами доступа и фильтрацией по городам/ролям.
  - `DBOrdersService` возвращает полные карточки заказов, учитывая вложения, тип и новые поля, позволяет создавать заявки и выполнять ручное назначение.
  - `DBDistributionService`, `DBMastersService`, `DBFinanceService`, `DBSettingsService` адаптированы к новой схеме.
- Добавлена миграция `alembic/versions/2025_09_19_0014_admin_bot_core.py`, синхронизирующая схему БД с новыми сущностями.
- `handlers.py` переведён на новые DTO, обновлены импорты и аннотации.

## Что дальше
1. Переписать обработчики админ-бота: реализовать меню, очередь, создание заявки, назначение мастеров, финансы, отчёты, настройки и раздел «Доступ и персонал» на базе новых сервисов.
2. Обновить `handlers_staff.py`: перевести на новые DAO, поддержать многогородовые коды доступа и согласовать функции со сценариями v1.2.
3. Подключить обновлённые сервисы в `main.py`, восстановить `service_registry` и `stubs`, обеспечить корректную инициализацию зависимостей.
4. Реализовать FSM и клавиатуры для длинных сценариев (создание заявки, распределение, финансы, управление персоналом) согласно ТЗ v1.2.
5. Дополнить тесты: покрыть новые DAO и сценарии админ-бота, обновить smoke-скрипты и документацию, при необходимости расширить README.

## 2025-09-20 — миграции БД v1.2
- Исправил `2025_09_19_0014_admin_bot_core.py`: колонку `company_payment` теперь не добавляем повторно, остаётся только `late_visit` и гео-поля.
- В `2025_09_19_0012_spec_indexes.py` после переименования `due_at` → `deadline_at` создаются индексы `ix_commissions__status_deadline`, `ix_commissions__master_status` и `ix_commissions__ispaid_deadline`.
- В `2025_09_19_0013_order_status_v12.py` перед созданием CHECK ограничение удаляется через `DROP CONSTRAINT IF EXISTS`, чтобы цепочка миграций была идемпотентной.
## 2025-09-20 — распределение v1.2
- В `field_service/services/distribution_worker.py` добавил маппинг категорий → навыки (CATEGORY_TO_SKILL_CODE), фильтр по `master_skills`, лог пропуска без категории и авто-блок гарантийного мастера при явном отказе.
- `process_one_order` теперь берёт категорию заказа и при отсутствии поддерживаемого `skill_code` эскалирует заказ логисту.
- В `services_db` и smoke-тестах прокинул `skill_code`, запросы подгружают `orders.category`, добавлена обработка, если категория не поддерживается.
- Гарантийные заявки: `candidate_rows` принимает `force_preferred_first`, а `process_one_order`/сервисы админа передают его только для GUARANTEE, поэтому прошлый мастер идёт первым лишь при выполнении фильтров и остаётся в логе `force_first`.
- Добавлены блокировки гарантийных мастеров при отказе (`autoblock_guarantee_declines`) и в тик обработчик подключен вместе с таймаутами.
