# P0-3: –û—Ç–º–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∑–∞–∫–∞–∑–∞ ‚Äî –ö–†–ê–¢–ö–ê–Ø –°–í–û–î–ö–ê

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ  
**–î–∞—Ç–∞**: 2025-10-08

---

## ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ò–∑–º–µ–Ω–µ–Ω—ã 2 —Ñ–∞–π–ª–∞

**`field_service/bots/master_bot/keyboards.py`**
```python
def close_order_cancel_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π –æ—Ç–º–µ–Ω—ã –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∑–∞–∫–∞–∑–∞."""
    return inline_keyboard([cancel_button(callback_data="m:act:cls:cancel")])
    #                                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ 
    #                                     –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π callback –≤–º–µ—Å—Ç–æ m:cancel
```

**`field_service/bots/master_bot/handlers/orders.py`**
```python
@router.callback_query(F.data == "m:act:cls:cancel")
async def active_close_cancel(
    callback: CallbackQuery,
    state: FSMContext,
    session: AsyncSession,
    master: m.masters,
) -> None:
    """P0-3: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã –ø—Ä–æ—Ü–µ—Å—Å–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∑–∞–∫–∞–∑–∞."""
    data = await state.get_data()
    order_id = data.get("close_order_id")
    
    await state.clear()
    await safe_answer_callback(callback, "‚ùå –ó–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–∫–∞–∑–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ")
    
    if order_id:
        await _render_active_order(callback, session, master, order_id=int(order_id))
    else:
        await _render_active_order(callback, session, master, order_id=None)
```

---

## üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### –ß–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞ (—Ä—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ):

```
1. –ó–∞–π—Ç–∏ –≤ –º–∞—Å—Ç–µ—Ä-–±–æ—Ç
2. –í–∑—è—Ç—å –∑–∞–∫–∞–∑ –≤ —Å—Ç–∞—Ç—É—Å–µ WORKING
3. –ù–∞–∂–∞—Ç—å "üèÅ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑"
4. –ë–æ—Ç: "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Ä–∞–±–æ—Ç:"
   [‚ùå –û—Ç–º–µ–Ω–∏—Ç—å]
5. –ù–∞–∂–∞—Ç—å [‚ùå –û—Ç–º–µ–Ω–∏—Ç—å]
6. ‚úÖ –û–∂–∏–¥–∞–µ—Ç—Å—è:
   - Alert: "‚ùå –ó–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–∫–∞–∑–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ"
   - –í–æ–∑–≤—Ä–∞—Ç –∫ –∫–∞—Ä—Ç–æ—á–∫–µ –∑–∞–∫–∞–∑–∞
   - –ö–Ω–æ–ø–∫–∏: [üèÅ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑] [‚Ü©Ô∏è –ù–∞–∑–∞–¥]
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–±–æ–∏—Ö —à–∞–≥–∞—Ö FSM:

**–®–∞–≥ 1 (amount):**
- "–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑" ‚Üí "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" ‚Üí [‚ùå –û—Ç–º–µ–Ω–∏—Ç—å] ‚Üí ‚úÖ –í–æ–∑–≤—Ä–∞—Ç –∫ –∫–∞—Ä—Ç–æ—á–∫–µ

**–®–∞–≥ 2 (act):**
- "–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑" ‚Üí "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" ‚Üí "5000" ‚Üí "–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞–∫—Ç" ‚Üí [‚ùå –û—Ç–º–µ–Ω–∏—Ç—å] ‚Üí ‚úÖ –í–æ–∑–≤—Ä–∞—Ç –∫ –∫–∞—Ä—Ç–æ—á–∫–µ

---

## üìù –ß–µ–∫–ª–∏—Å—Ç

- [x] –ö–æ–¥ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞
- [ ] –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ö–æ–º–º–∏—Ç –≤ git
- [ ] –î–µ–ø–ª–æ–π –Ω–∞ production

---

## üîó –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–°–º. —Ñ–∞–π–ª: `C:\ProjectF\docs\P0-3_CLOSE_ORDER_CANCEL.md`

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ –∑–∞–¥–∞—á–∏ P0

- **P0-2**: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ (—Å—Ä–µ–¥–Ω—è—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å)
- **P0-5**: –ë—ã—Å—Ç—Ä–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (—É–ø—Ä–æ—â–µ–Ω–∏–µ FSM, —Å—Ä–µ–¥–Ω—è—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å)
- **P0-6**: –í–æ–∑–≤—Ä–∞—Ç –ø–æ–∑–∏—Ü–∏–∏ –≤ —Å–ø–∏—Å–∫–µ –æ—á–µ—Ä–µ–¥–∏ (–ø—Ä–æ—Å—Ç–∞—è)
- **P0-7**: –°–≤—è–∑—å –∫–æ–º–∏—Å—Å–∏—è ‚Üî –∑–∞–∫–∞–∑ (–ø—Ä–æ—Å—Ç–∞—è)
