# –ü–õ–ê–ù –î–û–†–ê–ë–û–¢–ö–ò P0 (–ö–†–ò–¢–ò–ß–ù–´–ï –ó–ê–î–ê–ß–ò)

## –ò–°–ö–õ–Æ–ß–ï–ù–û –ò–ó –†–ê–ó–†–ê–ë–û–¢–ö–ò:
- ‚ùå –ì–µ–æ–∫–æ–¥–µ—Ä –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (lat/lon) - –∏—Å–∫–ª—é—á–µ–Ω—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É

---

## P0-1: –ú–û–î–ï–†–ê–¶–ò–Ø –ú–ê–°–¢–ï–†–û–í ‚úÖ

### –°–¢–ê–¢–£–°: –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞, —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã

### –ß–¢–û –†–ï–ê–õ–ò–ó–û–í–ê–ù–û:
- ‚úÖ UI: –ö–Ω–æ–ø–∫–∞ "üõ† –ú–æ–¥–µ—Ä–∞—Ü–∏—è" –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é
- ‚úÖ –†–æ—É—Ç–µ—Ä—ã: `admin_moderation.py`, `admin_masters.py`
- ‚úÖ –°–ø–∏—Å–æ–∫ –∞–Ω–∫–µ—Ç —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ (–≥—Ä—É–ø–ø—ã: –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏, –æ–¥–æ–±—Ä–µ–Ω–Ω—ã–µ, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
- ‚úÖ –ö–∞—Ä—Ç–æ—á–∫–∞ –º–∞—Å—Ç–µ—Ä–∞ —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
- ‚úÖ –ö–Ω–æ–ø–∫–∏ "‚úÖ –û–¥–æ–±—Ä–∏—Ç—å" / "‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å"
- ‚úÖ FSM –¥–ª—è –≤–≤–æ–¥–∞ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (1-200 —Å–∏–º–≤–æ–ª–æ–≤)

### –¢–†–ï–ë–£–ï–¢–°–Ø –î–û–†–ê–ë–û–¢–ö–ê:

**1. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –≤ `services_db.py` ‚Üí –∫–ª–∞—Å—Å `DBMastersService`:**

–§–∞–π–ª —Å –ø–∞—Ç—á–µ–º —Å–æ–∑–¥–∞–Ω: `field-service/PATCH_DBMastersService_moderation.py`

–ú–µ—Ç–æ–¥—ã –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:
- `approve_master(master_id, by_staff_id)` - –æ–¥–æ–±—Ä–µ–Ω–∏–µ –∞–Ω–∫–µ—Ç—ã
- `reject_master(master_id, reason, by_staff_id)` - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
- `block_master(master_id, reason, by_staff_id)` - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
- `unblock_master(master_id, by_staff_id)` - —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
- `set_master_limit(master_id, limit, by_staff_id)` - –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞
- `enqueue_master_notification(master_id, message)` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**2. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é –ø–∞—Ç—á–∞:**

```bash
# 1. –û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª
nano field-service/field_service/bots/admin_bot/services_db.py

# 2. –ù–∞–π—Ç–∏ –∫–æ–Ω–µ—Ü –∫–ª–∞—Å—Å–∞ DBMastersService (–ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º class –∏–ª–∏ EOF)

# 3. –í—Å—Ç–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –∏–∑ PATCH_DBMastersService_moderation.py
#    –í–∞–∂–Ω–æ: –æ—Ç—Å—Ç—É–ø—ã –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –¥—Ä—É–≥–∏–º–∏ –º–µ—Ç–æ–¥–∞–º–∏ –∫–ª–∞—Å—Å–∞ (4 –ø—Ä–æ–±–µ–ª–∞)

# 4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª
```

**–¢–†–£–î–û–ó–ê–¢–†–ê–¢–´:** 15 –º–∏–Ω—É—Ç

---

## P0-2: –í–ê–õ–ò–î–ê–¶–ò–Ø –¢–ï–õ–ï–§–û–ù–ê –ü–†–ò –û–ù–ë–û–†–î–ò–ù–ì–ï ‚ö†Ô∏è

### –ü–†–û–ë–õ–ï–ú–ê:
–í –º–∞—Å—Ç–µ—Ä-–±–æ—Ç–µ –ø—Ä–∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–µ —Ç–µ–ª–µ—Ñ–æ–Ω –ù–ï –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è:
- –ü–æ–ª–µ `phone` –≤ –ë–î nullable
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤–≤–æ–¥ –∏–ª–∏ –≤–≤–µ—Å—Ç–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç

### –†–ï–®–ï–ù–ò–ï:

**–§–∞–π–ª:** `field-service/field_service/bots/master_bot/handlers/onboarding.py`

**–ù–∞–π—Ç–∏:** –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ FSM –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞

**–î–æ–±–∞–≤–∏—Ç—å:**
```python
from field_service.services.onboarding_service import normalize_phone

@router.message(StateFilter(OnboardingFSM.phone))
async def onboarding_phone(msg: Message, state: FSMContext) -> None:
    raw_phone = (msg.text or "").strip()
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è
    try:
        normalized = normalize_phone(raw_phone)
    except ValueError:
        await msg.answer(
            "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞.\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: +79001234567 –∏–ª–∏ 89001234567"
        )
        return
    
    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω
    await state.update_data(phone=normalized)
    await state.set_state(OnboardingFSM.next_step)
    await msg.answer("‚úÖ –¢–µ–ª–µ—Ñ–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω.")
```

**–¢–†–£–î–û–ó–ê–¢–†–ê–¢–´:** 10 –º–∏–Ω—É—Ç

---

## P0-3: –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –ú–ê–°–¢–ï–†–£ –û –ë–õ–û–ö–ò–†–û–í–ö–ï ‚ö†Ô∏è

### –ü–†–û–ë–õ–ï–ú–ê:
–ü—Ä–∏ –ø—Ä–æ—Å—Ä–æ—á–∫–µ –∫–æ–º–∏—Å—Å–∏–∏ >3—á watchdog –±–ª–æ–∫–∏—Ä—É–µ—Ç –º–∞—Å—Ç–µ—Ä–∞, –Ω–æ –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.

### –†–ï–®–ï–ù–ò–ï:

**–§–∞–π–ª:** `field-service/field_service/services/watchdogs.py`

**–ù–∞–π—Ç–∏:** –§—É–Ω–∫—Ü–∏—é `watchdog_commissions_overdue`

**–ü–æ—Å–ª–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –º–∞—Å—Ç–µ—Ä–∞ –¥–æ–±–∞–≤–∏—Ç—å:**
```python
# –í –∫–æ–Ω—Ü–µ –±–ª–æ–∫–∞, –≥–¥–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –º–∞—Å—Ç–µ—Ä:
if blocked_master_id:
    try:
        master = await session.get(m.masters, blocked_master_id)
        if master and master.tg_user_id:
            await bot.send_message(
                master.tg_user_id,
                f"‚ö†Ô∏è <b>–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</b>\n\n"
                f"–ü—Ä–∏—á–∏–Ω–∞: –ü—Ä–æ—Å—Ä–æ—á–∫–∞ –æ–ø–ª–∞—Ç—ã –∫–æ–º–∏—Å—Å–∏–∏ #{commission_id}\n"
                f"–î–µ–¥–ª–∞–π–Ω –±—ã–ª: {deadline_local}\n\n"
                f"–î–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
            )
            live_log.push("watchdog", f"Sent block notification to master#{blocked_master_id}")
    except Exception as exc:
        logger.warning(f"Failed to notify master#{blocked_master_id}: {exc}")
```

**–¢–†–£–î–û–ó–ê–¢–†–ê–¢–´:** 10 –º–∏–Ω—É—Ç

---

## P0-4: –¢–ï–õ–ï–§–û–ù –ö–õ–ò–ï–ù–¢–ê –ü–†–ò ASSIGNED ‚ö†Ô∏è

### –ü–†–û–ë–õ–ï–ú–ê:
–¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ EN_ROUTE, –Ω–æ –¢–ó —Ç—Ä–µ–±—É–µ—Ç –ø–æ–∫–∞–∑ —Å—Ä–∞–∑—É –ø—Ä–∏ ASSIGNED.

### –†–ï–®–ï–ù–ò–ï:

**–§–∞–π–ª:** `field-service/field_service/bots/master_bot/handlers/orders.py`

**–ù–∞–π—Ç–∏:** –§—É–Ω–∫—Ü–∏—é `_render_active_order`

**–ò–∑–º–µ–Ω–∏—Ç—å —É—Å–ª–æ–≤–∏–µ:**
```python
# –ë–´–õ–û:
if order.status in ACTIVE_STATUSES or order.status == m.OrderStatus.PAYMENT:
    text_lines.append(f"üë§ –ö–ª–∏–µ–Ω—Ç: {escape_html(order.client_name or '‚Äî')}")
    text_lines.append(f"üìû –¢–µ–ª–µ—Ñ–æ–Ω: {escape_html(order.client_phone or '‚Äî')}")

# –°–¢–ê–õ–û:
if order.status in (
    m.OrderStatus.ASSIGNED,  # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
    m.OrderStatus.EN_ROUTE,
    m.OrderStatus.WORKING,
    m.OrderStatus.PAYMENT
):
    text_lines.append(f"üë§ –ö–ª–∏–µ–Ω—Ç: {escape_html(order.client_name or '‚Äî')}")
    text_lines.append(f"üìû –¢–µ–ª–µ—Ñ–æ–Ω: {escape_html(order.client_phone or '‚Äî')}")
```

**–¢–†–£–î–û–ó–ê–¢–†–ê–¢–´:** 5 –º–∏–Ω—É—Ç

---

## –û–ë–©–ò–ô –ü–õ–ê–ù –í–´–ü–û–õ–ù–ï–ù–ò–Ø:

### –®–∞–≥ 1: –ú–æ–¥–µ—Ä–∞—Ü–∏—è (15 –º–∏–Ω)
1. –û—Ç–∫—Ä—ã—Ç—å `services_db.py`
2. –ù–∞–π—Ç–∏ –∫–ª–∞—Å—Å `DBMastersService`
3. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –∏–∑ –ø–∞—Ç—á–∞ `PATCH_DBMastersService_moderation.py`
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å

### –®–∞–≥ 2: –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (10 –º–∏–Ω)
1. –û—Ç–∫—Ä—ã—Ç—å `field_service/bots/master_bot/handlers/onboarding.py`
2. –ù–∞–π—Ç–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `OnboardingFSM.phone`
3. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é —á–µ—Ä–µ–∑ `normalize_phone()`
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å

### –®–∞–≥ 3: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ (10 –º–∏–Ω)
1. –û—Ç–∫—Ä—ã—Ç—å `field_service/services/watchdogs.py`
2. –ù–∞–π—Ç–∏ `watchdog_commissions_overdue`
3. –î–æ–±–∞–≤–∏—Ç—å `bot.send_message()` –ø–æ—Å–ª–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å

### –®–∞–≥ 4: –¢–µ–ª–µ—Ñ–æ–Ω –ø—Ä–∏ ASSIGNED (5 –º–∏–Ω)
1. –û—Ç–∫—Ä—ã—Ç—å `field_service/bots/master_bot/handlers/orders.py`
2. –ù–∞–π—Ç–∏ `_render_active_order`
3. –î–æ–±–∞–≤–∏—Ç—å `m.OrderStatus.ASSIGNED` –≤ —É—Å–ª–æ–≤–∏–µ
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å

### –®–∞–≥ 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (15 –º–∏–Ω)
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±–∞ –±–æ—Ç–∞
python -m field_service.bots.admin_bot.main &
python -m field_service.bots.master_bot.main &

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
# 1. –ú–æ–¥–µ—Ä–∞—Ü–∏—é: /start ‚Üí "üõ† –ú–æ–¥–µ—Ä–∞—Ü–∏—è" ‚Üí –æ–¥–æ–±—Ä–∏—Ç—å/–æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É
# 2. –û–Ω–±–æ—Ä–¥–∏–Ω–≥: —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞, –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω
# 3. –ë–ª–æ–∫–∏—Ä–æ–≤–∫—É: —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—É—é –∫–æ–º–∏—Å—Å–∏—é, –∑–∞–ø—É—Å—Ç–∏—Ç—å watchdog
# 4. –¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞: –ø—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ ASSIGNED
```

---

## –ò–¢–û–ì–û: 55 –º–∏–Ω—É—Ç
- –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞: 40 –º–∏–Ω—É—Ç
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: 15 –º–∏–Ω—É—Ç

## –ö–†–ò–¢–ï–†–ò–ò –ü–†–ò–Å–ú–ö–ò:

- ‚úÖ P0-1: –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –æ–¥–æ–±—Ä—è—Ç—å/–æ—Ç–∫–ª–æ–Ω—è—Ç—å –∞–Ω–∫–µ—Ç—ã, –º–∞—Å—Ç–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- ‚úÖ P0-2: –ú–∞—Å—Ç–µ—Ä –Ω–µ –º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ –±–µ–∑ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
- ‚úÖ P0-3: –ü—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –∑–∞ –ø—Ä–æ—Å—Ä–æ—á–∫—É –º–∞—Å—Ç–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –±–æ—Ç
- ‚úÖ P0-4: –¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞ –≤–∏–¥–µ–Ω —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –≤–∑—è—Ç–∏—è –∑–∞–∫–∞–∑–∞ (ASSIGNED)

## –§–ê–ô–õ–´ –î–õ–Ø –ò–ó–ú–ï–ù–ï–ù–ò–Ø:

1. `field_service/bots/admin_bot/services_db.py` - –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –º–æ–¥–µ—Ä–∞—Ü–∏–∏
2. `field_service/bots/master_bot/handlers/onboarding.py` - –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
3. `field_service/services/watchdogs.py` - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ
4. `field_service/bots/master_bot/handlers/orders.py` - —Ç–µ–ª–µ—Ñ–æ–Ω –ø—Ä–∏ ASSIGNED

## BACKUP PLAN:

–ü–µ—Ä–µ–¥ –≤–Ω–µ—Å–µ–Ω–∏–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø:
```bash
cd field-service
git add -A
git commit -m "WIP: Before P0 fixes"
git branch backup-before-p0-fixes
```

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:
```bash
git add -A
git commit -m "feat: P0 critical fixes (moderation, phone validation, notifications)"
```
