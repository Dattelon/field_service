# P1-19: –ë—ã—Å—Ç—Ä–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ  
**–î–∞—Ç–∞:** 2025-10-09  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P1 (–í—ã—Å–æ–∫–∏–π)

---

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–ò–∑ –æ—Ç—á—ë—Ç–∞ UX Analysis:
> **–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–ª—å–∑—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω/–∞–¥—Ä–µ—Å –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º  
> **–†–µ—à–µ–Ω–∏–µ:** –°–¥–µ–ª–∞—Ç—å –ø–æ–ª—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º–∏ —Å –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º —á–µ—Ä–µ–∑ callback buttons

---

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. **–û–±—â–∏–π –º–æ–¥—É–ª—å –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è**
–§–∞–π–ª: `field_service/bots/common/copy_utils.py`

```python
def copy_button(text: str, order_id: int, data_type: str, bot_prefix: str)
    """–°–æ–∑–¥–∞—ë—Ç –∫–Ω–æ–ø–∫—É –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞"""

def format_copy_message(data_type: str, data: str)
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è"""
```

**–¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö:**
- `cph` - client_phone (—Ç–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞)
- `mph` - master_phone (—Ç–µ–ª–µ—Ñ–æ–Ω –º–∞—Å—Ç–µ—Ä–∞)  
- `addr` - address (–ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å)

**–§–æ—Ä–º–∞—Ç callback:** `{bot_prefix}:copy:{data_type}:{order_id}`
- –ü—Ä–∏–º–µ—Ä—ã: `m:copy:cph:123`, `adm:copy:addr:456`

---

### 2. **Master Bot: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∞–∫—Ç–∏–≤–Ω–æ–º –∑–∞–∫–∞–∑–µ**

#### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `field_service/bots/master_bot/handlers/orders.py`

#### –î–æ–±–∞–≤–ª–µ–Ω–æ:
1. **Handler:** `@router.callback_query(F.data.regexp(r"^m:copy:(cph|addr):(\d+)$"))`
2. **–ö–Ω–æ–ø–∫–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞:**
   - üìã –¢–µ–ª–µ—Ñ–æ–Ω (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
   - üìã –ê–¥—Ä–µ—Å (–≤—Å–µ–≥–¥–∞)

#### –ì–¥–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∫–Ω–æ–ø–∫–∏:
- –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã (ASSIGNED, EN_ROUTE, WORKING, PAYMENT)
- –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –ø–æ–¥ –∫–Ω–æ–ø–∫–æ–π "üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É"

```python
# P1-19: –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
if order.status in ACTIVE_STATUSES or order.status == m.OrderStatus.PAYMENT:
    copy_row: list[InlineKeyboardButton] = []
    if order.client_phone:
        copy_row.append(copy_button("üìã –¢–µ–ª–µ—Ñ–æ–Ω", order.id, "cph", "m"))
    copy_row.append(copy_button("üìã –ê–¥—Ä–µ—Å", order.id, "addr", "m"))
    if copy_row:
        keyboard_rows.append(copy_row)
```

---

### 3. **Admin Bot: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –∑–∞–∫–∞–∑–∞**

#### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `field_service/bots/admin_bot/ui/keyboards/orders.py`
- `field_service/bots/admin_bot/handlers/orders/copy_data.py` (–Ω–æ–≤—ã–π)
- `field_service/bots/admin_bot/handlers/orders/__init__.py`

#### –î–æ–±–∞–≤–ª–µ–Ω–æ:
1. **Handler:** `copy_router` —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ (GLOBAL_ADMIN, CITY_ADMIN, LOGIST)
2. **–ö–Ω–æ–ø–∫–∏ –≤ `order_card_keyboard`:**
   - üìã –¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞
   - üìã –¢–µ–ª–µ—Ñ–æ–Ω –º–∞—Å—Ç–µ—Ä–∞
   - üìã –ê–¥—Ä–µ—Å

#### –ì–¥–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∫–Ω–æ–ø–∫–∏:
- –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–∫–∞–∑–∞ –≤ –æ—á–µ—Ä–µ–¥–∏ (`adm:q:card:{order_id}:{page}`)
- –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ (3 –∫–Ω–æ–ø–∫–∏ –≤ —Ä—è–¥) –ø–µ—Ä–µ–¥ –∫–Ω–æ–ø–∫–∞–º–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏

```python
# P1-19: –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
copy_row = InlineKeyboardBuilder()
copy_row.add(copy_button("üìã –¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞", order_id, "cph", "adm"))
copy_row.add(copy_button("üìã –¢–µ–ª–µ—Ñ–æ–Ω –º–∞—Å—Ç–µ—Ä–∞", order_id, "mph", "adm"))
copy_row.add(copy_button("üìã –ê–¥—Ä–µ—Å", order_id, "addr", "adm"))
copy_row.adjust(3)  # –¢—Ä–∏ –∫–Ω–æ–ø–∫–∏ –≤ —Ä—è–¥
kb.attach(copy_row)
```

---

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è**
–ù–∞–ø—Ä–∏–º–µ—Ä: `üìã –¢–µ–ª–µ—Ñ–æ–Ω` ‚Üí callback `m:copy:cph:123`

### 2. **Handler –∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î**
```python
stmt = (
    select(
        m.orders.id,
        m.orders.client_phone,
        m.orders.house,
        m.cities.name.label("city"),
        m.districts.name.label("district"),
        m.streets.name.label("street"),
    )
    .join(m.cities, m.cities.id == m.orders.city_id)
    .outerjoin(m.districts, m.districts.id == m.orders.district_id)
    .outerjoin(m.streets, m.streets.id == m.orders.street_id)
    .where(m.orders.id == order_id)
)
```

### 3. **–û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Telegram Alert**
```python
await safe_answer_callback(callback, data, show_alert=True)
```

Telegram –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç alert —Å –¥–∞–Ω–Ω—ã–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ:
- –ü—Ä–æ—á–∏—Ç–∞—Ç—å
- –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–ª–∏–Ω–Ω—ã–º –Ω–∞–∂–∞—Ç–∏–µ–º (–º–æ–±–∏–ª–∫–∞)
- –í—ã–¥–µ–ª–∏—Ç—å –∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å (–¥–µ—Å–∫—Ç–æ–ø)

---

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- Callback —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ ID –∑–∞–∫–∞–∑–∞, –Ω–µ —Å–∞–º–∏ –¥–∞–Ω–Ω—ã–µ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 64 –±–∞–π—Ç–∞)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –≤ admin_bot
- –ú–∞—Å—Ç–µ—Ä –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞–∫–∞–∑—ã (–ø—Ä–æ–≤–µ—Ä–∫–∞ `assigned_master_id`)

### ‚úÖ **UX:**
- –û–¥–∏–Ω –∫–ª–∏–∫ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
- –î–∞–Ω–Ω—ã–µ –≤—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ (–∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ –ë–î)
- –ü–æ–Ω—è—Ç–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ üìã
- Alert —Å –±–æ–ª—å—à–∏–º —Ç–µ–∫—Å—Ç–æ–º —É–¥–æ–±–Ω–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å

### ‚úÖ **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å:**
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞)
- –ï–¥–∏–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è –æ–±–æ–∏—Ö –±–æ—Ç–æ–≤
- –ì–æ—Ç–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –±—É–¥—É—â–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π

---

## üìä –ü–æ–∫—Ä—ã—Ç–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

| –ë–æ—Ç | –ß—Ç–æ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è | –ì–¥–µ –¥–æ—Å—Ç—É–ø–Ω–æ |
|-----|---------------|--------------|
| Master | –¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞ | –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã |
| Master | –ê–¥—Ä–µ—Å | –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã |
| Admin | –¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞ | –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–∫–∞–∑–∞ |
| Admin | –¢–µ–ª–µ—Ñ–æ–Ω –º–∞—Å—Ç–µ—Ä–∞ | –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–∫–∞–∑–∞ |
| Admin | –ê–¥—Ä–µ—Å | –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–∫–∞–∑–∞ |

---

## üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### Master Bot:
1. –ù–∞—á–∞—Ç—å —Å–º–µ–Ω—É
2. –ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑
3. –û—Ç–∫—Ä—ã—Ç—å "üì¶ –ê–∫—Ç–∏–≤–Ω—ã–π –∑–∞–∫–∞–∑"
4. –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫–∏:
   - üìã –¢–µ–ª–µ—Ñ–æ–Ω ‚Üí –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å alert —Å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º –∫–ª–∏–µ–Ω—Ç–∞
   - üìã –ê–¥—Ä–µ—Å ‚Üí –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å alert —Å –ø–æ–ª–Ω—ã–º –∞–¥—Ä–µ—Å–æ–º

### Admin Bot:
1. –û—Ç–∫—Ä—ã—Ç—å "üìã –û—á–µ—Ä–µ–¥—å –∑–∞—è–≤–æ–∫"
2. –í—ã–±—Ä–∞—Ç—å –ª—é–±–æ–π –∑–∞–∫–∞–∑
3. –í –∫–∞—Ä—Ç–æ—á–∫–µ –∑–∞–∫–∞–∑–∞ –Ω–∞–∂–∞—Ç—å:
   - üìã –¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞ ‚Üí alert —Å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º
   - üìã –¢–µ–ª–µ—Ñ–æ–Ω –º–∞—Å—Ç–µ—Ä–∞ ‚Üí alert —Å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º –º–∞—Å—Ç–µ—Ä–∞ (–µ—Å–ª–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω)
   - üìã –ê–¥—Ä–µ—Å ‚Üí alert —Å –∞–¥—Ä–µ—Å–æ–º

### –ü—Ä–æ–≤–µ—Ä–∫–∞ edge cases:
- –ó–∞–∫–∞–∑ –±–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ ‚Üí "‚ùå –¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω"
- –ó–∞–∫–∞–∑ –±–µ–∑ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞ ‚Üí "‚ùå –ú–∞—Å—Ç–µ—Ä –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω"
- –ü–æ–ø—ã—Ç–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —á—É–∂–æ–π –∑–∞–∫–∞–∑ (master) ‚Üí "–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω"

---

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ö–∞–∂–¥–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è:

**Master Bot:**
```python
_log.info("copy_data: uid=%s order_id=%s type=%s", callback_uid, order_id, data_type)
```

**Admin Bot:**
```python
_log.info("copy_data: staff_id=%s order_id=%s type=%s", staff.staff_id, order_id, data_type)
```

---

## üîÆ –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–±—É–¥—É—â–µ–µ)

1. **–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞** - –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –æ–ø–∏—Å–∞–Ω–∏–π
2. **–ò—Å—Ç–æ—Ä–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–π** - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
3. **–ì—Ä—É–ø–ø–æ–≤–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë —Å—Ä–∞–∑—É
4. **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–∞** - —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã (–∫–æ—Ä–æ—Ç–∫–∏–π/–ø–æ–ª–Ω—ã–π)
5. **–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä –Ω–∞–ø—Ä—è–º—É—é** - —á–µ—Ä–µ–∑ Web App API (—Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

- [x] –°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å `copy_utils.py`
- [x] –î–æ–±–∞–≤–ª–µ–Ω handler –≤ master_bot
- [x] –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–Ω–æ–ø–∫–∏ –≤ master_bot –∫–∞—Ä—Ç–æ—á–∫—É
- [x] –°–æ–∑–¥–∞–Ω handler –≤ admin_bot
- [x] –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–Ω–æ–ø–∫–∏ –≤ admin_bot –∫–∞—Ä—Ç–æ—á–∫—É
- [x] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω router –≤ admin_bot
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö
- [ ] –°–æ–±—Ä–∞—Ç—å feedback –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

**–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!** üöÄ
