# ‚úÖ P2-11: –ú–ê–°–°–û–í–û–ï –û–î–û–ë–†–ï–ù–ò–ï –ö–û–ú–ò–°–°–ò–ô - –ó–ê–í–ï–†–®–ï–ù–û

## üìã –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. **–ö–ª–∞—Å—Å `DBFinanceService`** (services_db.py)
- –ú–µ—Ç–æ–¥ `bulk_approve_commissions(start_date, end_date, by_staff_id, city_ids)`
- RBAC —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≥–æ—Ä–æ–¥–∞–º
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–π –∫–æ–º–∏—Å—Å–∏–∏ —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π `with_for_update()`
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–π —á–µ—Ä–µ–∑ `apply_rewards_for_commission`
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `(–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö, —Å–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫)`

---

### 2. **FSM —Å–æ—Å—Ç–æ—è–Ω–∏–µ** (states.py)
```python
class FinanceActionFSM(StatesGroup):
    bulk_approve_period = State()  # –î–ª—è –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞
```

---

### 3. **–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏** (handlers_finance.py)

#### 3.1. `on_finance_bulk_approve_start` (callback: `adm:f:bulk`)
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞:
  - "üìÖ –ó–∞ —Å–µ–≥–æ–¥–Ω—è" (1 –¥–µ–Ω—å)
  - "üìÖ –ó–∞ 3 –¥–Ω—è"
  - "üìÖ –ó–∞ –Ω–µ–¥–µ–ª—é" (7 –¥–Ω–µ–π)
  - "‚ùå –û—Ç–º–µ–Ω–∞"

#### 3.2. `on_finance_bulk_approve_confirm` (callback: `adm:f:bulk:(\d+)`)
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –¥–µ–π—Å—Ç–≤–∏—è
- –ö–Ω–æ–ø–∫–∏: "‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å" / "‚ùå –û—Ç–º–µ–Ω–∞"

#### 3.3. `on_finance_bulk_approve_execute` (callback: `adm:f:bulk:exec:(\d+)`)
- –í—ã—á–∏—Å–ª—è–µ—Ç `start_date` –∏ `end_date` –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
- –í—ã–∑—ã–≤–∞–µ—Ç `finance_service.bulk_approve_commissions(...)`
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö –∏ –æ—à–∏–±–æ–∫
- –õ–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫–∏ —á–µ—Ä–µ–∑ `live_log.push("finance", ...)`
- –ö–Ω–æ–ø–∫–∞ "üîô –ö —Ñ–∏–Ω–∞–Ω—Å–∞–º"

---

### 4. **–ö–Ω–æ–ø–∫–∞ –≤ –º–µ–Ω—é —Ñ–∏–Ω–∞–Ω—Å–æ–≤** (keyboards.py)
```python
def finance_menu(staff: StaffUser) -> InlineKeyboardMarkup:
    if staff.role is StaffRole.GLOBAL_ADMIN:
        kb.button(text="‚ö° –û–¥–æ–±—Ä–∏—Ç—å –≤—Å–µ", callback_data="adm:f:bulk")
```
**–î–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è `GLOBAL_ADMIN`**

---

## üìÅ –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. ‚úÖ `field_service/bots/admin_bot/services_db.py`
   - –î–æ–±–∞–≤–ª–µ–Ω –∫–ª–∞—Å—Å `DBFinanceService` —Å –º–µ—Ç–æ–¥–æ–º `bulk_approve_commissions`
   
2. ‚úÖ `field_service/bots/admin_bot/states.py`
   - –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ `FinanceActionFSM.bulk_approve_period`
   
3. ‚úÖ `field_service/bots/admin_bot/handlers_finance.py`
   - 3 –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞: start ‚Üí confirm ‚Üí execute
   - –ò–º–ø–æ—Ä—Ç—ã: `date`, `timedelta`, `html`
   
4. ‚úÖ `field_service/bots/admin_bot/keyboards.py`
   - –ö–Ω–æ–ø–∫–∞ "‚ö° –û–¥–æ–±—Ä–∏—Ç—å –≤—Å–µ" –≤ `finance_menu()`

---

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏

### ‚úÖ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
- [x] –ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç –∫–Ω–æ–ø–∫—É "‚ö° –û–¥–æ–±—Ä–∏—Ç—å –≤—Å–µ" –≤ –º–µ–Ω—é —Ñ–∏–Ω–∞–Ω—Å–æ–≤
- [x] –í—ã–±–∏—Ä–∞–µ—Ç –ø–µ—Ä–∏–æ–¥: —Å–µ–≥–æ–¥–Ω—è / 3 –¥–Ω—è / –Ω–µ–¥–µ–ª—è
- [x] –í–∏–¥–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –¥–µ–π—Å—Ç–≤–∏—è
- [x] –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—Å–µ –∫–æ–º–∏—Å—Å–∏–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥ –æ–¥–æ–±—Ä—è—é—Ç—Å—è
- [x] –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç: "‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ: N"
- [x] –ï—Å–ª–∏ –æ—à–∏–±–∫–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è "‚ö†Ô∏è –û—à–∏–±–æ–∫: M"
- [x] RBAC —Ä–∞–±–æ—Ç–∞–µ—Ç: –≥–æ—Ä–æ–¥—Å–∫–∏–µ –∞–¥–º–∏–Ω—ã –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –≥–æ—Ä–æ–¥–∞

### ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- [x] –î–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ `GLOBAL_ADMIN`
- [x] –î–≤–æ–π–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (–≤—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ)
- [x] –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ `with_for_update()` –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–∞–∂–¥–æ–π –∫–æ–º–∏—Å—Å–∏–∏
- [x] –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ `async with session.begin()`

### ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [x] –û—à–∏–±–∫–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ —Å–ø–∏—Å–æ–∫ `errors`
- [x] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `logger.exception(...)`
- [x] –û–±—â–∏–µ –æ—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ `live_log.push("finance", ...)`

---

## üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
```bash
# –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–æ–º–∏—Å—Å–∏–∏ –≤ —Å—Ç–∞—Ç—É—Å–µ WAIT_PAY –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
```

### 2. –¢–µ—Å—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ–ª–æ—É
1. –û—Ç–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω-–±–æ—Ç–∞
2. –ù–∞–∂–∞—Ç—å "üí∞ –§–∏–Ω–∞–Ω—Å—ã"
3. –ù–∞–∂–∞—Ç—å "‚ö° –û–¥–æ–±—Ä–∏—Ç—å –≤—Å–µ"
4. –í—ã–±—Ä–∞—Ç—å "üìÖ –ó–∞ –Ω–µ–¥–µ–ª—é"
5. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ
6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è "‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ: N"

### 3. –¢–µ—Å—Ç RBAC
1. –í–æ–π—Ç–∏ –∫–∞–∫ `CITY_ADMIN` (–Ω–µ `GLOBAL_ADMIN`)
2. –û—Ç–∫—Ä—ã—Ç—å "üí∞ –§–∏–Ω–∞–Ω—Å—ã"
3. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –∫–Ω–æ–ø–∫–∞ "‚ö° –û–¥–æ–±—Ä–∏—Ç—å –≤—Å–µ" **–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç**

### 4. –¢–µ—Å—Ç –æ—à–∏–±–æ–∫
1. –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–º–∏—Å—Å–∏–∏ –Ω–∞ `PAID` –≤—Ä—É—á–Ω—É—é –≤ –ë–î
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∞—Å—Å–æ–≤–æ–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ –∑–∞ –ø–µ—Ä–∏–æ–¥ —Å —ç—Ç–æ–π –∫–æ–º–∏—Å—Å–∏–µ–π
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è "‚ö†Ô∏è –û—à–∏–±–æ–∫: 1"

---

## üìä SQL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–¥–æ–±—Ä–µ–Ω–Ω—ã–µ –∫–æ–º–∏—Å—Å–∏–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
SELECT 
    id, 
    order_id, 
    master_id, 
    status, 
    approved_by_staff_id, 
    approved_at
FROM commissions
WHERE status = 'PAID'
  AND approved_at >= NOW() - INTERVAL '1 hour'
ORDER BY approved_at DESC;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
SELECT 
    r.id, 
    r.commission_id, 
    r.recipient_master_id, 
    r.level, 
    r.amount, 
    r.created_at
FROM referral_rewards r
JOIN commissions c ON r.commission_id = c.id
WHERE c.approved_at >= NOW() - INTERVAL '1 hour'
ORDER BY r.created_at DESC;
```

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ó–∞–¥–∞—á–∞ **P2-11 –∑–∞–≤–µ—Ä—à–µ–Ω–∞**. –ú–æ–∂–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–¥–∞—á–µ –∏–∑ —Å–ø–∏—Å–∫–∞:

- **P2-12:** Scheduled reports (–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –æ—Ç—á—ë—Ç–æ–≤)
- **P2-08:** –†–∞–∑–±–∏—Ç—å `handlers.py` –Ω–∞ –º–æ–¥—É–ª–∏
- **P2-09:** –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ `queue.py` FSM states
- **P2-10:** Repository pattern –¥–ª—è `services_db.py`

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –ö–∞–∂–¥–∞—è –∫–æ–º–∏—Å—Å–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å `with_for_update()`. –î–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–æ–≤ (>100 –∫–æ–º–∏—Å—Å–∏–π) –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–æ, –Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ.

2. **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥:** –î–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å bulk update:
   ```python
   await session.execute(
       update(m.commissions)
       .where(m.commissions.id.in_(commission_ids))
       .values(status=m.CommissionStatus.PAID, approved_at=now)
   )
   ```
   –ù–æ —ç—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏ –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π.

3. **–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞:**
   - –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "üìÖ –í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É –≤—Ä—É—á–Ω—É—é"
   - –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–∫–∞–∑–æ–≤
   - –î–æ–±–∞–≤–∏—Ç—å preview: "–ë—É–¥–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–æ N –∫–æ–º–∏—Å—Å–∏–π –Ω–∞ —Å—É–º–º—É X‚ÇΩ"

---

‚úÖ **–ó–ê–î–ê–ß–ê –í–´–ü–û–õ–ù–ï–ù–ê** 
‚è±Ô∏è **–í—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:** ~45 –º–∏–Ω—É—Ç
