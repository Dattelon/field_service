üéØ –ü–û–®–ê–ì–û–í–´–ô –ü–õ–ê–ù –î–û–†–ê–ë–û–¢–ö–ò –ü–†–û–ï–ö–¢–ê FIELD SERVICE
–ò—Å—Ö–æ–¥—è –∏–∑ –∞–Ω–∞–ª–∏–∑–∞, —Å–æ—Å—Ç–∞–≤–∏–ª –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Å —É—á—ë—Ç–æ–º –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏ –ø—Ä–æ–±–ª–µ–º.

üìã –≠–¢–ê–ü 1: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø (–ë–õ–û–ö–ï–†–´)
–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: üî¥ –í–´–°–û–ö–ò–ô | –í—Ä–µ–º—è: 2-3 —á–∞—Å–∞
–®–∞–≥ 1.1: –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ Race Condition –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –æ—Ñ—Ñ–µ—Ä–æ–≤
–§–∞–π–ª: master_bot/handlers/orders.py ‚Üí —Ñ—É–Ω–∫—Ü–∏—è offer_accept()
–ó–∞–¥–∞—á–∞:

–î–æ–±–∞–≤–∏—Ç—å FOR UPDATE SKIP LOCKED –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∑–∞–∫–∞–∑–∞
–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –¥–≤–æ–π–Ω–æ–µ –ø—Ä–∏–Ω—è—Ç–∏–µ –æ—Ñ—Ñ–µ—Ä–∞ —Ä–∞–∑–Ω—ã–º–∏ –º–∞—Å—Ç–µ—Ä–∞–º–∏

–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:

–ß–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–¥ offer_accept()
–ù–∞—Ö–æ–¥–∏–º –º–µ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
–î–æ–±–∞–≤–ª—è–µ–º .with_for_update(skip_locked=True)
–î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ –∑–∞–∫–∞–∑ —É–∂–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
–¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö


–®–∞–≥ 1.2: –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–∏—è –æ—Ñ—Ñ–µ—Ä–æ–≤ –¥–ª—è DEFERRED –∑–∞–∫–∞–∑–æ–≤
–§–∞–π–ª: master_bot/handlers/orders.py ‚Üí —Ñ—É–Ω–∫—Ü–∏—è offer_accept()
–ó–∞–¥–∞—á–∞:

–£–±—Ä–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø—Ä–∏–Ω—è—Ç–∏—è –æ—Ñ—Ñ–µ—Ä–æ–≤ –¥–ª—è DEFERRED —Å—Ç–∞—Ç—É—Å–∞
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å DEFERRED ‚Üí ASSIGNED –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏
–û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –≤ _fetch_orders_for_distribution

–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:

–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É if current_status == m.OrderStatus.DEFERRED: return
–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥–∞ DEFERRED ‚Üí ASSIGNED
–û–±–Ω–æ–≤–∏—Ç—å SQL –≤ distribution_scheduler.py –¥–ª—è —É—á—ë—Ç–∞ DEFERRED —Å –æ—Ñ—Ñ–µ—Ä–∞–º–∏
–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ —Å—Ç–∞—Ç—É—Å–æ–≤


–®–∞–≥ 1.3: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
–§–∞–π–ª: distribution_scheduler.py ‚Üí —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
–§–∞–π–ª: candidates.py ‚Üí SQL –∑–∞–ø—Ä–æ—Å –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
–ó–∞–¥–∞—á–∞:

–ü—Ä–æ–≤–µ—Ä—è—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å preferred –º–∞—Å—Ç–µ—Ä–∞ –ø–µ—Ä–µ–¥ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–µ–π
–ù–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑, –µ—Å–ª–∏ preferred –º–∞—Å—Ç–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:

–ò–∑—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –ª–æ–≥–∏–∫—É –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏ –≤ candidates.py
–î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é preferred –º–∞—Å—Ç–µ—Ä–∞ –ø–æ:

–ê–∫—Ç–∏–≤–Ω–∞—è —Å–º–µ–Ω–∞
–ù–µ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–∫–∞–∑–æ–≤
–ù–µ –Ω–∞ –ø–µ—Ä–µ—Ä—ã–≤–µ


–ï—Å–ª–∏ preferred –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –∏—Å–∫–∞—Ç—å —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏—á–∏–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ preferred –º–∞—Å—Ç–µ—Ä–∞


–®–∞–≥ 1.4: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —ç—Å–∫–∞–ª–∞—Ü–∏–∏
–§–∞–π–ª: distribution_scheduler.py ‚Üí —Ñ—É–Ω–∫—Ü–∏—è tick_once()
–ó–∞–¥–∞—á–∞:

–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —ç—Å–∫–∞–ª–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –û–î–ò–ù —Ä–∞–∑
–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:

–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ escalation_notified_at –≤ –º–æ–¥–µ–ª—å Order (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ)
–ü—Ä–æ–≤–µ—Ä—è—Ç—å: if escalated_logist_at and not escalation_notified_at
–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è - –æ–±–Ω–æ–≤–ª—è—Ç—å —Ñ–ª–∞–≥
–î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω—É—é –ª–æ–≥–∏–∫—É –¥–ª—è —ç—Å–∫–∞–ª–∞—Ü–∏–π –∫ –∞–¥–º–∏–Ω—É


üìã –≠–¢–ê–ü 2: –õ–û–ì–ò–ß–ï–°–ö–ò–ï –£–õ–£–ß–®–ï–ù–ò–Ø
–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: üü° –°–†–ï–î–ù–ò–ô | –í—Ä–µ–º—è: 3-4 —á–∞—Å–∞
–®–∞–≥ 2.1: –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤ –≤ –æ—á–µ—Ä–µ–¥–∏
–§–∞–π–ª: distribution_scheduler.py ‚Üí —Ñ—É–Ω–∫—Ü–∏—è _fetch_orders_for_distribution
–ó–∞–¥–∞—á–∞:

–ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–µ –∑–∞–∫–∞–∑—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–µ—Ä–≤—ã–º–∏
–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã –∏–º–µ—é—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ —ç—Å–∫–∞–ª–∞—Ü–∏–∏ - –≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:

–ò–∑–º–µ–Ω–∏—Ç—å ORDER BY –≤ SQL –∑–∞–ø—Ä–æ—Å–µ
–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –ø–æ:

–¢–∏–ø –∑–∞–∫–∞–∑–∞ (GUARANTEE)
–ü—Ä–æ—Å—Ä–æ—á–µ–Ω –ª–∏ —Å–ª–æ—Ç (timeslot_start_utc < NOW())
–ï—Å—Ç—å –ª–∏ —ç—Å–∫–∞–ª–∞—Ü–∏—è –∫ –∞–¥–º–∏–Ω—É
–í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è


–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö


–®–∞–≥ 2.2: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –±–µ–∑ —Ä–∞–π–æ–Ω–∞
–§–∞–π–ª: distribution_scheduler.py ‚Üí –ª–æ–≥–∏–∫–∞ —ç—Å–∫–∞–ª–∞—Ü–∏–∏
–§–∞–π–ª: candidates.py ‚Üí –ø–æ–∏—Å–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
–ó–∞–¥–∞—á–∞:

–ù–µ —ç—Å–∫–∞–ª–∏—Ä–æ–≤–∞—Ç—å —Å—Ä–∞–∑—É, –µ—Å–ª–∏ –Ω–µ—Ç —Ä–∞–π–æ–Ω–∞
–ò—Å–∫–∞—Ç—å –º–∞—Å—Ç–µ—Ä–æ–≤ –ø–æ –≥–æ—Ä–æ–¥—É
–≠—Å–∫–∞–ª–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –≤–æ–æ–±—â–µ

–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:

–£–±—Ä–∞—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—É—é —ç—Å–∫–∞–ª–∞—Ü–∏—é –ø—Ä–∏ district_id IS NULL
–î–æ–±–∞–≤–∏—Ç—å fallback –Ω–∞ –ø–æ–∏—Å–∫ –ø–æ –≥–æ—Ä–æ–¥—É –±–µ–∑ —Ä–∞–π–æ–Ω–∞
–≠—Å–∫–∞–ª–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ len(candidates) == 0
–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏–π


–®–∞–≥ 2.3: –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø–æ—Å–ª–µ —Ç–∞–π–º–∞—É—Ç–∞ –æ—Ñ—Ñ–µ—Ä–∞
–§–∞–π–ª: distribution_scheduler.py ‚Üí –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤
–ó–∞–¥–∞—á–∞:

–ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è –æ—Ñ—Ñ–µ—Ä–∞ —Å—Ä–∞–∑—É –Ω–∞—á–∏–Ω–∞—Ç—å –Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥
–ù–µ –∂–¥–∞—Ç—å —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç–∏–∫–∞ (30 —Å–µ–∫)

–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:

–ü–æ—Å–ª–µ _expire_overdue_offer() –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
–ï—Å–ª–∏ –æ—Ñ—Ñ–µ—Ä –∏—Å—Ç—ë–∫ - –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
–ò–ª–∏ —É–º–µ–Ω—å—à–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª —Ç–∏–∫–∞ —Å 30 –¥–æ 15 —Å–µ–∫—É–Ω–¥
–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –º–µ–∂–¥—É —Ä–∞—É–Ω–¥–∞–º–∏


üìã –≠–¢–ê–ü 3: –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò –ò –£–õ–£–ß–®–ï–ù–ò–Ø
–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: üü¢ –ù–ò–ó–ö–ò–ô | –í—Ä–µ–º—è: 3-4 —á–∞—Å–∞
–®–∞–≥ 3.1: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
–§–∞–π–ª: distribution_scheduler.py ‚Üí —Ñ—É–Ω–∫—Ü–∏—è _load_config()
–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:

–î–æ–±–∞–≤–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à —Å TTL (5 –º–∏–Ω—É—Ç)
–ó–∞–≥—Ä—É–∂–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥ –∏–∑ –ë–î —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –∫—ç—à–∞
–°–Ω–∏–∑–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –ë–î


–®–∞–≥ 3.2: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è SQL –≤ candidates
–§–∞–π–ª: candidates.py ‚Üí SQL –∑–∞–ø—Ä–æ—Å
–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:

–£–±—Ä–∞—Ç—å RANDOM() –∏–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (–º–µ–¥–ª–µ–Ω–Ω–æ)
–ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
–°–ª—É—á–∞–π–Ω–æ—Å—Ç—å –¥–µ–ª–∞—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ Python


–®–∞–≥ 3.3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è wakeup –º–µ—Ö–∞–Ω–∏–∑–º–∞
–§–∞–π–ª: services/distribution/wakeup.py
–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:

–ò—Å–ø—Ä–∞–≤–∏—Ç—å N+1 –∑–∞–ø—Ä–æ—Å –¥–ª—è —Ç–∞–π–º–∑–æ–Ω
–ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞—Ç—å –≤—Å–µ —Ç–∞–π–º–∑–æ–Ω—ã –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–æ–≤–∞—Ä—å –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞


üìã –≠–¢–ê–ü 4: –ú–û–ù–ò–¢–û–†–ò–ù–ì –ò –ê–ù–ê–õ–ò–¢–ò–ö–ê
–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: üü¢ –ù–ò–ó–ö–ò–ô | –í—Ä–µ–º—è: 2-3 —á–∞—Å–∞
–®–∞–≥ 4.1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:

–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É distribution_metrics –≤ –ë–î
–ó–∞–ø–∏—Å—ã–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞
–î–æ–±–∞–≤–∏—Ç—å –¥–∞—à–±–æ—Ä–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞


–®–∞–≥ 4.2: –£–ª—É—á—à–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:

–î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏—á–∏–Ω –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –º–∞—Å—Ç–µ—Ä–æ–≤
–õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π —ç—Ç–∞–ø —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ (JSON)



1.1, 1.2, 1.3, 1.4 - —Å–¥–µ–ª–∞–Ω—ã –∏ e2e —Ç–µ—Å—Ç—ã –∫ –Ω–∏–º —Ç–æ–∂–µ.

–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã:
‚úÖ 2.1: –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤ –≤ –æ—á–µ—Ä–µ–¥–∏
–§–∞–π–ª: distribution_scheduler.py ‚Üí _fetch_orders_for_distribution
sqlORDER BY
  (o.dist_escalated_admin_at IS NOT NULL) DESC,      -- 1. –≠—Å–∫–∞–ª–∞—Ü–∏—è –∫ –∞–¥–º–∏–Ω—É
  (o.type = 'GUARANTEE' OR o.status = 'GUARANTEE') DESC,  -- 2. –ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–µ
  (o.timeslot_start_utc IS NOT NULL AND o.timeslot_start_utc < NOW()) DESC,  -- 3. –ü—Ä–æ—Å—Ä–æ—á–µ–Ω
  (o.dist_escalated_logist_at IS NOT NULL) DESC,     -- 4. –≠—Å–∫–∞–ª–∞—Ü–∏—è –∫ –ª–æ–≥–∏—Å—Ç—É
  o.created_at ASC                                     -- 5. Oldest first
‚úÖ 2.2: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –±–µ–∑ —Ä–∞–π–æ–Ω–∞ (fallback –Ω–∞ –≥–æ—Ä–æ–¥)
–§–∞–π–ª—ã: distribution_scheduler.py ‚Üí _candidates, _tick_once_impl
–ò–∑–º–µ–Ω–µ–Ω–∏—è:

–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ _candidates() –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ district_id = None
–ü—Ä–∏ district_id IS NULL: LEFT JOIN master_districts (–ø–æ–∏—Å–∫ –ø–æ –≥–æ—Ä–æ–¥—É)
–ü—Ä–∏ district_id –∑–∞–¥–∞–Ω: JOIN master_districts (—Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç —Ä–∞–π–æ–Ω)
–≠—Å–∫–∞–ª–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –≤–æ–æ–±—â–µ (–Ω–µ —Å—Ä–∞–∑—É)

‚úÖ 2.3: –£–º–µ–Ω—å—à–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ —Ç–∏–∫–∞
–§–∞–π–ª: distribution_scheduler.py ‚Üí _load_config, run_scheduler
–ò–∑–º–µ–Ω–µ–Ω–∏—è:
pythontick_seconds=await get_int("distribution_tick_seconds", 15),  # –±—ã–ª–æ 30
sleep_for = 15  # –±—ã–ª–æ 30
‚úÖ –ë–û–ù–£–°: –ú–∏–≥—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤ –Ω–∞ PostgreSQL
–§–∞–π–ª: tests/conftest.py
–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

‚úÖ –í—Å–µ PostgreSQL —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç (NOW(), pg_try_advisory_lock(), etc.)
‚úÖ –ü–æ–ª–Ω–∞—è –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å test/dev/prod –æ–∫—Ä—É–∂–µ–Ω–∏–π
‚úÖ –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å SQL –¥–∏–∞–ª–µ–∫—Ç–∞–º–∏
‚úÖ –†–µ–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤


üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–°—Ç—Ä–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–æ–¢–µ—Å—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω–ædistribution_scheduler.py~200-conftest.py~240-test_step_2*.py-6–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è~150-–ò–¢–û–ì–û~5906

 –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏
–≠–¢–ê–ü 3: –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò (2-3 —á–∞—Å–∞)

3.1: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
3.2: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è SQL –≤ candidates (—É–±—Ä–∞—Ç—å RANDOM())
3.3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è wakeup –º–µ—Ö–∞–Ω–∏–∑–º–∞ (N+1 –∑–∞–ø—Ä–æ—Å)