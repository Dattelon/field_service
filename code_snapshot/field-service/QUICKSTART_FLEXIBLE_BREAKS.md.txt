# üöÄ Quick Start - –ì–∏–±–∫–∏–µ –ø–µ—Ä–µ—Ä—ã–≤—ã

## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å?

‚úÖ **–í—ã–±–æ—Ä –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**: 15 –º–∏–Ω—É—Ç / 1 —á–∞—Å / 2 —á–∞—Å–∞  
‚úÖ **–¢–∞–π–º–µ—Ä –≤ –º–µ–Ω—é**: –í–∏–¥–Ω–æ —Å–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å –¥–æ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–µ—Ä—ã–≤–∞  
‚úÖ **–ê–≤—Ç–æ—Å–Ω—è—Ç–∏–µ**: –ü–æ—Å–ª–µ –ø–µ—Ä–µ—Ä—ã–≤–∞ –º–∞—Å—Ç–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–∏–º–∞–µ—Ç—Å—è —Å–æ —Å–º–µ–Ω—ã  
‚úÖ **–ì–∏–±–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ**: –ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–∞ —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–¥–ª–∏—Ç—å  

---

## üì¶ –ë—ã—Å—Ç—Ä—ã–π –¥–µ–ø–ª–æ–π

```powershell
# –û–¥–∏–Ω –∫–æ–º–∞–Ω–¥–æ–π
.\deploy_flexible_breaks.ps1
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç:**
1. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–∞–π–ª—ã
2. ‚úÖ –ó–∞–ø—É—Å–∫–∞–µ—Ç —Ç–µ—Å—Ç—ã
3. ‚úÖ –°–æ–∑–¥–∞—ë—Ç –±—ç–∫–∞–ø
4. ‚úÖ –ö–æ–ø–∏—Ä—É–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä
5. ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç master-bot
6. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–æ–≥–∏

---

## üß™ –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

### 1. –ù–∞—á–∞–ª–æ –ø–µ—Ä–µ—Ä—ã–≤–∞

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. –í–∫–ª—é—á–∏—Ç–µ —Å–º–µ–Ω—É –≤ master-–±–æ—Ç–µ
2. –ù–∞–∂–º–∏—Ç–µ "‚òï –ü–µ—Ä–µ—Ä—ã–≤"
3. –í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, 15 –º–∏–Ω—É—Ç)

**–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏:**
- ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ: "–ü–µ—Ä–µ—Ä—ã–≤ –Ω–∞ 15 –º–∏–Ω—É—Ç –Ω–∞—á–∞—Ç"
- ‚úÖ –í –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é –ø–æ—è–≤–∏—Ç—Å—è: `‚è∞ –ü–µ—Ä–µ—Ä—ã–≤ –¥–æ 14:30 (–æ—Å—Ç–∞–ª–æ—Å—å 15 –º–∏–Ω)`
- ‚úÖ –ö–Ω–æ–ø–∫–∞ –∏–∑–º–µ–Ω–∏—Ç—Å—è –Ω–∞ "üü¢ –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å–º–µ–Ω—É"

### 2. –¢–∞–π–º–µ—Ä –ø–µ—Ä–µ—Ä—ã–≤–∞

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. –ù–∞—Ö–æ–¥—è—Å—å –Ω–∞ –ø–µ—Ä–µ—Ä—ã–≤–µ, –Ω–∞–∂–º–∏—Ç–µ /start –∏–ª–∏ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –º–µ–Ω—é

**–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏:**
- ‚úÖ –í –∑–∞–≥–æ–ª–æ–≤–∫–µ –º–µ–Ω—é –≤–∏–¥–Ω–æ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
- ‚úÖ –í–∏–¥–Ω–æ —Å–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å –º–∏–Ω—É—Ç/—á–∞—Å–æ–≤

### 3. –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–µ—Ä–µ—Ä—ã–≤–∞

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. –ù–∞—Ö–æ–¥—è—Å—å –Ω–∞ –ø–µ—Ä–µ—Ä—ã–≤–µ, –ø–æ–ª—É—á–∏—Ç–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ "‚òï –ü—Ä–æ–¥–ª–∏—Ç—å –ø–µ—Ä–µ—Ä—ã–≤")
2. –í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–¥–ª–µ–Ω–∏—è

**–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏:**
- ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ: "–ü–µ—Ä–µ—Ä—ã–≤ –ø—Ä–æ–¥–ª—ë–Ω –Ω–∞ X"
- ‚úÖ –¢–∞–π–º–µ—Ä –æ–±–Ω–æ–≤–∏—Ç—Å—è —Å –Ω–æ–≤—ã–º –≤—Ä–µ–º–µ–Ω–µ–º

### 4. –ê–≤—Ç–æ—Å–Ω—è—Ç–∏–µ —Å–æ —Å–º–µ–Ω—ã

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. –ù–∞—á–Ω–∏—Ç–µ –∫–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–µ—Ä—ã–≤ (15 –º–∏–Ω—É—Ç)
2. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 15+ –º–∏–Ω—É—Ç (–∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ break_until –≤ –ë–î –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è)

**–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏ —á–µ—Ä–µ–∑ ~1 –º–∏–Ω—É—Ç—É –ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è:**
- ‚úÖ –ú–∞—Å—Ç–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω—è—Ç —Å–æ —Å–º–µ–Ω—ã
- ‚úÖ shift_status = SHIFT_OFF
- ‚úÖ –í –º–µ–Ω—é –∫–Ω–æ–ø–∫–∞ "üü¢ –í–∫–ª—é—á–∏—Ç—å —Å–º–µ–Ω—É"

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

### Master-bot –ª–æ–≥–∏
```bash
docker compose logs -f master-bot --tail=50
```

**–ò—â–∏—Ç–µ:**
- ‚úÖ `Break reminder scheduler started`
- ‚úÖ `expired_breaks` –∑–∞–¥–∞—á–∞ –∑–∞–ø—É—â–µ–Ω–∞
- ‚úÖ `break_expired mid=XXX` –ø—Ä–∏ —Å–Ω—è—Ç–∏–∏ —Å–æ —Å–º–µ–Ω—ã

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
```bash
docker compose exec postgres psql -U postgres -d field_service
```

```sql
-- –ú–∞—Å—Ç–µ—Ä–∞ –Ω–∞ –ø–µ—Ä–µ—Ä—ã–≤–µ
SELECT id, full_name, shift_status, break_until, 
       NOW() as current_time,
       break_until - NOW() as time_left
FROM masters 
WHERE shift_status = 'BREAK';

-- –õ–æ–≥–∏ watchdog
SELECT * FROM live_log 
WHERE subsystem = 'watchdog' 
  AND text LIKE '%break%'
ORDER BY created_at DESC 
LIMIT 10;
```

---

## ‚ö° –£—Å–∫–æ—Ä–µ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç –∑–∞ 2 –º–∏–Ω—É—Ç—ã

```powershell
# 1. –ò–∑–º–µ–Ω–∏—Ç—å break_until –≤ –ë–î –Ω–∞ "—á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥"
docker compose exec postgres psql -U postgres -d field_service -c "
    UPDATE masters 
    SET break_until = NOW() + INTERVAL '30 seconds'
    WHERE shift_status = 'BREAK'
    LIMIT 1;
"

# 2. –ü–æ–¥–æ–∂–¥–∞—Ç—å 90 —Å–µ–∫—É–Ω–¥

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –º–∞—Å—Ç–µ—Ä —Å–Ω—è—Ç
docker compose exec postgres psql -U postgres -d field_service -c "
    SELECT id, shift_status, break_until 
    FROM masters 
    WHERE id = XXX;
"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- shift_status = 'SHIFT_OFF'
- break_until = NULL

---

## üêõ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –¢–∞–π–º–µ—Ä –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –º–∞—Å—Ç–µ—Ä –Ω–∞ –ø–µ—Ä–µ—Ä—ã–≤–µ: `shift_status = 'BREAK'`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ `break_until IS NOT NULL`
3. –û–±–Ω–æ–≤–∏—Ç–µ –º–µ–Ω—é –∫–æ–º–∞–Ω–¥–æ–π /start

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–∞—Å—Ç–µ—Ä –Ω–µ —Å–Ω–∏–º–∞–µ—Ç—Å—è —Å–æ —Å–º–µ–Ω—ã

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
```bash
# Watchdog –∑–∞–ø—É—â–µ–Ω?
docker compose ps | grep master-bot

# –ï—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∏?
docker compose logs master-bot | grep -i "error\|exception"

# –†–∞–±–æ—Ç–∞–µ—Ç –ª–∏ watchdog?
docker compose exec postgres psql -U postgres -d field_service -c "
    SELECT * FROM live_log 
    WHERE subsystem = 'watchdog' 
    ORDER BY created_at DESC 
    LIMIT 5;
"
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–Ω–æ–ø–∫–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞: `docker compose restart master-bot`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `docker compose logs master-bot --tail=100`
3. –û—á–∏—Å—Ç–∏—Ç–µ FSM state: –Ω–∞–∂–º–∏—Ç–µ /cancel –≤ –±–æ—Ç–µ

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

```sql
-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–µ—Ä–µ—Ä—ã–≤–æ–≤
SELECT COUNT(*) FROM masters WHERE shift_status = 'BREAK';

-- –°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ä—ã–≤–æ–≤
SELECT 
    AVG(EXTRACT(EPOCH FROM (break_until - updated_at))/60) as avg_minutes
FROM masters 
WHERE shift_status = 'BREAK' 
  AND break_until IS NOT NULL;

-- –°—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è watchdog –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
SELECT COUNT(*) 
FROM live_log 
WHERE subsystem = 'watchdog' 
  AND text LIKE '%break_expired%'
  AND created_at > NOW() - INTERVAL '1 hour';
```

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

### –ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
- [ ] –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç –ª–æ–∫–∞–ª—å–Ω–æ
- [ ] –°–æ–∑–¥–∞–Ω –±—ç–∫–∞–ø –ë–î
- [ ] –ï—Å—Ç—å SSH –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–µ—Ä—É

### –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
- [ ] Master-bot –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω
- [ ] –õ–æ–≥–∏ –±–µ–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
- [ ] Watchdog –∑–∞–ø—É—â–µ–Ω
- [ ] –ú–∞—Å—Ç–µ—Ä –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å –ø–µ—Ä–µ—Ä—ã–≤
- [ ] –¢–∞–π–º–µ—Ä –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
- [ ] –ü—Ä–æ–¥–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ê–≤—Ç–æ—Å–Ω—è—Ç–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: `FLEXIBLE_BREAKS_DEPLOYMENT.md`
- **Changelog**: `CHANGELOG_FLEXIBLE_BREAKS.md`
- **–°–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è**: `deploy_flexible_breaks.ps1`
- **–¢–µ—Å—Ç—ã**: `tests/test_watchdog_expired_breaks.py`

---

## üéØ –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è:

‚úÖ –ú–∞—Å—Ç–µ—Ä–∞ –ø–æ–ª—É—á–∞—é—Ç **–≥–∏–±–∫–æ—Å—Ç—å** –≤—ã–±–æ—Ä–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏  
‚úÖ –í–∏–¥—è—Ç **–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ç–∞–π–º–µ—Ä** –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –≤—Ä–µ–º–µ–Ω–∏  
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–∏–º–∞—é—Ç—Å—è —Å–æ —Å–º–µ–Ω—ã (–Ω–µ –∑–∞–±—ã–≤–∞—é—Ç)  
‚úÖ –ú–æ–≥—É—Ç –ª–µ–≥–∫–æ **–ø—Ä–æ–¥–ª–∏—Ç—å** –ø–µ—Ä–µ—Ä—ã–≤ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏  

**–í—Ä–µ–º—è –¥–µ–ø–ª–æ—è:** ~5 –º–∏–Ω—É—Ç  
**–í—Ä–µ–º—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** ~15 –º–∏–Ω—É—Ç  

---

**–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üöÄ**
