#!/usr/bin/env python3
"""
Add districts for all 79 cities to Field Service database.
Run inside the container: docker exec -it field-service-admin-bot-1 python add_all_districts.py
"""
import asyncio
from sqlalchemy import select, delete
from field_service.db.session import SessionLocal
from field_service.db import models as m

# Mapping: city_name -> list of district names
CITY_DISTRICTS = {
    "Москва": ["ЦАО", "САО", "СВАО", "ВАО", "ЮВАО", "ЮАО", "ЮЗАО", "ЗАО", "СЗАО", "ЗелАО", "НАО", "ТАО"],
    "Санкт-Петербург": ["Адмиралтейский", "Василеостровский", "Выборгский", "Калининский", "Кировский", 
                        "Колпинский", "Красногвардейский", "Красносельский", "Кронштадтский", "Курортный", 
                        "Московский", "Невский", "Петроградский", "Петродворцовый", "Приморский", "Пушкинский", 
                        "Фрунзенский", "Центральный"],
    "Новосибирск": ["Центральный", "Железнодорожный", "Заельцовский", "Дзержинский", "Калининский", 
                    "Кировский", "Ленинский", "Октябрьский", "Первомайский", "Советский"],
    "Екатеринбург": ["Верх-Исетский", "Железнодорожный", "Кировский", "Ленинский", "Октябрьский", 
                     "Орджоникидзевский", "Чкаловский"],
    "Казань": ["Авиастроительный", "Вахитовский", "Кировский", "Московский", "Ново-Савиновский", 
               "Приволжский", "Советский"],
    "Нижний Новгород": ["Автозаводский", "Канавинский", "Ленинский", "Московский", "Нижегородский", 
                        "Приокский", "Советский", "Сормовский"],
    "Челябинск": ["Калининский", "Курчатовский", "Ленинский", "Металлургический", "Советский", 
                  "Тракторозаводский", "Центральный"],
    "Красноярск": ["Железнодорожный", "Кировский", "Ленинский", "Октябрьский", "Свердловский", 
                   "Советский", "Центральный"],
    "Самара": ["Железнодорожный", "Кировский", "Красноглинский", "Куйбышевский", "Ленинский", 
               "Октябрьский", "Промышленный", "Самарский", "Советский"],
    "Уфа": ["Демский", "Калининский", "Кировский", "Ленинский", "Октябрьский", "Орджоникидзевский", "Советский"],
    "Ростов на Дону": ["Ворошиловский", "Железнодорожный", "Кировский", "Ленинский", "Октябрьский", 
                       "Первомайский", "Пролетарский", "Советский"],
    "Краснодар": ["Западный округ", "Карасунский округ", "Прикубанский округ", "Центральный округ"],
    "Омск": ["Центральный", "Советский", "Кировский", "Ленинский", "Октябрьский"],
    "Воронеж": ["Железнодорожный", "Коминтерновский", "Левобережный", "Ленинский", "Советский", "Центральный"],
    "Пермь": ["Дзержинский", "Индустриальный", "Кировский", "Ленинский", "Мотовилихинский", 
              "Орджоникидзевский", "Свердловский"],
    "Волгоград": ["Тракторозаводский", "Краснооктябрьский", "Дзержинский", "Центральный", "Ворошиловский", 
                  "Советский", "Кировский", "Красноармейский"],
    "Саратов": ["Волжский", "Заводской", "Кировский", "Ленинский", "Октябрьский", "Фрунзенский"],
    "Тюмень": ["Калининский", "Ленинский", "Центральный", "Восточный"],
    "Тольятти": ["Автозаводский", "Комсомольский", "Центральный"],
    "Ижевск": ["Индустриальный", "Ленинский", "Октябрьский", "Первомайский", "Устиновский"],
    "Барнаул": ["Железнодорожный", "Индустриальный", "Ленинский", "Октябрьский", "Центральный"],
    "Ульяновск": ["Засвияжский", "Заволжский", "Железнодорожный", "Ленинский"],
    "Иркутск": ["Куйбышевский", "Ленинский", "Октябрьский", "Свердловский"],
    "Хабаровск": ["Железнодорожный", "Индустриальный", "Кировский", "Центральный"],
    "Владивосток": ["Ленинский", "Первомайский", "Первореченский", "Советский", "Фрунзенский"],
    "Ярославль": ["Дзержинский", "Заволжский", "Кировский", "Красноперекопский", "Ленинский", "Фрунзенский"],
    "Махачкала": ["Кировский", "Ленинский", "Советский"],
    "Томск": ["Кировский", "Ленинский", "Октябрьский", "Советский"],
    "Оренбург": ["Дзержинский", "Ленинский", "Промышленный", "Центральный"],
    "Кемерово": ["Заводский", "Кировский", "Ленинский", "Рудничный", "Центральный"],
    "Новокузнецк": ["Заводский", "Куйбышевский", "Центральный"],
    "Рязань": ["Железнодорожный", "Московский", "Октябрьский", "Советский"],
    "Набережные Челны": ["Автозаводский", "Комсомольский", "Центральный"],
    "Астрахань": ["Кировский", "Ленинский", "Советский", "Трусовский"],
    "Пенза": ["Железнодорожный", "Ленинский", "Октябрьский", "Первомайский"],
    "Киров": ["Ленинский", "Нововятский", "Октябрьский", "Первомайский"],
    "Липецк": ["Левобережный", "Октябрьский", "Правобережный", "Советский"],
    "Чебоксары": ["Калининский", "Ленинский", "Московский"],
    "Калининград": ["Ленинградский", "Московский", "Центральный"],
    "Тула": ["Зареченский", "Привокзальный", "Пролетарский", "Советский", "Центральный"],
    "Курск": ["Железнодорожный", "Сеймский", "Центральный"],
    "Сочи": ["Адлерский", "Лазаревский", "Хостинский", "Центральный"],
    "Ставрополь": ["Ленинский", "Октябрьский", "Промышленный"],
    "Балашиха (МО)": ["Город целиком"],
    "Севастополь": ["Балаклавский", "Гагаринский", "Ленинский", "Нахимовский"],
    "Брянск": ["Бежицкий", "Володарский", "Советский", "Фокинский"],
    "Белгород": ["Восточный", "Западный"],
    "Магнитогорск": ["Ленинский", "Орджоникидзевский", "Правобережный"],
    "Великий Новгород": ["Город целиком"],
    "Калуга": ["Ленинский", "Московский", "Октябрьский"],
    "Сургут": ["Восточный", "Западный", "Северный жилой", "Северный промышленный", "Центральный"],
    "Владикавказ": ["Затеречный", "Иристонский", "Промышленный", "Северо-Западный"],
    "Чита": ["Железнодорожный", "Ингодинский", "Центральный", "Черновский"],
    "Симферополь": ["Железнодорожный", "Киевский", "Центральный"],
    "Волжский": ["Город целиком"],
    "Смоленск": ["Заднепровский", "Ленинский", "Промышленный"],
    "Саранск": ["Город целиком"],
    "Курган": ["Город целиком"],
    "Орёл": ["Город целиком"],
    "Подольск (МО)": ["Город целиком"],
    "Архангельск": ["Варавино-Фактория", "Исакогорский", "Ломоносовский", "Майская горка", 
                    "Маймаксанский", "Октябрьский", "Северный", "Соломбальский", "Цигломенский"],
    "Грозный": ["Ахматовский", "Байсангуровский", "Висаитовский", "Шейх-Мансуровский"],
    "Якутск": ["Автодорожный", "Гагаринский", "Губинский", "Октябрьский", "Промышленный", 
               "Сайсарский", "Строительный", "Центральный"],
    "Тверь": ["Заволжский", "Московский", "Пролетарский", "Центральный"],
    "Старый Оскол": ["Город целиком"],
    "Улан Удэ": ["Железнодорожный", "Октябрьский", "Советский"],
    "Нижний Тагил": ["Дзержинский", "Ленинский", "Тагилстроевский"],
    "Нижневартовск": ["Город целиком"],
    "Псков": ["Город целиком"],
    "Йошкар Ола": ["Город целиком"],
    "Кострома": ["Город целиком"],
    "Новороссийск": ["Город целиком"],
    "Дзержинск": ["Город целиком"],
    "Таганрог": ["Город целиком"],
    "Химки (МО)": ["Город целиком"],
    "Березники": ["Город целиком"],
    "Энгельс": ["Город целиком"],
    "Шахты": ["Город целиком"],
}

async def add_all_districts():
    """Add districts for all cities."""
    async with SessionLocal() as session:
        async with session.begin():
            # Get all cities from DB
            result = await session.execute(select(m.cities))
            cities = {row.name: row.id for row in result.scalars().all()}
            
            added = 0
            skipped = 0
            
            for city_name, districts in CITY_DISTRICTS.items():
                if city_name not in cities:
                    print(f"⚠️  Город не найден в БД: {city_name}")
                    skipped += 1
                    continue
                
                city_id = cities[city_name]
                
                # Delete existing districts for this city
                await session.execute(
                    delete(m.districts).where(m.districts.city_id == city_id)
                )
                
                # Add new districts
                for district_name in districts:
                    district = m.districts(
                        city_id=city_id,
                        name=district_name
                    )
                    session.add(district)
                    added += 1
                
                print(f"✅ {city_name}: добавлено {len(districts)} районов")
            
            await session.commit()
            
            print(f"\n{'='*50}")
            print(f"Готово!")
            print(f"  Всего районов добавлено: {added}")
            print(f"  Городов пропущено: {skipped}")
            print(f"{'='*50}\n")
            
            # Verification
            result = await session.execute(
                select(m.cities.name, m.cities.id)
                .outerjoin(m.districts, m.cities.id == m.districts.city_id)
            )
            print("\nПроверка:")
            from sqlalchemy import func
            result = await session.execute(
                select(
                    m.cities.id,
                    m.cities.name,
                    func.count(m.districts.id).label('district_count')
                )
                .outerjoin(m.districts, m.cities.id == m.districts.city_id)
                .group_by(m.cities.id, m.cities.name)
                .order_by(m.cities.id)
            )
            for row in result.all():
                print(f"  {row.id:3d}. {row.name:30s} - {row.district_count} районов")

if __name__ == "__main__":
    asyncio.run(add_all_districts())
