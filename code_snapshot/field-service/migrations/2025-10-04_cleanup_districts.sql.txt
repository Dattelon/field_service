-- ============================================================================
-- МИГРАЦИЯ: Упрощение структуры районов до административных округов
-- Дата: 2025-10-04
-- Автор: Тимлид проекта
-- Описание: Удаление избыточных районов, добавление официальных АО/районов
-- ============================================================================

BEGIN;

-- ============================================================================
-- ЧАСТЬ 1: КРИТИЧЕСКИЕ ГОРОДА (Приоритет HIGH)
-- ============================================================================

-- ----------------------------------------------------------------------------
-- 1. ИРКУТСК (city_id=4): Удалить 650 лишних, оставить 4 АО
-- ----------------------------------------------------------------------------
DO $$
DECLARE
    before_count INTEGER;
    after_count INTEGER;
BEGIN
    SELECT COUNT(*) INTO before_count FROM districts WHERE city_id = 4;
    RAISE NOTICE '▶ ИРКУТСК: До миграции районов: %', before_count;
    
    -- Удаляем все районы КРОМЕ 4 административных округов
    DELETE FROM districts 
    WHERE city_id = 4 
      AND id NOT IN (
        1262,  -- Ленинский административный округ
        1263,  -- Свердловский административный округ
        1264,  -- Октябрьский административный округ
        1265   -- Правобережный административный округ
      );
    
    SELECT COUNT(*) INTO after_count FROM districts WHERE city_id = 4;
    RAISE NOTICE '✓ ИРКУТСК: После миграции районов: %', after_count;
    RAISE NOTICE '  Удалено районов: %', before_count - after_count;
END $$;


-- ----------------------------------------------------------------------------
-- 2. МОСКВА (city_id=1): Удалить лишние + добавить недостающие 7 АО
-- ----------------------------------------------------------------------------
DO $$
DECLARE
    before_count INTEGER;
    after_count INTEGER;
BEGIN
    SELECT COUNT(*) INTO before_count FROM districts WHERE city_id = 1;
    RAISE NOTICE '▶ МОСКВА: До миграции районов: %', before_count;
    
    -- Удаляем все районы КРОМЕ 5 уже существующих АО
    DELETE FROM districts 
    WHERE city_id = 1 
      AND id NOT IN (1, 2, 3, 4, 5);  -- ЦАО, САО, ЮАО, ВАО, ЗАО
    
    -- Добавляем недостающие 7 административных округов
    INSERT INTO districts (city_id, name) VALUES
    (1, 'СВАО'),   -- Северо-Восточный АО
    (1, 'ЮВАО'),   -- Юго-Восточный АО
    (1, 'ЮЗАО'),   -- Юго-Западный АО
    (1, 'СЗАО'),   -- Северо-Западный АО
    (1, 'ЗелАО'),  -- Зеленоградский АО
    (1, 'НАО'),    -- Новомосковский АО
    (1, 'ТАО')     -- Троицкий АО
    ON CONFLICT DO NOTHING;
    
    SELECT COUNT(*) INTO after_count FROM districts WHERE city_id = 1;
    RAISE NOTICE '✓ МОСКВА: После миграции округов: %', after_count;
END $$;


-- ----------------------------------------------------------------------------
-- 3. САНКТ-ПЕТЕРБУРГ (city_id=2): Удалить дубль + заменить на 18 районов
-- ----------------------------------------------------------------------------
DO $$
DECLARE
    before_count INTEGER;
    after_count INTEGER;
    duplicate_exists BOOLEAN;
BEGIN
    -- Проверяем наличие дубля города (id=5)
    SELECT EXISTS(SELECT 1 FROM cities WHERE id = 5) INTO duplicate_exists;
    
    IF duplicate_exists THEN
        RAISE NOTICE '▶ СПБ: Обнаружен дубль города (id=5). Начинаем объединение...';
        
        -- Переносим все заказы с дубля на основной город
        UPDATE orders SET city_id = 2 WHERE city_id = 5;
        RAISE NOTICE '  ✓ Перенесены заказы с city_id=5 на city_id=2';
        
        -- Переносим всех мастеров с дубля на основной город
        UPDATE masters SET city_id = 2 WHERE city_id = 5;
        RAISE NOTICE '  ✓ Перенесены мастера с city_id=5 на city_id=2';
        
        -- Удаляем районы дубля
        DELETE FROM districts WHERE city_id = 5;
        
        -- Удаляем дубль города
        DELETE FROM cities WHERE id = 5 AND name = 'Санкт Петербург';
        RAISE NOTICE '  ✓ Удален дубль города (id=5)';
    END IF;
    
    SELECT COUNT(*) INTO before_count FROM districts WHERE city_id = 2;
    RAISE NOTICE '▶ СПБ: До миграции районов: %', before_count;
    
    -- Удаляем ВСЕ старые районы (муниципальные округа)
    DELETE FROM districts WHERE city_id = 2;
    
    -- Добавляем 18 официальных административных районов
    INSERT INTO districts (city_id, name) VALUES
    (2, 'Адмиралтейский'),
    (2, 'Василеостровский'),
    (2, 'Выборгский'),
    (2, 'Калининский'),
    (2, 'Кировский'),
    (2, 'Колпинский'),
    (2, 'Красногвардейский'),
    (2, 'Красносельский'),
    (2, 'Кронштадтский'),
    (2, 'Курортный'),
    (2, 'Московский'),
    (2, 'Невский'),
    (2, 'Петроградский'),
    (2, 'Петродворцовый'),
    (2, 'Приморский'),
    (2, 'Пушкинский'),
    (2, 'Фрунзенский'),
    (2, 'Центральный')
    ON CONFLICT DO NOTHING;
    
    SELECT COUNT(*) INTO after_count FROM districts WHERE city_id = 2;
    RAISE NOTICE '✓ СПБ: После миграции районов: %', after_count;
END $$;


-- ============================================================================
-- ЧАСТЬ 2: КРУПНЫЕ ГОРОДА (Приоритет MEDIUM)
-- ============================================================================

-- ----------------------------------------------------------------------------
-- 4. НОВОСИБИРСК (city_id=6): 10 районов
-- ----------------------------------------------------------------------------
DO $$
BEGIN
    RAISE NOTICE '▶ НОВОСИБИРСК: Добавление 10 районов...';
    
    DELETE FROM districts WHERE city_id = 6;
    
    INSERT INTO districts (city_id, name) VALUES
    (6, 'Центральный'),
    (6, 'Железнодорожный'),
    (6, 'Заельцовский'),
    (6, 'Дзержинский'),
    (6, 'Калининский'),
    (6, 'Кировский'),
    (6, 'Ленинский'),
    (6, 'Октябрьский'),
    (6, 'Первомайский'),
    (6, 'Советский')
    ON CONFLICT DO NOTHING;
    
    RAISE NOTICE '✓ НОВОСИБИРСК: Добавлено 10 районов';
END $$;


-- ----------------------------------------------------------------------------
-- 5. ЕКАТЕРИНБУРГ (city_id=7): 7 районов
-- ----------------------------------------------------------------------------
DO $$
BEGIN
    RAISE NOTICE '▶ ЕКАТЕРИНБУРГ: Добавление 7 районов...';
    
    DELETE FROM districts WHERE city_id = 7;
    
    INSERT INTO districts (city_id, name) VALUES
    (7, 'Верх-Исетский'),
    (7, 'Железнодорожный'),
    (7, 'Кировский'),
    (7, 'Ленинский'),
    (7, 'Октябрьский'),
    (7, 'Орджоникидзевский'),
    (7, 'Чкаловский')
    ON CONFLICT DO NOTHING;
    
    RAISE NOTICE '✓ ЕКАТЕРИНБУРГ: Добавлено 7 районов';
END $$;


-- ----------------------------------------------------------------------------
-- 6. КАЗАНЬ (city_id=3): 7 районов
-- ----------------------------------------------------------------------------
DO $$
BEGIN
    RAISE NOTICE '▶ КАЗАНЬ: Добавление 7 районов...';
    
    DELETE FROM districts WHERE city_id = 3;
    
    INSERT INTO districts (city_id, name) VALUES
    (3, 'Авиастроительный'),
    (3, 'Вахитовский'),
    (3, 'Кировский'),
    (3, 'Московский'),
    (3, 'Ново-Савиновский'),
    (3, 'Приволжский'),
    (3, 'Советский')
    ON CONFLICT DO NOTHING;
    
    RAISE NOTICE '✓ КАЗАНЬ: Добавлено 7 районов';
END $$;


-- ----------------------------------------------------------------------------
-- 7. НИЖНИЙ НОВГОРОД (city_id=8): 8 районов
-- ----------------------------------------------------------------------------
DO $$
BEGIN
    RAISE NOTICE '▶ НИЖНИЙ НОВГОРОД: Добавление 8 районов...';
    
    DELETE FROM districts WHERE city_id = 8;
    
    INSERT INTO districts (city_id, name) VALUES
    (8, 'Автозаводский'),
    (8, 'Канавинский'),
    (8, 'Ленинский'),
    (8, 'Московский'),
    (8, 'Нижегородский'),
    (8, 'Приокский'),
    (8, 'Советский'),
    (8, 'Сормовский')
    ON CONFLICT DO NOTHING;
    
    RAISE NOTICE '✓ НИЖНИЙ НОВГОРОД: Добавлено 8 районов';
END $$;


-- ----------------------------------------------------------------------------
-- 8. ЧЕЛЯБИНСК (city_id=9): 7 районов
-- ----------------------------------------------------------------------------
DO $$
BEGIN
    RAISE NOTICE '▶ ЧЕЛЯБИНСК: Добавление 7 районов...';
    
    DELETE FROM districts WHERE city_id = 9;
    
    INSERT INTO districts (city_id, name) VALUES
    (9, 'Калининский'),
    (9, 'Курчатовский'),
    (9, 'Ленинский'),
    (9, 'Металлургический'),
    (9, 'Советский'),
    (9, 'Тракторозаводский'),
    (9, 'Центральный')
    ON CONFLICT DO NOTHING;
    
    RAISE NOTICE '✓ ЧЕЛЯБИНСК: Добавлено 7 районов';
END $$;


-- ----------------------------------------------------------------------------
-- 9. КРАСНОЯРСК (city_id=10): 7 районов
-- ----------------------------------------------------------------------------
DO $$
BEGIN
    RAISE NOTICE '▶ КРАСНОЯРСК: Добавление 7 районов...';
    
    DELETE FROM districts WHERE city_id = 10;
    
    INSERT INTO districts (city_id, name) VALUES
    (10, 'Железнодорожный'),
    (10, 'Кировский'),
    (10, 'Ленинский'),
    (10, 'Октябрьский'),
    (10, 'Свердловский'),
    (10, 'Советский'),
    (10, 'Центральный')
    ON CONFLICT DO NOTHING;
    
    RAISE NOTICE '✓ КРАСНОЯРСК: Добавлено 7 районов';
END $$;


-- ----------------------------------------------------------------------------
-- 10. САМАРА (city_id=11): 9 районов
-- ----------------------------------------------------------------------------
DO $$
BEGIN
    RAISE NOTICE '▶ САМАРА: Добавление 9 районов...';
    
    DELETE FROM districts WHERE city_id = 11;
    
    INSERT INTO districts (city_id, name) VALUES
    (11, 'Железнодорожный'),
    (11, 'Кировский'),
    (11, 'Красноглинский'),
    (11, 'Куйбышевский'),
    (11, 'Ленинский'),
    (11, 'Октябрьский'),
    (11, 'Промышленный'),
    (11, 'Самарский'),
    (11, 'Советский')
    ON CONFLICT DO NOTHING;
    
    RAISE NOTICE '✓ САМАРА: Добавлено 9 районов';
END $$;


-- ----------------------------------------------------------------------------
-- 11. УФА (city_id=12): 7 районов
-- ----------------------------------------------------------------------------
DO $$
BEGIN
    RAISE NOTICE '▶ УФА: Добавление 7 районов...';
    
    DELETE FROM districts WHERE city_id = 12;
    
    INSERT INTO districts (city_id, name) VALUES
    (12, 'Демский'),
    (12, 'Калининский'),
    (12, 'Кировский'),
    (12, 'Ленинский'),
    (12, 'Октябрьский'),
    (12, 'Орджоникидзевский'),
    (12, 'Советский')
    ON CONFLICT DO NOTHING;
    
    RAISE NOTICE '✓ УФА: Добавлено 7 районов';
END $$;


-- ----------------------------------------------------------------------------
-- 12. РОСТОВ-НА-ДОНУ (city_id=13): 8 районов
-- ----------------------------------------------------------------------------
DO $$
BEGIN
    RAISE NOTICE '▶ РОСТОВ-НА-ДОНУ: Добавление 8 районов...';
    
    DELETE FROM districts WHERE city_id = 13;
    
    INSERT INTO districts (city_id, name) VALUES
    (13, 'Ворошиловский'),
    (13, 'Железнодорожный'),
    (13, 'Кировский'),
    (13, 'Ленинский'),
    (13, 'Октябрьский'),
    (13, 'Первомайский'),
    (13, 'Пролетарский'),
    (13, 'Советский')
    ON CONFLICT DO NOTHING;
    
    RAISE NOTICE '✓ РОСТОВ-НА-ДОНУ: Добавлено 8 районов';
END $$;


-- ============================================================================
-- ЧАСТЬ 3: ИСПРАВЛЕНИЕ КАЛИНИНГРАДА (city_id=40)
-- ============================================================================

-- ----------------------------------------------------------------------------
-- 13. КАЛИНИНГРАД: Добавить район "Город целиком" (сейчас 0 районов)
-- ----------------------------------------------------------------------------
DO $$
DECLARE
    district_count INTEGER;
BEGIN
    SELECT COUNT(*) INTO district_count FROM districts WHERE city_id = 40;
    
    IF district_count = 0 THEN
        RAISE NOTICE '▶ КАЛИНИНГРАД: Нет районов. Добавляем "Город целиком"...';
        
        INSERT INTO districts (city_id, name) 
        VALUES (40, 'Город целиком')
        ON CONFLICT DO NOTHING;
        
        RAISE NOTICE '✓ КАЛИНИНГРАД: Добавлен район "Город целиком"';
    ELSE
        RAISE NOTICE '▶ КАЛИНИНГРАД: Районы уже существуют (%)', district_count;
    END IF;
END $$;


-- ============================================================================
-- ЧАСТЬ 4: ФИНАЛЬНАЯ ПРОВЕРКА
-- ============================================================================

DO $$
DECLARE
    total_districts INTEGER;
    moscow_count INTEGER;
    spb_count INTEGER;
    irkutsk_count INTEGER;
    novosibirsk_count INTEGER;
    duplicate_cities INTEGER;
BEGIN
    -- Общая статистика
    SELECT COUNT(*) INTO total_districts FROM districts;
    
    -- Критические города
    SELECT COUNT(*) INTO moscow_count FROM districts WHERE city_id = 1;
    SELECT COUNT(*) INTO spb_count FROM districts WHERE city_id = 2;
    SELECT COUNT(*) INTO irkutsk_count FROM districts WHERE city_id = 4;
    SELECT COUNT(*) INTO novosibirsk_count FROM districts WHERE city_id = 6;
    
    -- Проверка дублей городов
    SELECT COUNT(*) INTO duplicate_cities 
    FROM (
        SELECT name 
        FROM cities 
        GROUP BY name 
        HAVING COUNT(*) > 1
    ) AS duplicates;
    
    RAISE NOTICE '';
    RAISE NOTICE '========================================';
    RAISE NOTICE 'ФИНАЛЬНАЯ ПРОВЕРКА МИГРАЦИИ';
    RAISE NOTICE '========================================';
    RAISE NOTICE 'Всего районов в БД: %', total_districts;
    RAISE NOTICE '';
    RAISE NOTICE 'Проверка критических городов:';
    RAISE NOTICE '  Москва:       % (ожидается 12)', moscow_count;
    RAISE NOTICE '  СПб:          % (ожидается 18)', spb_count;
    RAISE NOTICE '  Иркутск:      % (ожидается 4)', irkutsk_count;
    RAISE NOTICE '  Новосибирск:  % (ожидается 10)', novosibirsk_count;
    RAISE NOTICE '';
    RAISE NOTICE 'Дублей городов: % (ожидается 0)', duplicate_cities;
    RAISE NOTICE '========================================';
    
    -- Проверка на ошибки
    IF moscow_count != 12 THEN
        RAISE WARNING 'ОШИБКА: Москва имеет % районов вместо 12!', moscow_count;
    END IF;
    
    IF spb_count != 18 THEN
        RAISE WARNING 'ОШИБКА: СПб имеет % районов вместо 18!', spb_count;
    END IF;
    
    IF irkutsk_count != 4 THEN
        RAISE WARNING 'ОШИБКА: Иркутск имеет % районов вместо 4!', irkutsk_count;
    END IF;
    
    IF duplicate_cities > 0 THEN
        RAISE WARNING 'ОШИБКА: Обнаружены дубли городов!';
    END IF;
    
    IF moscow_count = 12 AND spb_count = 18 AND irkutsk_count = 4 AND duplicate_cities = 0 THEN
        RAISE NOTICE '';
        RAISE NOTICE '✓✓✓ МИГРАЦИЯ УСПЕШНО ЗАВЕРШЕНА ✓✓✓';
        RAISE NOTICE '';
    END IF;
END $$;


-- ============================================================================
-- ДЕТАЛЬНАЯ СТАТИСТИКА ПО ВСЕМ ГОРОДАМ
-- ============================================================================

DO $$
BEGIN
    RAISE NOTICE '';
    RAISE NOTICE '========================================';
    RAISE NOTICE 'СТАТИСТИКА РАЙОНОВ ПО ГОРОДАМ';
    RAISE NOTICE '========================================';
END $$;

SELECT 
    c.id,
    c.name AS city_name,
    COUNT(d.id) AS districts_count
FROM cities c
LEFT JOIN districts d ON d.city_id = c.id
GROUP BY c.id, c.name
ORDER BY COUNT(d.id) DESC, c.name;


COMMIT;

-- ============================================================================
-- КОНЕЦ МИГРАЦИИ
-- ============================================================================
