# üß™ E2E –¢–ï–°–¢–´: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —ç—Å–∫–∞–ª–∞—Ü–∏–∏ (–®–∞–≥ 1.4)

**–î–∞—Ç–∞:** 2025-10-05  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É  
**–§–∞–π–ª:** `tests/test_e2e_escalation_notifications.py`

---

## üéØ –¶–ï–õ–¨ –¢–ï–°–¢–û–í

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ **–®–∞–≥–∞ 1.4** —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑**
- ‚úÖ –ü–æ–ª—è `escalation_logist_notified_at` –∏ `escalation_admin_notified_at` —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —Ç–∏–∫–∞—Ö scheduler'–∞
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –æ—Ñ—Ñ–µ—Ä–∞
- ‚úÖ Advisory lock –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç race conditions

---

## üìã –°–ü–ò–°–û–ö –¢–ï–°–¢–û–í

### ‚úÖ –¢–µ—Å—Ç 1: `test_logist_notification_sent_once`
**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Å—Ç—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
1. –°–æ–∑–¥–∞—ë–º –∑–∞–∫–∞–∑ –±–µ–∑ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ (–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —ç—Å–∫–∞–ª–∞—Ü–∏—è)
2. –ó–∞–ø—É—Å–∫–∞–µ–º `tick_once()` 10 —Ä–∞–∑ –ø–æ–¥—Ä—è–¥
3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ä–æ–≤–Ω–æ 1 —Ä–∞–∑

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- `escalation_logist_notified_at` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
- `dist_escalated_logist_at` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
- Mock –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª —Ä–æ–≤–Ω–æ 1 –≤—ã–∑–æ–≤

---

### ‚úÖ –¢–µ—Å—Ç 2: `test_admin_notification_sent_once`
**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
1. –°–æ–∑–¥–∞—ë–º –∑–∞–∫–∞–∑ —Å —ç—Å–∫–∞–ª–∞—Ü–∏–µ–π –∫ –ª–æ–≥–∏—Å—Ç—É 15 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥
2. –ó–∞–ø—É—Å–∫–∞–µ–º `tick_once()` 10 —Ä–∞–∑ –ø–æ–¥—Ä—è–¥
3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ä–æ–≤–Ω–æ 1 —Ä–∞–∑

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- `escalation_admin_notified_at` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
- `dist_escalated_admin_at` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
- –ù–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ª–æ–≥–∏—Å—Ç—É

---

### ‚úÖ –¢–µ—Å—Ç 3: `test_notification_reset_on_new_offer`
**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –°–±—Ä–æ—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –æ—Ñ—Ñ–µ—Ä–∞

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
1. –ó–∞–∫–∞–∑ —ç—Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
2. –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –æ—Ñ—Ñ–µ—Ä (SENT)
3. –ó–∞–ø—É—Å–∫–∞–µ–º `tick_once()` ‚Üí —ç—Å–∫–∞–ª–∞—Ü–∏–∏ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è
4. –û—Ñ—Ñ–µ—Ä –∏—Å—Ç–µ–∫–∞–µ—Ç ‚Üí –Ω–æ–≤–∞—è —ç—Å–∫–∞–ª–∞—Ü–∏—è
5. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü—Ä–∏ –Ω–æ–≤–æ–º –æ—Ñ—Ñ–µ—Ä–µ: –≤—Å–µ –ø–æ–ª—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏ = NULL
- –ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è: –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ä–æ–≤–Ω–æ 1 —Ä–∞–∑

---

### ‚úÖ –¢–µ—Å—Ç 4: `test_parallel_ticks_no_duplicate_notifications`
**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Ç–∏–∫–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
1. –°–æ–∑–¥–∞—ë–º –∑–∞–∫–∞–∑ –±–µ–∑ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
2. –ó–∞–ø—É—Å–∫–∞–µ–º 5 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö `tick_once()` –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –º–∞–∫—Å–∏–º—É–º 1 —Ä–∞–∑

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- Advisory lock –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç race condition
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: 0-1 (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç timing)

---

### ‚úÖ –¢–µ—Å—Ç 5: `test_no_district_escalation_once`
**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –≠—Å–∫–∞–ª–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ä–∞–π–æ–Ω–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–∞–∑

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
1. –°–æ–∑–¥–∞—ë–º –∑–∞–∫–∞–∑ –ë–ï–ó —Ä–∞–π–æ–Ω–∞ (`district_id = NULL`)
2. –ó–∞–ø—É—Å–∫–∞–µ–º `tick_once()` 10 —Ä–∞–∑
3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Å–∫–∞–ª–∞—Ü–∏—è –ø—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è —ç—Å–∫–∞–ª–∞—Ü–∏—è –∫ –ª–æ–≥–∏—Å—Ç—É
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ä–æ–≤–Ω–æ 1 —Ä–∞–∑

---

### ‚úÖ –¢–µ—Å—Ç 6: `test_full_escalation_cycle` (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π)
**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ—Ç –ª–æ–≥–∏—Å—Ç–∞ –¥–æ –∞–¥–º–∏–Ω–∞

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
1. –ó–∞–∫–∞–∑ ‚Üí –Ω–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ ‚Üí —ç—Å–∫–∞–ª–∞—Ü–∏—è –∫ –ª–æ–≥–∏—Å—Ç—É
2. –ß–µ—Ä–µ–∑ 10+ –º–∏–Ω—É—Ç ‚Üí —ç—Å–∫–∞–ª–∞—Ü–∏—è –∫ –∞–¥–º–∏–Ω—É
3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Å—Ç—É: 1 —Ä–∞–∑
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É: 1 —Ä–∞–∑
- –í—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã

---

### ‚úÖ –¢–µ—Å—Ç 7: `test_escalation_with_rounds_exhaustion`
**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –≠—Å–∫–∞–ª–∞—Ü–∏—è –ø—Ä–∏ –∏—Å—á–µ—Ä–ø–∞–Ω–∏–∏ —Ä–∞—É–Ω–¥–æ–≤

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
1. –°–æ–∑–¥–∞—ë–º –∑–∞–∫–∞–∑ —Å 2 –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–º–∏ –æ—Ñ—Ñ–µ—Ä–∞–º–∏
2. –†–∞—É–Ω–¥—ã –∏—Å—á–µ—Ä–ø–∞–Ω—ã ‚Üí —ç—Å–∫–∞–ª–∞—Ü–∏—è
3. –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∏–∫–∏ 10 —Ä–∞–∑

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –≠—Å–∫–∞–ª–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑

---

## üöÄ –ó–ê–ü–£–°–ö –¢–ï–°–¢–û–í

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:

```powershell
# 1. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω–∞
docker ps | findstr postgres

# 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
cd C:\ProjectF\field-service
alembic current
# –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å: 2025_10_05_0005

# 3. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
.venv\Scripts\activate
```

### –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤:

```powershell
$env:PYTHONIOENCODING='utf-8'; pytest tests/test_e2e_escalation_notifications.py -v
```

### –ó–∞–ø—É—Å–∫ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤:

```powershell
# –¢–µ—Å—Ç 1: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Å—Ç—É
$env:PYTHONIOENCODING='utf-8'; pytest tests/test_e2e_escalation_notifications.py::TestEscalationNotifications::test_logist_notification_sent_once -v -s

# –¢–µ—Å—Ç 2: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É
$env:PYTHONIOENCODING='utf-8'; pytest tests/test_e2e_escalation_notifications.py::TestEscalationNotifications::test_admin_notification_sent_once -v -s

# –¢–µ—Å—Ç 3: –°–±—Ä–æ—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
$env:PYTHONIOENCODING='utf-8'; pytest tests/test_e2e_escalation_notifications.py::TestEscalationNotifications::test_notification_reset_on_new_offer -v -s

# –¢–µ—Å—Ç 4: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Ç–∏–∫–∏
$env:PYTHONIOENCODING='utf-8'; pytest tests/test_e2e_escalation_notifications.py::TestEscalationNotifications::test_parallel_ticks_no_duplicate_notifications -v -s

# –¢–µ—Å—Ç 6: –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π)
$env:PYTHONIOENCODING='utf-8'; pytest tests/test_e2e_escalation_notifications.py::TestEscalationFullCycle::test_full_escalation_cycle -v -s
```

### –ó–∞–ø—É—Å–∫ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º:

```powershell
$env:PYTHONIOENCODING='utf-8'; pytest tests/test_e2e_escalation_notifications.py -v -s --tb=short
```

---

## üìä –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢

```
tests/test_e2e_escalation_notifications.py::TestEscalationNotifications::test_logist_notification_sent_once PASSED
tests/test_e2e_escalation_notifications.py::TestEscalationNotifications::test_admin_notification_sent_once PASSED
tests/test_e2e_escalation_notifications.py::TestEscalationNotifications::test_notification_reset_on_new_offer PASSED
tests/test_e2e_escalation_notifications.py::TestEscalationNotifications::test_parallel_ticks_no_duplicate_notifications PASSED
tests/test_e2e_escalation_notifications.py::TestEscalationNotifications::test_no_district_escalation_once PASSED
tests/test_e2e_escalation_notifications.py::TestEscalationFullCycle::test_full_escalation_cycle PASSED
tests/test_e2e_escalation_notifications.py::TestEscalationFullCycle::test_escalation_with_rounds_exhaustion PASSED

========================= 7 passed in X.XXs =========================

‚úÖ –®–∞–≥ 1.4 –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω:
   - –û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
   - –°–±—Ä–æ—Å –ø—Ä–∏ –Ω–æ–≤—ã—Ö –æ—Ñ—Ñ–µ—Ä–∞—Ö
   - –ó–∞—â–∏—Ç–∞ –æ—Ç race conditions
   - –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —ç—Å–∫–∞–ª–∞—Ü–∏–∏
```

---

## üîç –ß–¢–û –ü–†–û–í–ï–†–Ø–ï–¢ –ö–ê–ñ–î–´–ô –¢–ï–°–¢ (–î–ï–¢–ê–õ–¨–ù–û)

### Test 1: –õ–æ–≥–∏—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
```python
# –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:
assert notification_count["count"] == 1
assert order.escalation_logist_notified_at is not None
assert order.dist_escalated_logist_at is not None
```

### Test 2: –ê–¥–º–∏–Ω —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
```python
# –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:
assert notification_count["admin"] == 1
assert notification_count["logist"] == 0  # –ù–µ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è
assert order.escalation_admin_notified_at is not None
```

### Test 3: –°–±—Ä–æ—Å –∏ –ø–æ–≤—Ç–æ—Ä–Ω–∞—è —ç—Å–∫–∞–ª–∞—Ü–∏—è
```python
# –ü–æ—Å–ª–µ –Ω–æ–≤–æ–≥–æ –æ—Ñ—Ñ–µ—Ä–∞:
assert order.dist_escalated_logist_at is None
assert order.escalation_logist_notified_at is None

# –ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è –∏ –Ω–æ–≤–æ–π —ç—Å–∫–∞–ª–∞—Ü–∏–∏:
assert notification_count["count"] == 1  # –ù–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
```

### Test 4: Race condition protection
```python
# –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Ç–∏–∫–∏:
tasks = [tick_once(cfg, bot=None, alerts_chat_id=None) for _ in range(5)]
await asyncio.gather(*tasks)

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
assert notification_count["count"] <= 1  # Advisory lock —Å—Ä–∞–±–æ—Ç–∞–ª
```

---

## ‚ö†Ô∏è TROUBLESHOOTING

### –û—à–∏–±–∫–∞: "Event loop is closed"
**–ü—Ä–∏—á–∏–Ω–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç `pool_size` –≤ engine  
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `pytest.ini`:
```ini
[pytest]
asyncio_mode = auto
```

### –û—à–∏–±–∫–∞: "UnicodeEncodeError"
**–ü—Ä–∏—á–∏–Ω–∞:** –≠–º–æ–¥–∑–∏ –≤ –≤—ã–≤–æ–¥–µ –Ω–∞ Windows  
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `$env:PYTHONIOENCODING='utf-8'`

### –û—à–∏–±–∫–∞: "TRUNCATE failed"
**–ü—Ä–∏—á–∏–Ω–∞:** –ï—Å—Ç—å foreign key constraints  
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback –Ω–∞ DELETE (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

### –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç –Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è = 0
**–ü—Ä–∏—á–∏–Ω–∞:** Advisory lock –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å–µ —Ç–∏–∫–∏  
**–†–µ—à–µ–Ω–∏–µ:** –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ! –¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `<= 1`

---

## üìà –ú–ï–¢–†–ò–ö–ò –ü–û–ö–†–´–¢–ò–Ø

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–∫—Ä—ã—Ç–∏–µ:

```powershell
pytest tests/test_e2e_escalation_notifications.py --cov=field_service.services.distribution_scheduler --cov-report=term-missing
```

**–¶–µ–ª–µ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ:**
- `_mark_logist_notification_sent()`: 100%
- `_mark_admin_notification_sent()`: 100%
- `_reset_escalations()`: 100%
- –õ–æ–≥–∏–∫–∞ –≤ `tick_once()`: 95%+

---

## üîÑ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤:

1. ‚úÖ **–ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞ staging –æ–∫—Ä—É–∂–µ–Ω–∏–∏**
2. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ** (–ø–µ—Ä–≤—ã–µ 24 —á–∞—Å–∞)
3. ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π**
4. ‚úÖ **–ü–µ—Ä–µ–π—Ç–∏ –∫ –≠—Ç–∞–ø—É 2** (–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è)

---

## üìù NOTES

- –í—Å–µ —Ç–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `datetime.now(timezone.utc)` (–Ω–µ `utcnow()`)
- Mock'–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –ö–∞–∂–¥—ã–π —Ç–µ—Å—Ç –æ—á–∏—â–∞–µ—Ç –ë–î —á–µ—Ä–µ–∑ —Ñ–∏–∫—Å—Ç—É—Ä—É `clean_db`
- –¢–µ—Å—Ç—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã –∏ –º–æ–≥—É—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –≤ –ª—é–±–æ–º –ø–æ—Ä—è–¥–∫–µ

---

**–ê–≤—Ç–æ—Ä:** Field Service Development Team  
**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2025-10-05
