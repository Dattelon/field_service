# BUGFIX: Реквизиты владельца для комиссий мастеров

**Дата:** 2025-10-10  
**Приоритет:** HIGH  
**Компоненты:** Admin Bot, Master Bot

## Проблема

1. **Редактирование реквизитов у админа не работало**
   - Битые символы в UI
   - Некорректные промпты для ввода значений
   - Непонятные сообщения об успехе/отмене

2. **Мастера не видели реквизиты**
   - Реквизиты показывались только по кнопке "Реквизиты"
   - Мастера не знали куда оплачивать комиссию

3. **Ненужная кнопка "Разослать мастерам"**
   - Функционал не использовался
   - Занимал место в UI

## Решение

### 1. Admin Bot - Исправление редактирования реквизитов

**Файл:** `field_service/bots/admin_bot/handlers/finance/main.py`

**Изменения:**
- Исправлены битые символы в меню редактирования реквизитов
- Улучшены промпты для ввода значений полей
- Улучшены сообщения об успехе/отмене операций
- Отключена функция рассылки реквизитов мастерам (теперь показывается сообщение об устаревшей функции)

**Файл:** `field_service/bots/admin_bot/ui/keyboards/finance.py`

**Изменения:**
- Удалена кнопка "Разослать мастерам" из клавиатуры реквизитов

### 2. Master Bot - Показ реквизитов в UI

**Файл:** `field_service/bots/master_bot/handlers/finance.py`

**Изменения:**

#### В карточке комиссии (`_render_commission_card`):
- Добавлено отображение реквизитов владельца прямо в карточке комиссии
- Реквизиты показываются для комиссий в статусах: WAIT_PAY, REPORTED, OVERDUE
- Если реквизиты не заполнены, показывается предупреждение с просьбой обратиться к администратору
- Кнопка "Показать QR-код СБП" добавляется только если QR-код есть
- Убрана отдельная кнопка "Реквизиты" (информация теперь в самой карточке)

#### В списке комиссий (`_render_commission_list`):
- Добавлено отображение реквизитов владельца в разделе "К оплате" (mode="aw")
- Реквизиты показываются один раз в начале списка (не повторяются для каждой комиссии)
- Добавлена инструкция: "Оплатите комиссию по указанным реквизитам и прикрепите чек в карточке комиссии"

## Тестирование

### Admin Bot

1. Войти в админ-бота как GLOBAL_ADMIN
2. Перейти в Финансы → Реквизиты владельца
3. Нажать "Редактировать"
4. Проверить, что:
   - Текст меню корректный (без битых символов)
   - Все поля редактируются
   - При вводе значений показываются понятные промпты
   - После сохранения показывается "✅ Значение сохранено"
   - Кнопки "Разослать мастерам" нет

### Master Bot

1. Войти в мастер-бота
2. Перейти в Финансы
3. В разделе "К оплате" проверить:
   - В начале списка показываются реквизиты владельца
   - Есть инструкция по оплате
4. Открыть любую комиссию в статусе "К оплате"
5. Проверить, что:
   - В карточке комиссии показываются реквизиты владельца
   - Если есть QR-код СБП, есть кнопка "Показать QR-код СБП"
   - Если реквизиты не заполнены, показывается предупреждение

## Файлы изменены

```
field_service/bots/admin_bot/handlers/finance/main.py
field_service/bots/admin_bot/ui/keyboards/finance.py
field_service/bots/master_bot/handlers/finance.py
```

## Deployment

```powershell
# 1. Скопировать изменённые файлы на сервер
scp field_service/bots/admin_bot/handlers/finance/main.py root@217.199.254.27:/opt/field-service/field_service/bots/admin_bot/handlers/finance/main.py
scp field_service/bots/admin_bot/ui/keyboards/finance.py root@217.199.254.27:/opt/field-service/field_service/bots/admin_bot/ui/keyboards/finance.py
scp field_service/bots/master_bot/handlers/finance.py root@217.199.254.27:/opt/field-service/field_service/bots/master_bot/handlers/finance.py

# 2. Перезапустить контейнеры
ssh root@217.199.254.27 "cd /opt/field-service && docker compose restart admin-bot master-bot"

# 3. Проверить логи
ssh root@217.199.254.27 "cd /opt/field-service && docker compose logs -f --tail=50 admin-bot master-bot"
```

## Статус

✅ **READY FOR DEPLOYMENT**

Все изменения реализованы и готовы к деплою на продакшн.
