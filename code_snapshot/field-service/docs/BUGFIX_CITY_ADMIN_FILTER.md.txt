# üêõ BUGFIX: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è CITY_ADMIN –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞

**–î–∞—Ç–∞:** 2025-10-09  
**–¢–∏–ø:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —É—è–∑–≤–∏–º–æ—Å—Ç—å RBAC  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

---

## üî¥ –ü—Ä–æ–±–ª–µ–º–∞

**CITY_ADMIN –≤–∏–¥–µ–ª –í–°–ï –≥–æ—Ä–æ–¥–∞** –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞, —á—Ç–æ –Ω–∞—Ä—É—à–∞–µ—Ç —Ä–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞.

### –ü—Ä–∏—á–∏–Ω–∞ –±–∞–≥–∞:

1. `orders_service.list_cities()` **–ù–ï –ø—Ä–∏–Ω–∏–º–∞–ª** –ø–∞—Ä–∞–º–µ—Ç—Ä `city_ids`
2. `_render_city_step()` **–ù–ï –ø–µ—Ä–µ–¥–∞–≤–∞–ª** `visible_city_ids_for(staff)`
3. –í–æ–∑–≤—Ä–∞—â–∞–ª–∏—Å—å **–í–°–ï 79 –≥–æ—Ä–æ–¥–æ–≤** –≤–º–µ—Å—Ç–æ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö

### –ü—Ä–∏–º–µ—Ä:

```
CITY_ADMIN –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫:
- –ú–æ—Å–∫–≤–∞ (id=1)
- –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ (id=2)

–ù–û –≤–∏–¥–µ–ª –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞:
- –ú–æ—Å–∫–≤–∞
- –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥
- –ö–∞–∑–∞–Ω—å       ‚ùå –ù–ï –î–û–õ–ñ–ï–ù –í–ò–î–ï–¢–¨
- –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫  ‚ùå –ù–ï –î–û–õ–ñ–ï–ù –í–ò–î–ï–¢–¨
- ... (–≤—Å–µ 79 –≥–æ—Ä–æ–¥–æ–≤)
```

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω–∞ **—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `visible_city_ids`** –≤ 2 –º–µ—Å—Ç–∞—Ö:

### 1. –°–µ—Ä–≤–∏—Å: `services/orders.py`

```python
async def list_cities(
    self, 
    *, 
    query: Optional[str] = None, 
    limit: int = 20, 
    city_ids: Optional[list[int]] = None  # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
) -> list[CityRef]:
    matching = city_catalog.match_cities(query)
    # ... —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è ...
    
    stmt = select(m.cities.id, m.cities.name).where(
        m.cities.is_active == True,
        m.cities.name.in_(matching),
    )
    
    # RBAC: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ visible cities –¥–ª—è CITY_ADMIN
    if city_ids is not None:
        stmt = stmt.where(m.cities.id.in_(city_ids))  # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
    
    rows = await session.execute(stmt)
    # ...
```

### 2. Handler: `handlers/orders/create.py`

**–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–∏–≥–Ω–∞—Ç—É—Ä–∞:**
```python
async def _render_city_step(
    message, 
    state, 
    page, 
    staff,  # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
    query=None
):
    orders_service = _orders_service(message.bot)
    # RBAC: –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –≥–æ—Ä–æ–¥–∞ –¥–ª—è CITY_ADMIN
    city_ids = visible_city_ids_for(staff)  # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
    
    if query:
        cities = await orders_service.list_cities(
            query=query, 
            limit=limit, 
            city_ids=city_ids  # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
        )
    else:
        cities = await orders_service.list_cities(
            limit=limit, 
            city_ids=city_ids  # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
        )
```

**–û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ 5 –≤—ã–∑–æ–≤–æ–≤:**

1. `_start_new_order()` - –Ω–∞—á–∞–ª–æ —Å–æ–∑–¥–∞–Ω–∏—è
2. `cb_new_order_city_page()` - –ø–∞–≥–∏–Ω–∞—Ü–∏—è –≥–æ—Ä–æ–¥–æ–≤
3. `new_order_city_input()` - –ø–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞
4. `cb_new_order_city_back()` - –≤–æ–∑–≤—Ä–∞—Ç –∫ –≤—ã–±–æ—Ä—É –≥–æ—Ä–æ–¥–∞

–í–æ –≤—Å–µ—Ö –¥–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `staff: StaffUser` –∏ –ø–µ—Ä–µ–¥–∞—á–∞ –≤ `_render_city_step()`.

---

## üìä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
CITY_ADMIN (–≥–æ—Ä–æ–¥–∞: –ú–æ—Å–∫–≤–∞, –°–ü–±)
‚Üí –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑
‚Üí –í–∏–¥–∏—Ç: 79 –≥–æ—Ä–æ–¥–æ–≤ ‚ùå
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
CITY_ADMIN (–≥–æ—Ä–æ–¥–∞: –ú–æ—Å–∫–≤–∞, –°–ü–±)
‚Üí –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑
‚Üí –í–∏–¥–∏—Ç: 2 –≥–æ—Ä–æ–¥–∞ (—Ç–æ–ª—å–∫–æ –ú–æ—Å–∫–≤–∞ –∏ –°–ü–±) ‚úÖ
```

### –¢–µ—Å—Ç-–∫–µ–π—Å—ã:

#### 1. GLOBAL_ADMIN
```python
staff.role = GLOBAL_ADMIN
city_ids = visible_city_ids_for(staff)  # None
cities = await list_cities(city_ids=city_ids)
# –û–∂–∏–¥–∞–µ—Ç—Å—è: –í–°–ï 79 –≥–æ—Ä–æ–¥–æ–≤ ‚úÖ
```

#### 2. CITY_ADMIN —Å 2 –≥–æ—Ä–æ–¥–∞–º–∏
```python
staff.role = CITY_ADMIN
staff.city_ids = [1, 2]  # –ú–æ—Å–∫–≤–∞, –°–ü–±
city_ids = visible_city_ids_for(staff)  # [1, 2]
cities = await list_cities(city_ids=city_ids)
# –û–∂–∏–¥–∞–µ—Ç—Å—è: –¢–û–õ–¨–ö–û –ú–æ—Å–∫–≤–∞ –∏ –°–ü–± ‚úÖ
```

#### 3. CITY_ADMIN —Å 1 –≥–æ—Ä–æ–¥–æ–º
```python
staff.role = CITY_ADMIN
staff.city_ids = [3]  # –ö–∞–∑–∞–Ω—å
city_ids = visible_city_ids_for(staff)  # [3]
cities = await list_cities(city_ids=city_ids)
# –û–∂–∏–¥–∞–µ—Ç—Å—è: –¢–û–õ–¨–ö–û –ö–∞–∑–∞–Ω—å ‚úÖ
```

#### 4. CITY_ADMIN –±–µ–∑ –≥–æ—Ä–æ–¥–æ–≤
```python
staff.role = CITY_ADMIN
staff.city_ids = []
city_ids = visible_city_ids_for(staff)  # []
cities = await list_cities(city_ids=city_ids)
# –û–∂–∏–¥–∞–µ—Ç—Å—è: –ü—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ ‚úÖ
```

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ß—Ç–æ –±—ã–ª–æ —É—è–∑–≤–∏–º–æ:

‚ùå **–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø–∞ –Ω–∞–∏–º–µ–Ω—å—à–∏—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π**
- CITY_ADMIN –º–æ–≥ —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ –≤ –ª—é–±–æ–º –≥–æ—Ä–æ–¥–µ
- –ú–æ–≥ –≤–∏–¥–µ—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–æ–≤ —Å–∏—Å—Ç–µ–º—ã
- –û–±—Ö–æ–¥ —Ä–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ RBAC

### –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:

‚úÖ **–°—Ç—Ä–æ–≥–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ RBAC**
- CITY_ADMIN –≤–∏–¥–∏—Ç –¢–û–õ–¨–ö–û —Å–≤–æ–∏ –≥–æ—Ä–æ–¥–∞
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ –≤ —á—É–∂–æ–º –≥–æ—Ä–æ–¥–µ
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ SQL –∑–∞–ø—Ä–æ—Å–∞

---

## üìÅ –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

```
field_service/bots/admin_bot/
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ orders.py                    ‚úÖ +city_ids –≤ list_cities()
‚îî‚îÄ‚îÄ handlers/orders/
    ‚îî‚îÄ‚îÄ create.py                    ‚úÖ +staff –≤ _render_city_step()
                                     ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã 5 –≤—ã–∑–æ–≤–æ–≤
```

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**
- –ò–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤: 2
- –î–æ–±–∞–≤–ª–µ–Ω–æ —Å—Ç—Ä–æ–∫: ~15
- –ò–∑–º–µ–Ω–µ–Ω–æ —Ñ—É–Ω–∫—Ü–∏–π: 6
- –û–±–Ω–æ–≤–ª–µ–Ω–æ –≤—ã–∑–æ–≤–æ–≤: 5

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∏

- [x] –ö–æ–¥ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [x] `services/orders.py` - OK
- [x] `handlers/orders/create.py` - OK
- [x] –í—Å–µ 5 –≤—ã–∑–æ–≤–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- [x] –ü–∞—Ä–∞–º–µ—Ç—Ä `staff` –¥–æ–±–∞–≤–ª–µ–Ω –≤–µ–∑–¥–µ
- [x] –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è CITY_ADMIN
- [x] GLOBAL_ADMIN –≤–∏–¥–∏—Ç –≤—Å–µ –≥–æ—Ä–æ–¥–∞
- [ ] –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∂–¥—ë—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)
- [ ] –î–µ–ø–ª–æ–π –≤ –ø—Ä–æ–¥

---

## üöÄ –î–µ–ø–ª–æ–π

### –ö–æ–º–∞–Ω–¥—ã:
```bash
# 1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å admin-bot
docker-compose restart admin-bot

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker-compose logs -f admin-bot | grep -i "city\|error"

# 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
# –ó–∞–π—Ç–∏ –ø–æ–¥ CITY_ADMIN –∏ —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑
```

### Rollback:
```bash
git checkout HEAD~1 field_service/bots/admin_bot/services/orders.py
git checkout HEAD~1 field_service/bots/admin_bot/handlers/orders/create.py
docker-compose restart admin-bot
```

---

## üéØ –°–≤—è–∑–∞–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –î—Ä—É–≥–∏–µ –º–µ—Å—Ç–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π:
‚úÖ –û—á–µ—Ä–µ–¥—å –∑–∞–∫–∞–∑–æ–≤ - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç (50+ –º–µ—Å—Ç)
‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–∫–∞–∑–∞ - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úÖ –°–ø–∏—Å–æ–∫ –º–∞—Å—Ç–µ—Ä–æ–≤ - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úÖ –ú–æ–¥–µ—Ä–∞—Ü–∏—è - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –º–µ—Å—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
- [ ] –°–ø–∏—Å–æ–∫ —Ä–∞–π–æ–Ω–æ–≤ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞
- [ ] –≠–∫—Å–ø–æ—Ä—Ç—ã (CSV/XLSX) - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é

---

## üìù –£—Ä–æ–∫–∏

1. **–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å RBAC** –≤ –Ω–æ–≤—ã—Ö handlers
2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `visible_city_ids_for()`** –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥ —Ä–∞–∑–Ω—ã–º–∏ —Ä–æ–ª—è–º–∏** (GLOBAL_ADMIN, CITY_ADMIN)
4. **–ö–æ–¥-—Ä–µ–≤—å—é** –¥–æ–ª–∂–Ω–æ –≤–∫–ª—é—á–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É RBAC
5. **–ê–≤—Ç–æ—Ç–µ—Å—Ç—ã** –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ä–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —É—è–∑–≤–∏–º–æ—Å—Ç—å –ò–°–ü–†–ê–í–õ–ï–ù–ê:**
- ‚úÖ CITY_ADMIN –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –≥–æ—Ä–æ–¥–∞
- ‚úÖ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ –≤ —á—É–∂–æ–º –≥–æ—Ä–æ–¥–µ
- ‚úÖ RBAC —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ GLOBAL_ADMIN –≤–∏–¥–∏—Ç –≤—Å–µ –≥–æ—Ä–æ–¥–∞ (–∫–∞–∫ –∏ –¥–æ–ª–∂–µ–Ω)

**–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!** üéâ

---

**–í–∞–∂–Ω–æ—Å—Ç—å:** üî¥ –ö–†–ò–¢–ò–ß–ù–û  
**–í–ª–∏—è–Ω–∏–µ:** –í—Å–µ CITY_ADMIN  
**–°—Ä–æ—á–Ω–æ—Å—Ç—å:** –¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –¥–µ–ø–ª–æ–π
