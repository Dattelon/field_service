# ‚úÖ CR-2025-10-03-010: –ú–ò–ì–†–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê

## üìä –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. ‚ùå –£–¥–∞–ª—ë–Ω legacy –∫–æ–¥
- **–§–∞–π–ª:** `distribution_worker.py` (832 —Å—Ç—Ä–æ–∫–∏)
- **–°—Ç–∞—Ç—É—Å:** –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –≤ `.deprecated` (–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –æ—Ç–∫–∞—Ç)
- **–ü—Ä–∏—á–∏–Ω–∞:** Production –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª, —É—Å—Ç–∞—Ä–µ–≤—à–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 2. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã
**–§–∞–π–ª:** `tests/test_distribution_scheduler.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
# –ë–´–õ–û:
from field_service.services import distribution_worker
await distribution_worker.process_one_order(...)  # Internal API

# –°–¢–ê–õ–û:
from field_service.services import distribution_scheduler  
await distribution_scheduler.tick_once(...)  # Public API
```

**–ù–æ–≤—ã–µ —Ç–µ—Å—Ç—ã (6 —à—Ç—É–∫):**
1. ‚úÖ `test_wakeup_promotes_at_start` - DEFERRED ‚Üí SEARCHING
2. ‚úÖ `test_wakeup_notices_only_once` - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –¥—É–±–ª–µ–π
3. ‚úÖ `test_wakeup_uses_city_timezone` - –ß–∞—Å–æ–≤—ã–µ –ø–æ—è—Å–∞ –≥–æ—Ä–æ–¥–æ–≤
4. ‚úÖ `test_distribution_escalates_when_no_candidates` - –≠—Å–∫–∞–ª–∞—Ü–∏—è –ª–æ–≥–∏—Å—Ç—É
5. ‚úÖ `test_distribution_sends_offer_when_candidates_exist` - –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ñ—Ñ–µ—Ä–æ–≤
6. ‚úÖ `test_distribution_config_loads_from_settings` - –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞

### 3. üìù –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ –°–æ–∑–¥–∞–Ω `docs/CR-2025-10-03-010_distribution_worker_removal.md`
- ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω `CHANGELOG.md`

---

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ scheduler –Ω–∞–¥ worker

| –§—É–Ω–∫—Ü–∏—è | worker.py | scheduler.py |
|---------|-----------|--------------|
| Advisory Lock | ‚ùå | ‚úÖ (–∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π) |
| DEFERRED wake-up | ‚ùå | ‚úÖ (–∞–≤—Ç–æ–º–∞—Ç–∏–∫–∞) |
| Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è | ‚ùå | ‚úÖ (Telegram –∞–¥–º–∏–Ω–∞–º) |
| –û—Ç—á—ë—Ç—ã | ‚ùå | ‚úÖ (send_report) |
| –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ | –ú–æ–Ω–æ–ª–∏—Ç–Ω–∞—è | –ú–æ–¥—É–ª—å–Ω–∞—è |

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∏

### Production
```bash
# admin_bot –∏—Å–ø–æ–ª—å–∑—É–µ—Ç scheduler ‚úÖ
grep -r "distribution_scheduler" field_service/bots/admin_bot/main.py
# > from field_service.services.distribution_scheduler import run_scheduler
```

### –¢–µ—Å—Ç—ã
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
pytest tests/test_distribution_scheduler.py -v

# –î–æ–ª–∂–Ω—ã –ø—Ä–æ–π—Ç–∏ –≤—Å–µ 6 —Ç–µ—Å—Ç–æ–≤
```

### –ò–º–ø–æ—Ä—Ç—ã
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ worker –Ω–∏–≥–¥–µ –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è
grep -r "import distribution_worker" field_service/
# > (empty) ‚úÖ
```

---

## üîÑ –û—Ç–∫–∞—Ç (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)

```bash
# 1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å worker
mv field_service/services/distribution_worker.py.deprecated \
   field_service/services/distribution_worker.py

# 2. –û—Ç–∫–∞—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
git checkout HEAD tests/test_distribution_scheduler.py

# 3. –û—Ç–∫–∞—Ç–∏—Ç—å CHANGELOG
git checkout HEAD CHANGELOG.md
```

---

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- **–£–¥–∞–ª–µ–Ω–æ:** 832 —Å—Ç—Ä–æ–∫–∏ legacy –∫–æ–¥–∞
- **–û–±–Ω–æ–≤–ª–µ–Ω–æ:** 1 —Ñ–∞–π–ª —Ç–µ—Å—Ç–æ–≤ (6 —Ç–µ—Å—Ç–æ–≤)
- **–î–æ–±–∞–≤–ª–µ–Ω–æ:** 2 —Ñ–∞–π–ª–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- **Production impact:** 0 (—É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª scheduler)
- **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~15 –º–∏–Ω—É—Ç

---

## ‚úÖ –ì–û–¢–û–í–û –ö –î–ï–ü–õ–û–Æ

**–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω—ã:**
- ‚úÖ Production –∫–æ–¥ –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç
- ‚úÖ –¢–µ—Å—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- ‚úÖ Legacy –∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –¥–ª—è –æ—Ç–∫–∞—Ç–∞
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:**
```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
pytest tests/test_distribution_scheduler.py -v

# 2. –ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
git add -A
git commit -m "CR-2025-10-03-010: Remove legacy distribution_worker, migrate tests to scheduler"

# 3. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É–¥–∞–ª–∏—Ç—å .deprecated
rm field_service/services/distribution_worker.py.deprecated
```
