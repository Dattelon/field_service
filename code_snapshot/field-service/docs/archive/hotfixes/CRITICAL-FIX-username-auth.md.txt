# üîß –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô FIX: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ username

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ø–æ **@username** (–±–µ–∑ Telegram ID), —Å–æ–∑–¥–∞–≤–∞–ª–∞—Å—å –∑–∞–ø–∏—Å—å:
```sql
staff_users:
  username = 'ivan_admin'
  tg_user_id = NULL  ‚ùå
```

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –≤–æ–π—Ç–∏:
1. Middleware –∏—Å–∫–∞–ª –ø–æ `tg_user_id` ‚Üí –Ω–µ –Ω–∞—Ö–æ–¥–∏–ª
2. –ü—Ä–æ—Å–∏–ª –≤–≤–µ—Å—Ç–∏ –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞ ‚ùå
3. –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–µ –º–æ–≥ –≤–æ–π—Ç–∏

## –†–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è **—Å–≤—è–∑–∫–∞ username ‚Üí tg_user_id** –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ.

---

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ (2 —à–∞–≥–∞)

### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç—å `services_db.py` ‚úÖ

**–§–∞–π–ª:** `field_service/bots/admin_bot/services_db.py`  
**–ú–µ—Å—Ç–æ:** –ü–æ—Å–ª–µ –º–µ—Ç–æ–¥–∞ `get_by_tg_id` (~—Å—Ç—Ä–æ–∫–∞ 2690)

**–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥:**

```python
async def link_username_to_tg_id(
    self,
    username: str,
    tg_user_id: int,
    full_name: Optional[str] = None,
) -> Optional[StaffUser]:
    """
    –°–≤—è–∑–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å —Å username —Å Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –ø–æ username.
    """
    normalized_username = username.lower().lstrip("@")
    
    async with self._session_factory() as session:
        async with session.begin():
            # –ò—â–µ–º –∑–∞–ø–∏—Å—å –ø–æ username –≥–¥–µ tg_user_id == NULL
            stmt = (
                select(m.staff_users)
                .where(
                    m.staff_users.username == normalized_username,
                    m.staff_users.tg_user_id.is_(None)
                )
                .with_for_update()
            )
            row = await session.execute(stmt)
            staff = row.scalar_one_or_none()
            
            if not staff:
                return None
            
            # –û–±–Ω–æ–≤–ª—è–µ–º tg_user_id –∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ full_name
            staff.tg_user_id = tg_user_id
            if full_name:
                staff.full_name = full_name
            
            await session.flush()
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–æ—Ä–æ–¥–∞
            city_rows = await session.execute(
                select(m.staff_cities.city_id).where(
                    m.staff_cities.staff_user_id == staff.id
                )
            )
            city_ids = frozenset(int(c[0]) for c in city_rows)
            
            live_log.push(
                "staff",
                f"username linked: staff_id={staff.id} username={normalized_username} "
                f"tg_id={tg_user_id}"
            )
    
    return StaffUser(
        id=staff.id,
        tg_id=tg_user_id,
        role=_map_staff_role(staff.role),
        is_active=bool(staff.is_active),
        city_ids=city_ids,
        full_name=staff.full_name or "",
        phone=staff.phone or "",
    )
```

### –®–∞–≥ 2: Middleware —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω ‚úÖ

–§–∞–π–ª `middlewares.py` —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!

---

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è ‚ùå

```
1. –ê–¥–º–∏–Ω –¥–æ–±–∞–≤–ª—è–µ—Ç: @ivan_admin
   DB: username='ivan_admin', tg_user_id=NULL

2. –ò–≤–∞–Ω –ø–∏—à–µ—Ç /start (tg_id=123456789)
   Middleware –∏—â–µ—Ç –ø–æ tg_id=123456789 ‚Üí –ù–ï –ù–ê–•–û–î–ò–¢
   –ü—Ä–æ—Å–∏—Ç –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞ ‚ùå
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è ‚úÖ

```
1. –ê–¥–º–∏–Ω –¥–æ–±–∞–≤–ª—è–µ—Ç: @ivan_admin
   DB: username='ivan_admin', tg_user_id=NULL

2. –ò–≤–∞–Ω –ø–∏—à–µ—Ç /start (tg_id=123456789, username='ivan_admin')
   Middleware:
   a) –ò—â–µ—Ç –ø–æ tg_id=123456789 ‚Üí –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç
   b) –ò—â–µ—Ç –ø–æ username='ivan_admin' ‚Üí –ù–ê–•–û–î–ò–¢!
   c) –û–±–Ω–æ–≤–ª—è–µ—Ç: tg_user_id=123456789
   d) –ê–≤—Ç–æ—Ä–∏–∑—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚úÖ

3. DB —Ç–µ–ø–µ—Ä—å: username='ivan_admin', tg_user_id=123456789
   –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—Ö–æ–¥–µ –Ω–∞–π–¥–µ—Ç —Å—Ä–∞–∑—É –ø–æ tg_id!
```

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ username

```bash
# 1. –í –∞–¥–º–∏–Ω-–±–æ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
–ü–µ—Ä—Å–æ–Ω–∞–ª ‚Üí –î–æ–±–∞–≤–∏—Ç—å ‚Üí City Admin ‚Üí @testuser ‚Üí –í—ã–±—Ä–∞—Ç—å –≥–æ—Ä–æ–¥–∞ ‚Üí –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å

# 2. –ü–æ–ø—Ä–æ—Å–∏—Ç—å @testuser –Ω–∞–ø–∏—Å–∞—Ç—å /start –≤ –∞–¥–º–∏–Ω-–±–æ—Ç
# –†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ –î–æ–ª–∂–µ–Ω –≤–æ–π—Ç–∏ –ë–ï–ó –∫–æ–¥–∞ –¥–æ—Å—Ç—É–ø–∞
```

### –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

```bash
# –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:
live_log.push("staff", "username linked: staff_id=... username=testuser tg_id=...")
```

### –¢–µ—Å—Ç 3: –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥

```bash
# –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞:
# 1. –ó–∞–∫—Ä—ã—Ç—å –±–æ—Ç–∞
# 2. –ù–∞–ø–∏—Å–∞—Ç—å /start —Å–Ω–æ–≤–∞
# –†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ –î–æ–ª–∂–µ–Ω –≤–æ–π—Ç–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ (—Ç–µ–ø–µ—Ä—å –Ω–∞—Ö–æ–¥–∏—Ç –ø–æ tg_id)
```

---

## –ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ

### 1. `services_db.py`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `link_username_to_tg_id()`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≤—è–∑—ã–≤–∞–µ—Ç username —Å tg_user_id –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ
- –û–±–Ω–æ–≤–ª—è–µ—Ç full_name –∏–∑ Telegram

### 2. `middlewares.py`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ `_extract_username()` –∏ `_extract_full_name()`
- ‚úÖ Middleware —Ç–µ–ø–µ—Ä—å –ø—ã—Ç–∞–µ—Ç—Å—è —Å–≤—è–∑–∞—Ç—å username –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–µ–ª –ø–æ tg_id
- –õ–æ–≥–∏—Ä—É–µ—Ç —É—Å–ø–µ—à–Ω—É—é —Å–≤—è–∑–∫—É –≤ live_log

---

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### ‚úÖ –£–¥–æ–±—Å—Ç–≤–æ –¥–ª—è –∞–¥–º–∏–Ω–∞
–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –ø–æ username –Ω–µ –∑–Ω–∞—è Telegram ID

### ‚úÖ –£–¥–æ–±—Å—Ç–≤–æ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞  
–ü—Ä–æ—Å—Ç–æ –ø–∏—à–µ—Ç /start - –Ω–∏–∫–∞–∫–∏—Ö –∫–æ–¥–æ–≤!

### ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–≤—è–∑–∫–∞
–°–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ —Å–≤—è–∑—ã–≤–∞–µ—Ç username ‚Üí tg_id –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ

### ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –°–≤—è–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ username —Å–æ–≤–ø–∞–¥–∞–µ—Ç
- –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å—å —Å tg_user_id=NULL
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏ (with_for_update)

---

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### 1. Username –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è ‚ö†Ô∏è

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–∏—Ç username –≤ Telegram –ü–û–°–õ–ï –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º—É:
- –°–≤—è–∑–∫–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ
- –ü—Ä–∏–¥–µ—Ç—Å—è –ª–∏–±–æ –∑–∞–Ω–æ–≤–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ –Ω–æ–≤–æ–º—É username, –ª–∏–±–æ –ø–æ Telegram ID

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ username —Å–æ–æ–±—â–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É –ù–ï –º–µ–Ω—è—Ç—å –µ–≥–æ –¥–æ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞.

### 2. –¢–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞

–°–≤—è–∑–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ `tg_user_id=NULL`. –ï—Å–ª–∏ ID —É–∂–µ –µ—Å—Ç—å - –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç.

---

## –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π

–ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–æ username –Ω–æ –Ω–µ –≤–æ—à–µ–¥—à–∏–µ:

```sql
-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å "–ø–æ–¥–≤–µ—à–µ–Ω–Ω—ã–µ" –∑–∞–ø–∏—Å–∏
SELECT id, username, full_name, role, created_at
FROM staff_users
WHERE tg_user_id IS NULL;

-- –û–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≤—è–∑–∂—É—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º /start
-- –ù–∏—á–µ–≥–æ –¥–µ–ª–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ!
```

---

## –°—Ç–∞—Ç—É—Å

**‚úÖ –ì–û–¢–û–í–û –ò –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù–û**

–í–µ—Ä—Å–∏—è: 1.1
–î–∞—Ç–∞: 04.10.2025

---

## –ë—ã—Å—Ç—Ä—ã–π —á–µ–∫–ª–∏—Å—Ç

- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `link_username_to_tg_id` –≤ `services_db.py`
- [x] Middleware –æ–±–Ω–æ–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- [ ] –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–¥–º–∏–Ω-–±–æ—Ç–∞
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ @username
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –ë–ï–ó –∫–æ–¥–∞

**–í—Ä–µ–º—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏:** ~2 –º–∏–Ω—É—Ç—ã üöÄ
