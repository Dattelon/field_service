# P1-21: Commission Deadline Reminders - Summary

**–î–∞—Ç–∞**: 2025-10-09  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: P1 - –í—ã—Å–æ–∫–∏–π

---

## üìù –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ‚úÖ
- –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `commission_deadline_notifications`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å –≤ `field_service/db/models.py`
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `2025-10-09_create_commission_deadline_notifications.sql`

### 2. Watchdog ‚úÖ
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω `watchdog_commission_deadline_reminders()` –≤ `field_service/services/watchdogs.py`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏ –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞ 24—á, 6—á, 1—á –¥–æ –¥–µ–¥–ª–∞–π–Ω–∞

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚úÖ
- –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç –≤ `field_service/bots/admin_bot/main.py`
- –°–æ–∑–¥–∞–Ω –∏ –∑–∞–ø—É—â–µ–Ω task `deadline_reminders_task`
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ lifecycle –±–æ—Ç–∞ (cleanup)

### 4. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ‚úÖ
- `P1-21_DEADLINE_REMINDERS.md` - –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
- `P1-21_QUICKSTART.md` - –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
- `P1-21_SUMMARY.md` - —ç—Ç–æ—Ç —Ñ–∞–π–ª

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

**–ü—Ä–æ–±–ª–µ–º–∞**: –ú–∞—Å—Ç–µ—Ä–∞ –Ω–µ –∑–Ω–∞–ª–∏ –æ –¥–µ–¥–ª–∞–π–Ω–µ –∫–æ–º–∏—Å—Å–∏–∏ ‚Üí –ø—Ä–æ—Å—Ä–æ—á–∫–∏ ‚Üí –∞–≤—Ç–æ–±–ª–æ–∫  
**–†–µ—à–µ–Ω–∏–µ**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞ 24—á/6—á/1—á –¥–æ –¥–µ–¥–ª–∞–π–Ω–∞

**–§–æ—Ä–º–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**:
```
‚è∞/‚ö†Ô∏è/üî¥ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ–± –æ–ø–ª–∞—Ç–µ –∫–æ–º–∏—Å—Å–∏–∏

–î–æ –¥–µ–¥–ª–∞–π–Ω–∞ –æ–ø–ª–∞—Ç—ã –∫–æ–º–∏—Å—Å–∏–∏ –æ—Å—Ç–∞–ª–æ—Å—å [24 —á–∞—Å–∞/6 —á–∞—Å–æ–≤/1 —á–∞—Å]

üìã –ó–∞–∫–∞–∑ #123
üí∞ –°—É–º–º–∞: 1500.00‚ÇΩ

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–º–µ—Ç—å—Ç–µ –æ–ø–ª–∞—Ç—É –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —á–µ–∫ –≤ —Ä–∞–∑–¥–µ–ª–µ "–§–∏–Ω–∞–Ω—Å—ã".

‚ö†Ô∏è –ü—Ä–∏ –ø—Ä–æ—Å—Ä–æ—á–∫–µ –æ–ø–ª–∞—Ç—ã –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.
```

---

## üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –¢–∞–±–ª–∏—Ü–∞
```sql
CREATE TABLE commission_deadline_notifications (
    id SERIAL PRIMARY KEY,
    commission_id INTEGER NOT NULL REFERENCES commissions(id),
    hours_before SMALLINT NOT NULL CHECK (hours_before IN (1, 6, 24)),
    sent_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    UNIQUE (commission_id, hours_before)
);
```

### –õ–æ–≥–∏–∫–∞
1. –ö–∞–∂–¥—ã–µ 30 –º–∏–Ω ‚Üí –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ `WAIT_PAY` –∫–æ–º–∏—Å—Å–∏–∏
2. –î–ª—è –∫–∞–∂–¥–æ–π –≤—ã—á–∏—Å–ª–∏—Ç—å `hours_until_deadline`
3. –ï—Å–ª–∏ `hours_until <= threshold` –ò —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
4. –ó–∞–ø–∏—Å–∞—Ç—å –≤ `commission_deadline_notifications`

### –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π
- UNIQUE constraint –Ω–∞ `(commission_id, hours_before)`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∑–∞–ø–∏—Å–∏ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç
```sql
-- –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∫–æ–º–∏—Å—Å–∏—é —Å –¥–µ–¥–ª–∞–π–Ω–æ–º —á–µ—Ä–µ–∑ 1—á
INSERT INTO commissions (order_id, master_id, amount, status, deadline_at)
VALUES (123, 45, 1000.00, 'WAIT_PAY', NOW() + INTERVAL '1 hour 5 minutes');

-- –ü–æ–¥–æ–∂–¥–∞—Ç—å 30 –º–∏–Ω –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
SELECT * FROM commission_deadline_notifications WHERE commission_id = <id>;
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
```powershell
docker logs field-service-admin-bot-1 -f | Select-String "deadline_reminder"
```

---

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏

- ‚Üì –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∫–æ–º–∏—Å—Å–∏–π (-30%)
- ‚Üì –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≤—Ç–æ–±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –º–∞—Å—Ç–µ—Ä–æ–≤ (-50%)
- ‚Üë –ü—Ä–æ—Ü–µ–Ω—Ç —Å–≤–æ–µ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–ø–ª–∞—Ç (+20%)
- ‚Üë –£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç—å –º–∞—Å—Ç–µ—Ä–æ–≤

---

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

- [ ] –°–æ–∑–¥–∞—Ç—å unit-—Ç–µ—Å—Ç—ã –¥–ª—è watchdog
- [ ] –°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
- [ ] –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –º–∞—Å—Ç–µ—Ä–∞–º–∏
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (dashboard)
- [ ] A/B —Ç–µ—Å—Ç —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫

---

## üéØ –¶–µ–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã

‚úÖ **P1-21**: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –±–ª–∏–∑–æ—Å—Ç–∏ –¥–µ–¥–ª–∞–π–Ω–∞ –∫–æ–º–∏—Å—Å–∏–∏  
‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∞–≤—Ç–æ–±–ª–æ–∫–∏—Ä–æ–≤–æ–∫  
‚úÖ –£–ª—É—á—à–µ–Ω–∏–µ UX –¥–ª—è –º–∞—Å—Ç–µ—Ä–æ–≤  
‚úÖ –°–Ω–∏–∂–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Å–ø–æ—Ä–æ–≤

---

## üìÅ –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

```
field_service/
‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îî‚îÄ‚îÄ models.py                      [+34 lines]  # –ú–æ–¥–µ–ª—å commission_deadline_notifications
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ watchdogs.py                   [+180 lines] # watchdog_commission_deadline_reminders
‚îú‚îÄ‚îÄ bots/admin_bot/
‚îÇ   ‚îî‚îÄ‚îÄ main.py                        [+13 lines]  # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è watchdog
‚îú‚îÄ‚îÄ migrations/
‚îÇ   ‚îî‚îÄ‚îÄ 2025-10-09_create_commission_deadline_notifications.sql  # –ú–∏–≥—Ä–∞—Ü–∏—è
‚îî‚îÄ‚îÄ docs/
    ‚îú‚îÄ‚îÄ P1-21_DEADLINE_REMINDERS.md    [NEW]
    ‚îú‚îÄ‚îÄ P1-21_QUICKSTART.md            [NEW]
    ‚îî‚îÄ‚îÄ P1-21_SUMMARY.md               [NEW]
```

---

**–ò—Ç–æ–≥–æ**: ~230 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ + –º–∏–≥—Ä–∞—Ü–∏—è + –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è  
**–í—Ä–µ–º—è**: ~2 —á–∞—Å–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å**: –°—Ä–µ–¥–Ω—è—è  
**–†–∏—Å–∫–∏**: –ù–∏–∑–∫–∏–µ (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π)

---

‚úÖ **P1-21 –ó–ê–í–ï–†–®–ï–ù–û!** –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é.
