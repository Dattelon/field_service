# P1-21: Commission Deadline Reminders

**–î–∞—Ç–∞**: 2025-10-09  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: P1 - –í—ã—Å–æ–∫–∏–π  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

---

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏

–ú–∞—Å—Ç–µ—Ä–∞ –Ω–µ –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—Ä–∏–±–ª–∏–∂–∞—é—â–µ–º—Å—è –¥–µ–¥–ª–∞–π–Ω–µ –æ–ø–ª–∞—Ç—ã –∫–æ–º–∏—Å—Å–∏–∏, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –ø—Ä–æ—Å—Ä–æ—á–∫–∞–º –∏ –∞–≤—Ç–æ–±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –∞–∫–∫–∞—É–Ω—Ç–æ–≤.

### –ü—Ä–æ–±–ª–µ–º–∞
- –ú–∞—Å—Ç–µ—Ä —É–∑–Ω–∞—ë—Ç –æ –ø—Ä–æ—Å—Ä–æ—á–∫–µ –ø–æ—Å—Ç—Ñ–∞–∫—Ç—É–º, –∫–æ–≥–¥–∞ –∞–∫–∫–∞—É–Ω—Ç —É–∂–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
- –ù–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–ø–ª–∞—Ç–∏—Ç—å –∫–æ–º–∏—Å—Å–∏—é
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≥—Ä–∞–¥–∞—Ü–∏—è —Å—Ä–æ—á–Ω–æ—Å—Ç–∏ (—Å–µ–≥–æ–¥–Ω—è/–∑–∞–≤—Ç—Ä–∞/—á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é)

### –†–µ—à–µ–Ω–∏–µ
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞ **24 —á–∞—Å–∞**, **6 —á–∞—Å–æ–≤** –∏ **1 —á–∞—Å** –¥–æ –¥–µ–¥–ª–∞–π–Ω–∞.

---

## üéØ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

**–ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞**: `commission_deadline_notifications`

```sql
CREATE TABLE commission_deadline_notifications (
    id SERIAL PRIMARY KEY,
    commission_id INTEGER NOT NULL REFERENCES commissions(id) ON DELETE CASCADE,
    hours_before SMALLINT NOT NULL CHECK (hours_before IN (1, 6, 24)),
    sent_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    
    CONSTRAINT uq_commission_deadline_notifications__commission_hours 
        UNIQUE (commission_id, hours_before)
);
```

**–ò–Ω–¥–µ–∫—Å—ã**:
- `ix_commission_deadline_notifications__commission` - –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ –∫–æ–º–∏—Å—Å–∏–∏

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**:
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –¢—Ä–µ–∫–∏–Ω–≥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
- –ê—É–¥–∏—Ç —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

---

### 2. Watchdog

**–§–∞–π–ª**: `field_service/services/watchdogs.py`

**–§—É–Ω–∫—Ü–∏—è**: `watchdog_commission_deadline_reminders()`

**–ê–ª–≥–æ—Ä–∏—Ç–º**:
```python
1. –ö–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–º–∏—Å—Å–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º WAIT_PAY
2. –î–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–∏—Å—Å–∏–∏ –≤—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è –¥–æ –¥–µ–¥–ª–∞–π–Ω–∞
3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä–æ–≥–∏: 24—á, 6—á, 1—á
4. –ï—Å–ª–∏ –ø–æ—Ä–æ–≥ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ò —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –µ—â—ë –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–æ—Å—å:
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä—É
   - –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ commission_deadline_notifications
   - –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `interval_seconds=1800` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
- `iterations=None` - –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**:
- Try-catch –Ω–∞ –∫–∞–∂–¥—É—é –∏—Ç–µ—Ä–∞—Ü–∏—é
- –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–æ–±–ª–µ–º

---

### 3. –§–æ—Ä–º–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

#### –ó–∞ 24 —á–∞—Å–∞
```
‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ–± –æ–ø–ª–∞—Ç–µ –∫–æ–º–∏—Å—Å–∏–∏

–î–æ –¥–µ–¥–ª–∞–π–Ω–∞ –æ–ø–ª–∞—Ç—ã –∫–æ–º–∏—Å—Å–∏–∏ –æ—Å—Ç–∞–ª–æ—Å—å 24 —á–∞—Å–∞

üìã –ó–∞–∫–∞–∑ #123
üí∞ –°—É–º–º–∞: 1500.00‚ÇΩ

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–º–µ—Ç—å—Ç–µ –æ–ø–ª–∞—Ç—É –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —á–µ–∫ –≤ —Ä–∞–∑–¥–µ–ª–µ "–§–∏–Ω–∞–Ω—Å—ã".

‚ö†Ô∏è –ü—Ä–∏ –ø—Ä–æ—Å—Ä–æ—á–∫–µ –æ–ø–ª–∞—Ç—ã –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.
```

#### –ó–∞ 6 —á–∞—Å–æ–≤
```
‚ö†Ô∏è –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ–± –æ–ø–ª–∞—Ç–µ –∫–æ–º–∏—Å—Å–∏–∏

–î–æ –¥–µ–¥–ª–∞–π–Ω–∞ –æ–ø–ª–∞—Ç—ã –∫–æ–º–∏—Å—Å–∏–∏ –æ—Å—Ç–∞–ª–æ—Å—å 6 —á–∞—Å–æ–≤

üìã –ó–∞–∫–∞–∑ #123
üí∞ –°—É–º–º–∞: 1500.00‚ÇΩ

...
```

#### –ó–∞ 1 —á–∞—Å
```
üî¥ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ–± –æ–ø–ª–∞—Ç–µ –∫–æ–º–∏—Å—Å–∏–∏

–î–æ –¥–µ–¥–ª–∞–π–Ω–∞ –æ–ø–ª–∞—Ç—ã –∫–æ–º–∏—Å—Å–∏–∏ –æ—Å—Ç–∞–ª–æ—Å—å 1 —á–∞—Å

üìã –ó–∞–∫–∞–∑ #123
üí∞ –°—É–º–º–∞: 1500.00‚ÇΩ

...
```

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ú–æ–¥–µ–ª—å `commission_deadline_notifications`

**–ü–æ–ª—è**:
- `id` - PRIMARY KEY
- `commission_id` - FK –Ω–∞ commissions(id)
- `hours_before` - –ø–æ—Ä–æ–≥ (1, 6 –∏–ª–∏ 24)
- `sent_at` - –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**:
- UNIQUE –Ω–∞ (commission_id, hours_before) - –æ–¥–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ –ø–æ—Ä–æ–≥
- CHECK –Ω–∞ hours_before IN (1, 6, 24)

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ admin_bot

**–§–∞–π–ª**: `field_service/bots/admin_bot/main.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
1. –ò–º–ø–æ—Ä—Ç `watchdog_commission_deadline_reminders`
2. –°–æ–∑–¥–∞–Ω–∏–µ task `deadline_reminders_task`
3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ cleanup list

**–ó–∞–ø—É—Å–∫**:
```python
deadline_reminders_task = asyncio.create_task(
    watchdog_commission_deadline_reminders(
        bot,
        interval_seconds=1800,  # 30 –º–∏–Ω—É—Ç
    ),
    name="commission_deadline_reminders",
)
```

---

## üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### Live Log
```python
live_log.push(
    "watchdog",
    f"commission_deadline_reminders sent={notifications_sent}",
    level="INFO"
)
```

### Standard Logger
```python
logger.info(
    "commission_deadline_reminder sent: commission=%s master=%s hours=%s",
    commission.id,
    commission.master_id,
    hours_before
)
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞**:
1. –°–æ–∑–¥–∞—Ç—å –∫–æ–º–∏—Å—Å–∏—é —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º WAIT_PAY
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å deadline_at –Ω–∞ +1 —á–∞—Å –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å watchdog

**–ü—Ä–æ–≤–µ—Ä–∫–∞**:
```sql
-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–º–∏—Å—Å–∏–∏ –æ–∂–∏–¥–∞—é—â–∏–µ –æ–ø–ª–∞—Ç—É
SELECT id, order_id, master_id, deadline_at, status 
FROM commissions 
WHERE status = 'WAIT_PAY';

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
SELECT * FROM commission_deadline_notifications 
ORDER BY sent_at DESC;
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

TODO: –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç—ã –≤ `tests/services/test_watchdogs.py`

---

## üöÄ –î–µ–ø–ª–æ–π

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
```powershell
Get-Content migrations/2025-10-09_create_commission_deadline_notifications.sql | 
  docker exec -i field-service-postgres-1 psql -U fs_user -d field_service
```

### 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å admin-bot
```powershell
docker-compose restart admin-bot
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
```powershell
docker logs -f field-service-admin-bot-1 | grep "commission_deadline"
```

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏

### –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∑–∞ 24—á/6—á/1—á
- –ü—Ä–æ—Ü–µ–Ω—Ç –º–∞—Å—Ç–µ—Ä–æ–≤ –æ–ø–ª–∞—Ç–∏–≤—à–∏—Ö –ø–æ—Å–ª–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –°–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∫–æ–º–∏—Å—Å–∏–π
- –°–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∞–≤—Ç–æ–±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

### SQL –∑–∞–ø—Ä–æ—Å—ã
```sql
-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
SELECT 
    hours_before,
    COUNT(*) as total_sent,
    DATE(sent_at) as date
FROM commission_deadline_notifications
WHERE sent_at > NOW() - INTERVAL '7 days'
GROUP BY hours_before, DATE(sent_at)
ORDER BY date DESC, hours_before DESC;

-- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
SELECT 
    cdn.hours_before,
    COUNT(*) as total_sent,
    COUNT(CASE WHEN c.status IN ('REPORTED', 'APPROVED') THEN 1 END) as paid_count,
    ROUND(
        COUNT(CASE WHEN c.status IN ('REPORTED', 'APPROVED') THEN 1 END)::numeric / 
        COUNT(*)::numeric * 100, 
        2
    ) as payment_rate_pct
FROM commission_deadline_notifications cdn
JOIN commissions c ON c.id = cdn.commission_id
WHERE cdn.sent_at > NOW() - INTERVAL '30 days'
GROUP BY cdn.hours_before
ORDER BY cdn.hours_before DESC;
```

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

- [x] –°–æ–∑–¥–∞–Ω–∞ –º–æ–¥–µ–ª—å `commission_deadline_notifications`
- [x] –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –ë–î
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω watchdog `watchdog_commission_deadline_reminders`
- [x] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ admin_bot/main.py
- [x] –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [x] –ù–∞–ø–∏—Å–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] –°–æ–∑–¥–∞–Ω—ã unit-—Ç–µ—Å—Ç—ã
- [ ] –°–æ–∑–¥–∞–Ω—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
- [ ] –ü—Ä–æ–≤–µ–¥–µ–Ω–æ —Ä—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç—ã** –¥–ª—è watchdog'–∞
2. **–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏** –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ø—Ä—è–º–æ–π –ø–µ—Ä–µ—Ö–æ–¥ –≤ —Ñ–∏–Ω–∞–Ω—Å—ã)
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
4. **A/B —Ç–µ—Å—Ç** —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫
5. **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è** —Ç–µ–∫—Å—Ç–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

---

## üîç –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –ö–Ω–æ–ø–∫–∏ –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏
```python
keyboard = InlineKeyboardMarkup(inline_keyboard=[
    [
        InlineKeyboardButton(
            text="üí∞ –û—Ç–º–µ—Ç–∏—Ç—å –æ–ø–ª–∞—Ç—É",
            callback_data=f"m:fin:mark:{commission.id}"
        )
    ],
    [
        InlineKeyboardButton(
            text="üì∏ –ó–∞–≥—Ä—É–∑–∏—Ç—å —á–µ–∫",
            callback_data=f"m:fin:check:{commission.id}"
        )
    ],
])
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
–î–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –º–∞—Å—Ç–µ—Ä—É –æ—Ç–∫–ª—é—á–∏—Ç—å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:
```sql
CREATE TABLE master_notification_preferences (
    master_id INTEGER PRIMARY KEY,
    deadline_24h BOOLEAN DEFAULT TRUE,
    deadline_6h BOOLEAN DEFAULT TRUE,
    deadline_1h BOOLEAN DEFAULT TRUE
);
```

### Telegram Bot API Features
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **inline buttons** –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
- –î–æ–±–∞–≤–∏—Ç—å **deep linking** –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ä–∞–∑–¥–µ–ª –±–æ—Ç–∞
- **Silent notifications** –¥–ª—è 24—á, –æ–±—ã—á–Ω—ã–µ –¥–ª—è 6—á –∏ 1—á

---

**–ê–≤—Ç–æ—Ä**: Claude Sonnet 4.5  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 2025-10-09  
**–°—Ç–∞—Ç—É—Å**: –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
