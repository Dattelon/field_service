# ‚úÖ BUGFIX –ó–ê–í–ï–†–®–Å–ù: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è CITY_ADMIN

**–î–∞—Ç–∞:** 2025-10-09  
**–¢–∏–ø:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —É—è–∑–≤–∏–º–æ—Å—Ç—å RBAC  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û** (–≥–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é)

---

## üéØ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### üêõ –ù–∞–π–¥–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:

**CITY_ADMIN –≤–∏–¥–µ–ª –í–°–ï 79 –≥–æ—Ä–æ–¥–æ–≤** –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞, —á—Ç–æ –Ω–∞—Ä—É—à–∞–µ—Ç RBAC.

```
CITY_ADMIN —Å –¥–æ—Å—Ç—É–ø–æ–º –∫:
- –ú–æ—Å–∫–≤–∞
- –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥

–í–∏–¥–µ–ª –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞:
- –ú–æ—Å–∫–≤–∞ ‚úÖ
- –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ ‚úÖ
- –ö–∞–∑–∞–Ω—å ‚ùå –ù–ï –î–û–õ–ñ–ï–ù
- –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫ ‚ùå –ù–ï –î–û–õ–ñ–ï–ù
- ... –≤—Å–µ 79 –≥–æ—Ä–æ–¥–æ–≤ ‚ùå
```

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:

–î–æ–±–∞–≤–ª–µ–Ω–∞ **—Å—Ç—Ä–æ–≥–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è** –ø–æ `visible_city_ids_for(staff)`:

1. **–°–µ—Ä–≤–∏—Å** `services/orders.py`:
   - –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `city_ids: Optional[list[int]] = None`
   - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ SQL: `WHERE city_id IN (...)`

2. **Handler** `handlers/orders/create.py`:
   - –§—É–Ω–∫—Ü–∏—è `_render_city_step()` –ø–æ–ª—É—á–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä `staff`
   - –í—ã–∑—ã–≤–∞–µ—Ç `visible_city_ids_for(staff)`
   - –ü–µ—Ä–µ–¥–∞—ë—Ç `city_ids` –≤ `list_cities()`

3. **–û–±–Ω–æ–≤–ª–µ–Ω—ã 5 –≤—ã–∑–æ–≤–æ–≤:**
   - `_start_new_order()`
   - `cb_new_order_city_page()`
   - `new_order_city_input()`
   - `cb_new_order_city_back()`

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç

| –†–æ–ª—å | –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è | –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è |
|------|----------------|-------------------|
| GLOBAL_ADMIN | –í–∏–¥–∏—Ç 79 –≥–æ—Ä–æ–¥–æ–≤ ‚úÖ | –í–∏–¥–∏—Ç 79 –≥–æ—Ä–æ–¥–æ–≤ ‚úÖ |
| CITY_ADMIN (–ú–æ—Å–∫–≤–∞, –°–ü–±) | –í–∏–¥–∏—Ç 79 –≥–æ—Ä–æ–¥–æ–≤ ‚ùå | –í–∏–¥–∏—Ç 2 –≥–æ—Ä–æ–¥–∞ ‚úÖ |
| CITY_ADMIN (–ö–∞–∑–∞–Ω—å) | –í–∏–¥–∏—Ç 79 –≥–æ—Ä–æ–¥–æ–≤ ‚ùå | –í–∏–¥–∏—Ç 1 –≥–æ—Ä–æ–¥ ‚úÖ |
| CITY_ADMIN (–Ω–µ—Ç –≥–æ—Ä–æ–¥–æ–≤) | –í–∏–¥–∏—Ç 79 –≥–æ—Ä–æ–¥–æ–≤ ‚ùå | –í–∏–¥–∏—Ç 0 –≥–æ—Ä–æ–¥–æ–≤ ‚úÖ |

---

## üìÅ –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

```
field_service/bots/admin_bot/
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ orders.py                    ‚úÖ +city_ids —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
‚îî‚îÄ‚îÄ handlers/orders/
    ‚îî‚îÄ‚îÄ create.py                    ‚úÖ +staff –ø–∞—Ä–∞–º–µ—Ç—Ä, 5 –≤—ã–∑–æ–≤–æ–≤

docs/
‚îú‚îÄ‚îÄ BUGFIX_CITY_ADMIN_FILTER.md      ‚úÖ –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îî‚îÄ‚îÄ BUGFIX_CITY_ADMIN_QUICKSTART.md  ‚úÖ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

code_snapshot/
‚îî‚îÄ‚îÄ field-service/...                ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –æ–±–∞ —Ñ–∞–π–ª–∞
```

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**
- –ò–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤: 2
- –î–æ–±–∞–≤–ª–µ–Ω–æ —Å—Ç—Ä–æ–∫: ~15
- –û–±–Ω–æ–≤–ª–µ–Ω–æ —Ñ—É–Ω–∫—Ü–∏–π: 6
- –û–±–Ω–æ–≤–ª–µ–Ω–æ –≤—ã–∑–æ–≤–æ–≤: 5

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã

- [x] –ö–æ–¥ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [x] `services/orders.py` - OK
- [x] `handlers/orders/create.py` - OK
- [x] –í—Å–µ 5 –≤—ã–∑–æ–≤–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- [x] –ü–∞—Ä–∞–º–µ—Ç—Ä `staff` –¥–æ–±–∞–≤–ª–µ–Ω –≤–µ–∑–¥–µ
- [x] –ü–∞—Ä–∞–º–µ—Ç—Ä `city_ids` –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è
- [x] –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ SQL
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞
- [x] Code snapshot –æ–±–Ω–æ–≤–ª—ë–Ω
- [ ] –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∂–¥—ë—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)
- [ ] –î–µ–ø–ª–æ–π –≤ –ø—Ä–æ–¥

---

## üß™ –ü–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. –ë–∞–∑–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:

#### A. GLOBAL_ADMIN
```
–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ ‚Üí –í—ã–±—Ä–∞—Ç—å –≥–æ—Ä–æ–¥
‚úÖ –í–∏–¥–∏—Ç –≤—Å–µ 79 –≥–æ—Ä–æ–¥–æ–≤
```

#### B. CITY_ADMIN (2 –≥–æ—Ä–æ–¥–∞)
```
–°–æ–∑–¥–∞—Ç—å CITY_ADMIN —Å –ú–æ—Å–∫–≤–∞ + –°–ü–±
–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ ‚Üí –í—ã–±—Ä–∞—Ç—å –≥–æ—Ä–æ–¥
‚úÖ –í–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ 2 –≥–æ—Ä–æ–¥–∞
```

#### C. CITY_ADMIN (1 –≥–æ—Ä–æ–¥)
```
–°–æ–∑–¥–∞—Ç—å CITY_ADMIN —Å –ö–∞–∑–∞–Ω—å
–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ ‚Üí –í—ã–±—Ä–∞—Ç—å –≥–æ—Ä–æ–¥
‚úÖ –í–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ö–∞–∑–∞–Ω—å
```

#### D. CITY_ADMIN (0 –≥–æ—Ä–æ–¥–æ–≤)
```
–°–æ–∑–¥–∞—Ç—å CITY_ADMIN –±–µ–∑ –≥–æ—Ä–æ–¥–æ–≤
–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ ‚Üí –í—ã–±—Ä–∞—Ç—å –≥–æ—Ä–æ–¥
‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ "–ì–æ—Ä–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
```

### 2. –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:

- ‚úÖ –ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
- ‚úÖ –ü–∞–≥–∏–Ω–∞—Ü–∏—è –≥–æ—Ä–æ–¥–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
- ‚úÖ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ –≤ —á—É–∂–æ–º –≥–æ—Ä–æ–¥–µ

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ë—ã–ª–æ:
- ‚ùå CITY_ADMIN –º–æ–≥ –≤–∏–¥–µ—Ç—å –≤—Å–µ –≥–æ—Ä–æ–¥–∞
- ‚ùå –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –º–æ–≥ —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ –≤ —á—É–∂–æ–º –≥–æ—Ä–æ–¥–µ
- ‚ùå –û–±—Ö–æ–¥ RBAC

### –°—Ç–∞–ª–æ:
- ‚úÖ CITY_ADMIN –≤–∏–¥–∏—Ç –¢–û–õ–¨–ö–û —Å–≤–æ–∏ –≥–æ—Ä–æ–¥–∞
- ‚úÖ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —á—É–∂–æ–π –≥–æ—Ä–æ–¥
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ SQL
- ‚úÖ RBAC —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üöÄ –î–µ–ø–ª–æ–π

### –ö–æ–º–∞–Ω–¥—ã:
```bash
# 1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å admin-bot
docker-compose restart admin-bot

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker-compose logs -f admin-bot | grep -i "city\|error"

# 3. –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
# –ó–∞–π—Ç–∏ –ø–æ–¥ CITY_ADMIN –∏ —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑
```

### Rollback (–µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è):
```bash
git checkout HEAD~1 field_service/bots/admin_bot/services/orders.py
git checkout HEAD~1 field_service/bots/admin_bot/handlers/orders/create.py
docker-compose restart admin-bot
```

---

## üéâ –ò—Ç–æ–≥

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —É—è–∑–≤–∏–º–æ—Å—Ç—å RBAC –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞!**

### –î–æ:
```
CITY_ADMIN ‚Üí –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ ‚Üí –í–∏–¥–∏—Ç 79 –≥–æ—Ä–æ–¥–æ–≤ ‚ùå
```

### –ü–æ—Å–ª–µ:
```
CITY_ADMIN ‚Üí –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ ‚Üí –í–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –≥–æ—Ä–æ–¥–∞ ‚úÖ
```

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤ –ø–æ–∏—Å–∫–µ
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞–∑–∞–¥
- ‚úÖ –í—Å–µ –ø—É—Ç–∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è FSM

---

## üìù –°–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

**–ó–∞–≤–µ—Ä—à–µ–Ω–æ:**
- ‚úÖ P1-12: Progress bar –≤ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–µ
- ‚úÖ **BUGFIX: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è CITY_ADMIN**

**–°–ª–µ–¥—É—é—â–∏–µ –∑–∞–¥–∞—á–∏ P1:**
- P1-11: –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
- P1-16: –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –ø–µ—Ä–µ—Ä—ã–≤–µ
- P1-19: –ë—ã—Å—Ç—Ä–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- P1-21: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –¥–µ–¥–ª–∞–π–Ω–µ –∫–æ–º–∏—Å—Å–∏–∏

---

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~30 –º–∏–Ω—É—Ç  
**–í–∞–∂–Ω–æ—Å—Ç—å:** üî¥ –ö–†–ò–¢–ò–ß–ù–û  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–û–¢–û–í–û –ö –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥ CITY_ADMIN! üéØ
