# P1-13: –ö–Ω–æ–ø–∫–∞ "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ" –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ  
**–î–∞—Ç–∞:** 2025-10-09  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P1 (–í—ã—Å–æ–∫–∏–π)  
**–ó–∞–¥–∞—á–∞ –∏–∑:** ux_analysis_report.md

---

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –æ—à–∏–±–∫–µ (—Å–µ—Ç–µ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞, —Ç–∞–π–º–∞—É—Ç, –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–±–æ–π) –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –≤—Å—ë –∑–∞–Ω–æ–≤–æ  

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```
–ê–¥–º–∏–Ω –Ω–∞–∑–Ω–∞—á–∏–ª –º–∞—Å—Ç–µ—Ä–∞ ‚Üí –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ ‚Üí 
–ù—É–∂–Ω–æ –∑–∞–Ω–æ–≤–æ –∏—Å–∫–∞—Ç—å –∑–∞–∫–∞–∑ –∏ –º–∞—Å—Ç–µ—Ä–∞
```

**–†–µ—à–µ–Ω–∏–µ:** –°–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏ –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É:
```
‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ
[üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å] [‚ùå –û—Ç–º–µ–Ω–∏—Ç—å]
```

---

## üéØ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. **RetryContext** (`field_service/bots/common/retry_context.py`)

–ö–ª–∞—Å—Å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–≤—Ç–æ—Ä–∞ –¥–µ–π—Å—Ç–≤–∏—è:

```python
@dataclass
class RetryContext:
    """–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞ –¥–µ–π—Å—Ç–≤–∏—è"""
    callback_data: str      # –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π callback –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞
    timestamp: datetime     # –í—Ä–µ–º—è –æ—à–∏–±–∫–∏
    attempt: int            # –ù–æ–º–µ—Ä –ø–æ–ø—ã—Ç–∫–∏ (1, 2, 3)
    user_id: int           # ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    chat_id: int           # ID —á–∞—Ç–∞
    message_id: int        # ID —Å–æ–æ–±—â–µ–Ω–∏—è
    
    MAX_ATTEMPTS = 3       # –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏
```

**–§—É–Ω–∫—Ü–∏–∏:**
- `save_retry_context()` - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ FSM state
- `load_retry_context()` - –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ FSM state
- `clear_retry_context()` - –æ—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç

### 2. **RetryMiddleware** (`field_service/bots/common/retry_middleware.py`)

Middleware –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –æ—à–∏–±–∫–∏ –≤ callback handlers:

```python
class RetryMiddleware(BaseMiddleware):
    """
    –ü—Ä–∏ –æ—à–∏–±–∫–µ –≤ handler:
    1. –õ–æ–≥–∏—Ä—É–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
    2. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ FSM
    3. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç UI —Å –∫–Ω–æ–ø–∫–∞–º–∏ "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å" –∏ "–û—Ç–º–µ–Ω–∏—Ç—å"
    """
```

**–†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å CallbackQuery** - –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–æ–∫

**UI –ø—Ä–∏ –æ—à–∏–±–∫–µ:**
```
‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ

–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
‚Ä¢ –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é
‚Ä¢ –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è
‚Ä¢ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

–í—ã –º–æ–∂–µ—Ç–µ:
[üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å] [‚ùå –û—Ç–º–µ–Ω–∏—Ç—å]
```

### 3. **Retry Handlers** (`field_service/bots/common/retry_handler.py`)

Handlers –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–Ω–æ–ø–æ–∫ retry:

#### `retry:execute` - –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ
```python
@retry_router.callback_query(F.data == "retry:execute")
async def retry_execute(callback: CallbackQuery, state: FSMContext):
    """
    1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
    2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫ (MAX_ATTEMPTS = 3)
    3. –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫ attempt
    4. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π callback_data
    5. –ü–æ–≤—Ç–æ—Ä—è–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ —á–µ—Ä–µ–∑ dispatcher
    6. –ü—Ä–∏ —É—Å–ø–µ—Ö–µ - –æ—á–∏—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç
    7. –ü—Ä–∏ –æ—à–∏–±–∫–µ - middleware —Å–Ω–æ–≤–∞ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç
    """
```

#### `retry:cancel` - –û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–≤—Ç–æ—Ä
```python
@retry_router.callback_query(F.data == "retry:cancel")
async def retry_cancel(callback: CallbackQuery, state: FSMContext):
    """
    1. –û—á–∏—â–∞–µ—Ç retry_context –∏–∑ FSM
    2. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç "‚úÖ –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ"
    """
```

---

## üîå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### Master Bot

–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `field_service/bots/master_bot/main.py`:

```python
# –ò–º–ø–æ—Ä—Ç—ã
from field_service.bots.common.retry_handler import retry_router  # P1-13
from field_service.bots.common.retry_middleware import setup_retry_middleware  # P1-13

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ router
dp.include_router(master_router)
dp.include_router(retry_router)  # P1-13

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ middleware
setup_error_middleware(...)
setup_retry_middleware(dp, enabled=True)  # P1-13
```

### Admin Bot

–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `field_service/bots/admin_bot/main.py`:

```python
# –ò–º–ø–æ—Ä—Ç—ã —É–∂–µ –±—ã–ª–∏, –¥–æ–±–∞–≤–ª–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ router
dp.include_router(create_combined_router())
dp.include_router(retry_router)  # P1-13

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ middleware
setup_error_middleware(...)
setup_retry_middleware(dp, enabled=True)  # P1-13
```

---

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   User –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ
              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   RetryMiddleware –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç                 ‚îÇ
‚îÇ   –æ—à–∏–±–∫–∏ –≤ callback handlers                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ                   ‚îÇ
    ‚ñº                   ‚ñº
  SUCCESS             ERROR
    ‚îÇ                   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫       ‚îÇ
                        ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ Save RetryContext   ‚îÇ
              ‚îÇ –≤ FSM state:        ‚îÇ
              ‚îÇ - callback_data     ‚îÇ
              ‚îÇ - attempt = 1       ‚îÇ
              ‚îÇ - user_id, chat_id  ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ Show error UI:      ‚îÇ
              ‚îÇ [üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å]      ‚îÇ
              ‚îÇ [‚ùå –û—Ç–º–µ–Ω–∏—Ç—å]       ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ         ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚ñº                                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ retry:execute ‚îÇ                ‚îÇ retry:cancel ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                               ‚îÇ
        ‚ñº                               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Load context  ‚îÇ                ‚îÇ Clear context‚îÇ
‚îÇ Check attempts‚îÇ                ‚îÇ Show "‚úÖ"    ‚îÇ
‚îÇ Increment     ‚îÇ                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ Restore data  ‚îÇ
‚îÇ Repeat action ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ
        ‚ñº
  [–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è]
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª —Ç–µ—Å—Ç–æ–≤: `tests/test_retry_action.py`

**–ü–æ–∫—Ä—ã—Ç–∏–µ:**

1. **RetryContext:**
   - ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –ø–æ–ø—ã—Ç–æ–∫ (MAX_ATTEMPTS)
   - ‚úÖ –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
   - ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞ –≤ FSM
   - ‚úÖ –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

2. **RetryMiddleware:**
   - ‚úÖ –†–∞–±–æ—Ç–∞ –ø—Ä–∏ enabled=False (–Ω–µ –≤–º–µ—à–∏–≤–∞–µ—Ç—Å—è)
   - ‚úÖ –ü–µ—Ä–µ—Ö–≤–∞—Ç –æ—à–∏–±–æ–∫ –ø—Ä–∏ enabled=True
   - ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
   - ‚úÖ –ü–æ–∫–∞–∑ error UI —Å –∫–Ω–æ–ø–∫–∞–º–∏

3. **Retry Handlers:**
   - ‚úÖ retry:execute –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
   - ‚úÖ retry:execute –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞
   - ‚úÖ retry:cancel –æ—á–∏—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç

4. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ:**
   - ‚úÖ –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª: –æ—à–∏–±–∫–∞ ‚Üí retry ‚Üí —É—Å–ø–µ—Ö
   - ‚úÖ –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç attempt –ø—Ä–∏ –∫–∞–∂–¥–æ–º retry

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```powershell
# –í—Å–µ —Ç–µ—Å—Ç—ã retry
$env:PYTHONIOENCODING='utf-8'; pytest tests/test_retry_action.py -v -s

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–µ—Å—Ç
pytest tests/test_retry_action.py::test_retry_middleware_catches_error -v -s
```

---

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –º–∞—Å—Ç–µ—Ä–∞

```
1. –ê–¥–º–∏–Ω –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –º–∞—Å—Ç–µ—Ä–∞ –Ω–∞ –∑–∞–∫–∞–∑
2. –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–∞–π–º–∞—É—Ç –ë–î
3. RetryMiddleware –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç:
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç callback_data = "adm:o:assign:123:456"
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç UI —Å –∫–Ω–æ–ø–∫–∞–º–∏
4. –ê–¥–º–∏–Ω –Ω–∞–∂–∏–º–∞–µ—Ç "üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å"
5. retry_execute:
   - –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç
   - –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç attempt –¥–æ 2
   - –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç callback_data
   - –ü–æ–≤—Ç–æ—Ä—è–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ
6. –£—Å–ø–µ—Ö - –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ—á–∏—â–∞–µ—Ç—Å—è
```

### –ü—Ä–∏–º–µ—Ä 2: –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ –ø–æ–ø—ã—Ç–æ–∫

```
1. –î–µ–π—Å—Ç–≤–∏–µ –ø–∞–¥–∞–µ—Ç 3 —Ä–∞–∑–∞ –ø–æ–¥—Ä—è–¥
2. attempt = 1 ‚Üí 2 ‚Üí 3
3. –ü—Ä–∏ 4-–π –ø–æ–ø—ã—Ç–∫–µ:
   retry_execute –ø—Ä–æ–≤–µ—Ä—è–µ—Ç can_retry()
   ‚Üí False (attempt >= MAX_ATTEMPTS)
   ‚Üí –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç: "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ (3)"
   ‚Üí –û—á–∏—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç
```

### –ü—Ä–∏–º–µ—Ä 3: –û—Ç–º–µ–Ω–∞ –ø–æ–≤—Ç–æ—Ä–∞

```
1. –û—à–∏–±–∫–∞ ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è UI
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å"
3. retry_cancel:
   - –û—á–∏—â–∞–µ—Ç retry_context
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç "‚úÖ –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ"
```

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏

### RetryMiddleware

```python
setup_retry_middleware(dp, enabled=True)
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `enabled: bool = True` - –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### RetryContext

```python
class RetryContext:
    MAX_ATTEMPTS = 3  # –ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫
```

**–ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å** –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ/–º–µ–Ω—å—à–µ –ø–æ–ø—ã—Ç–æ–∫

---

## üé® UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ

```python
error_text = (
    "‚ùå <b>–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ</b>\n\n"
    "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n"
    "‚Ä¢ –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é\n"
    "‚Ä¢ –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è\n"
    "‚Ä¢ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ\n\n"
    "–í—ã –º–æ–∂–µ—Ç–µ:"
)
```

### –ö–Ω–æ–ø–∫–∏

```python
builder = InlineKeyboardBuilder()
builder.button(text="üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å", callback_data="retry:execute")
builder.button(text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="retry:cancel")
builder.adjust(2)  # 2 –∫–Ω–æ–ø–∫–∏ –≤ —Ä—è–¥
```

---

## üîç –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–∏ –æ—à–∏–±–∫–µ

```
ERROR Unhandled exception in callback handler: test:action
exc_info=(ValueError, "Test error", <traceback>)
extra={
    "user_id": 123,
    "callback_data": "test:action"
}
```

### –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–µ

```
INFO Retrying action: test:action, attempt 2
extra={
    "user_id": 123,
    "callback_data": "test:action",
    "attempt": 2
}
```

### –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ

```
INFO Retry cancelled by user
extra={"user_id": 123}
```

---

## üöÄ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** - –Ω–µ –Ω—É–∂–Ω–æ –≤ –∫–∞–∂–¥–æ–º handler –¥–æ–±–∞–≤–ª—è—Ç—å try/except
2. **–ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π UX** - –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –≤–µ–∑–¥–µ
3. **–ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞** - –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫ (MAX_ATTEMPTS)
4. **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫
5. **–£–¥–æ–±—Å—Ç–≤–æ** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π

---

## üìå –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

### –ß—Ç–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç—Å—è
- ‚úÖ –û—à–∏–±–∫–∏ –≤ callback handlers
- ‚ùå –û—à–∏–±–∫–∏ –≤ message handlers (–Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç—Å—è)
- ‚ùå –û—à–∏–±–∫–∏ –≤ FSM (–Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç—Å—è)

### –ö–æ–≥–¥–∞ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ï—Å–ª–∏ `enabled=False` –≤ setup_retry_middleware
- –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –≤ –Ω–µ-callback handler'–µ
- –ï—Å–ª–∏ –Ω–µ—Ç FSM state (–Ω–µ —Å–º–æ–∂–µ—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç)

### –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- ‚úÖ Master Bot
- ‚úÖ Admin Bot
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å FSM
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å –¥—Ä—É–≥–∏–º–∏ middleware

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–Ω–µ –≤ P1-13):

1. **–ü–µ—Ä–µ—Ö–≤–∞—Ç Message handlers** - —Ä–∞—Å—à–∏—Ä–∏—Ç—å –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–µ —Ç–æ–ª—å–∫–æ callback
2. **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ —Ç–µ–∫—Å—Ç—ã** - —Ä–∞–∑–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
3. **Exponential backoff** - —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
4. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** - —Å–æ–±–∏—Ä–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø–æ retry (—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑, –∫–∞–∫–∏–µ action)
5. **Admin dashboard** - –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∫–æ—Ç–æ—Ä—ã–µ —á–∞—Å—Ç–æ retry

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (context, middleware, handlers)
- [x] –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ master_bot
- [x] –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ admin_bot  
- [x] –ù–∞–ø–∏—Å–∞–Ω—ã unit —Ç–µ—Å—Ç—ã
- [x] –ù–∞–ø–∏—Å–∞–Ω—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
- [x] –°–æ–∑–¥–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [x] –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [x] –ü—Ä–æ–≤–µ—Ä–µ–Ω –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫
- [x] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

---

**–ê–≤—Ç–æ—Ä:** Claude Sonnet 4.5  
**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 2025-10-09
