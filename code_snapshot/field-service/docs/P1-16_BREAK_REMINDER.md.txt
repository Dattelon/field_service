# P1-16: –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ–± –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –ø–µ—Ä–µ—Ä—ã–≤–∞

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P1 (–≤—ã—Å–æ–∫–∏–π)  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ  
**–î–∞—Ç–∞:** 2025-10-09

### –ü—Ä–æ–±–ª–µ–º–∞

–ú–∞—Å—Ç–µ—Ä –∑–∞–±—ã–≤–∞–µ—Ç –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å–º–µ–Ω—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä—ã–≤–∞, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫:
- –ü–æ—Ç–µ—Ä–µ –∑–∞–∫–∞–∑–æ–≤
- –°–Ω–∏–∂–µ–Ω–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –º–∞—Å—Ç–µ—Ä–æ–≤
- –ù–µ–≥–∞—Ç–∏–≤–Ω–æ–º—É –≤–ª–∏—è–Ω–∏—é –Ω–∞ –º–µ—Ç—Ä–∏–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è

### –†–µ—à–µ–Ω–∏–µ

–ó–∞ 10 –º–∏–Ω—É—Ç –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–µ—Ä—ã–≤–∞ –º–∞—Å—Ç–µ—Ä—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é:
- üü¢ –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å–º–µ–Ω—É
- ‚òï –ü—Ä–æ–¥–ª–∏—Ç—å –ø–µ—Ä–µ—Ä—ã–≤ –µ—â—ë –Ω–∞ 2 —á–∞—Å–∞

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã

1. **`services/break_reminder_scheduler.py`**
   - –§–æ–Ω–æ–≤—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ—Ä—ã–≤–æ–≤
   - –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π —á–µ—Ä–µ–∑ `notifications_outbox`
   - –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è (–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–≤–∞–∂–¥—ã –æ–¥–Ω–æ–º—É –º–∞—Å—Ç–µ—Ä—É)
   - –û—á–∏—Å—Ç–∫–∞ –Ω–∞–±–æ—Ä–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–µ—Ä—ã–≤–∞

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

2. **`bots/master_bot/handlers/shift.py`**
   - –î–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `m:sh:brk:extend` –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è –ø–µ—Ä–µ—Ä—ã–≤–∞

3. **`bots/master_bot/texts.py`**
   - –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ `"break_extended"`

4. **`bots/master_bot/keyboards.py`**
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ `break_reminder_keyboard()`

5. **`services/notifications_watcher.py`**
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è —Å–æ–±—ã—Ç–∏—è `break_reminder`
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `event` –≤ SELECT –∑–∞–ø—Ä–æ—Å

6. **`bots/master_bot/main.py`**
   - –ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ `run_break_reminder()`

---

## üìä –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### 1. –§–æ–Ω–æ–≤—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫

```python
# –ö–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥:
1. –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ—Ö –º–∞—Å—Ç–µ—Ä–æ–≤ —Å shift_status=BREAK
2. –ü—Ä–æ–≤–µ—Ä—è–µ–º break_until
3. –ï—Å–ª–∏ (break_until - now) <= 10 –º–∏–Ω—É—Ç:
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ notifications_outbox
   - –î–æ–±–∞–≤–ª—è–µ–º master_id –≤ –Ω–∞–±–æ—Ä _reminded_master_ids
4. –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ–º _reminded_master_ids –æ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –ø–µ—Ä–µ—Ä—ã–≤–æ–≤
```

### 2. –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

```python
# notifications_watcher.py –ø—Ä–æ–≤–µ—Ä—è–µ—Ç event="break_reminder"
# –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É:
[üü¢ –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å–º–µ–Ω—É] [‚òï –ü—Ä–æ–¥–ª–∏—Ç—å –ø–µ—Ä–µ—Ä—ã–≤]
```

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π

**–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å–º–µ–Ω—É** (`m:sh:brk:ok`):
- –£–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
- shift_status ‚Üí SHIFT_ON
- is_on_shift ‚Üí True
- break_until ‚Üí NULL

**–ü—Ä–æ–¥–ª–∏—Ç—å –ø–µ—Ä–µ—Ä—ã–≤** (`m:sh:brk:extend`):
- –ù–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
- break_until ‚Üí now + 2 —á–∞—Å–∞
- –ú–∞—Å—Ç–µ—Ä –æ—Å—Ç–∞—ë—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å–µ BREAK

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª: `tests/test_p1_16_break_reminder.py`

**–ü–æ–∫—Ä—ã—Ç–∏–µ:**
1. ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∑–∞ 10 –º–∏–Ω—É—Ç –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è
2. ‚úÖ –ù–ï –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–ª—è –¥–ª–∏–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ—Ä—ã–≤–∞ (>10 –º–∏–Ω)
3. ‚úÖ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è (–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–≤–∞–∂–¥—ã)
4. ‚úÖ –û—á–∏—Å—Ç–∫–∞ –Ω–∞–±–æ—Ä–∞ –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–µ—Ä—ã–≤–∞
5. ‚úÖ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
# –í—Å–µ —Ç–µ—Å—Ç—ã P1-16
$env:PYTHONIOENCODING='utf-8'
pytest tests/test_p1_16_break_reminder.py -v -s

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–µ—Å—Ç
pytest tests/test_p1_16_break_reminder.py::test_break_reminder_sent -v -s
```

---

## üì± UX Flow

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –û–±—ã—á–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ

```
1. –ú–∞—Å—Ç–µ—Ä –≤–∑—è–ª –ø–µ—Ä–µ—Ä—ã–≤ 2 —á–∞—Å–∞ (14:00)
2. –ß–µ—Ä–µ–∑ 1 —á–∞—Å 50 –º–∏–Ω—É—Ç (15:50) –ø—Ä–∏—Ö–æ–¥–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:
   
   ‚è∞ –ü–µ—Ä–µ—Ä—ã–≤ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ 10 –º–∏–Ω
   
   –ì–æ—Ç–æ–≤—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å–º–µ–Ω—É?
   
   –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –∏–ª–∏ –ø—Ä–æ–¥–ª–∏—Ç–µ –ø–µ—Ä–µ—Ä—ã–≤ –µ—â—ë –Ω–∞ 2 —á–∞—Å–∞.
   
   [üü¢ –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å–º–µ–Ω—É]
   [‚òï –ü—Ä–æ–¥–ª–∏—Ç—å –ø–µ—Ä–µ—Ä—ã–≤ –Ω–∞ 2 —á–∞—Å–∞]

3. –ú–∞—Å—Ç–µ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–µ—Ä–µ—Ä—ã–≤–∞

```
1. –ú–∞—Å—Ç–µ—Ä –ø–æ–ª—É—á–∏–ª –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
2. –ù–∞–∂–∞–ª "‚òï –ü—Ä–æ–¥–ª–∏—Ç—å –ø–µ—Ä–µ—Ä—ã–≤ –Ω–∞ 2 —á–∞—Å–∞"
3. –°–∏—Å—Ç–µ–º–∞:
   - –û–±–Ω–æ–≤–ª—è–µ—Ç break_until –Ω–∞ +2 —á–∞—Å–∞
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ: "–ü–µ—Ä–µ—Ä—ã–≤ –ø—Ä–æ–¥–ª—ë–Ω –µ—â—ë –Ω–∞ 2 —á–∞—Å–∞."
4. –ß–µ—Ä–µ–∑ 1 —á–∞—Å 50 –º–∏–Ω—É—Ç –ø—Ä–∏–¥—ë—Ç –Ω–æ–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
```

---

## üîç –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ `break_reminder_scheduler.py`

```python
REMINDER_MINUTES_BEFORE = 10  # –ó–∞ —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å
BREAK_DURATION = timedelta(hours=2)  # –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ä—ã–≤–∞
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—É—Å–∫–∞

```python
# –í main.py:
run_break_reminder(interval_seconds=60)  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
```

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å:

1. **% –º–∞—Å—Ç–µ—Ä–æ–≤ –≤–µ—Ä–Ω—É–≤—à–∏—Ö—Å—è –≤–æ–≤—Ä–µ–º—è** - –¥–æ–ª–∂–µ–Ω –≤—ã—Ä–∞—Å—Ç–∏
2. **% –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è "–ü—Ä–æ–¥–ª–∏—Ç—å –ø–µ—Ä–µ—Ä—ã–≤"** - –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –≥–∏–±–∫–æ—Å—Ç–∏
3. **–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞ —Å–º–µ–Ω—É** - –¥–æ–ª–∂–Ω–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å—Å—è
4. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π** - –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞–≥—Ä—É–∑–∫–∏

---

## üöÄ –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ

### Checklist

- [x] –°–æ–∑–¥–∞–Ω —Å–µ—Ä–≤–∏—Å `break_reminder_scheduler.py`
- [x] –î–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `m:sh:brk:extend`
- [x] –û–±–Ω–æ–≤–ª—ë–Ω `notifications_watcher.py`
- [x] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ `main.py`
- [x] –ù–∞–ø–∏—Å–∞–Ω—ã —Ç–µ—Å—Ç—ã
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞

### –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

‚ùå –ù–µ —Ç—Ä–µ–±—É—é—Ç—Å—è (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è)

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ master_bot –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
docker-compose restart master_bot

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
docker-compose logs -f master_bot | grep "break_reminder"
```

---

## üêõ –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–¢–æ—á–Ω–æ—Å—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π**: ¬±1 –º–∏–Ω—É—Ç–∞ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç interval_seconds)
2. **In-memory –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è**: –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞
3. **–ù–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è**: –ó–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–æ 10 –º–∏–Ω—É—Ç

---

## üîÆ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **P2**: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —á–µ—Ä–µ–∑ admin_bot
2. **P2**: –í—ã–±–æ—Ä –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏—è (1—á / 2—á / 4—á)
3. **P3**: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ—Ä—ã–≤–æ–≤ –≤ –ø—Ä–æ—Ñ–∏–ª–µ –º–∞—Å—Ç–µ—Ä–∞
4. **P3**: –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –ø–µ—Ä–µ—Ä—ã–≤–æ–≤ (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)

---

**–ê–≤—Ç–æ—Ä:** Claude Sonnet 4.5  
**–î–∞—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 2025-10-09  
**–í–µ—Ä—Å–∏—è:** 1.0
