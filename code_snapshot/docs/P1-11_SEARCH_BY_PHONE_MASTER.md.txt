# P1-11: –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –∫–ª–∏–µ–Ω—Ç–∞ –∏ –º–∞—Å—Ç–µ—Ä—É

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ  
**–î–∞—Ç–∞:** 2025-10-09  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P1 (–í—ã—Å–æ–∫–∏–π)

---

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–ò–∑ –æ—Ç—á—ë—Ç–∞ UX Analysis:
> **–ü—Ä–æ–±–ª–µ–º–∞:** –ú–æ–∂–Ω–æ –∏—Å–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ ID –∑–∞–∫–∞–∑–∞  
> **–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –æ–ø—Ü–∏–∏ –ø–æ–∏—Å–∫–∞:
> - üî¢ –ü–æ ID –∑–∞–∫–∞–∑–∞
> - üì± –ü–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –∫–ª–∏–µ–Ω—Ç–∞
> - üë§ –ü–æ –º–∞—Å—Ç–µ—Ä—É

---

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. **–í—ã–±–æ—Ä —Ç–∏–ø–∞ –ø–æ–∏—Å–∫–∞**

–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "üîç –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞" –∞–¥–º–∏–Ω –≤–∏–¥–∏—Ç –º–µ–Ω—é:
```
üîç –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞

–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–∏—Å–∫–∞:
[üî¢ –ü–æ ID –∑–∞–∫–∞–∑–∞]
[üì± –ü–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –∫–ª–∏–µ–Ω—Ç–∞]
[üë§ –ü–æ –º–∞—Å—Ç–µ—Ä—É]
[‚ùå –û—Ç–º–µ–Ω–∞]
```

---

### 2. **–ü–æ–∏—Å–∫ –ø–æ ID –∑–∞–∫–∞–∑–∞ (P1-9)**

**–£–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª**, —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞.

**Callback:** `adm:q:search:type:id`  
**State:** `QueueActionFSM.search_by_id`

**Workflow:**
1. –ê–¥–º–∏–Ω –≤–≤–æ–¥–∏—Ç ID (–Ω–∞–ø—Ä–∏–º–µ—Ä: `12345`)
2. –°–∏—Å—Ç–µ–º–∞ –∏—â–µ—Ç –∑–∞–∫–∞–∑ –≤ –ë–î
3. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É
4. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∏—Å–∫–∞—Ç—å –¥—Ä—É–≥–æ–π

---

### 3. **–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –∫–ª–∏–µ–Ω—Ç–∞** ‚≠ê NEW

**Callback:** `adm:q:search:type:phone`  
**State:** `QueueActionFSM.search_by_phone`

**Workflow:**
1. –ê–¥–º–∏–Ω –≤–≤–æ–¥–∏—Ç —Ç–µ–ª–µ—Ñ–æ–Ω (–ª—é–±–æ–π —Ñ–æ—Ä–º–∞—Ç: `+79991234567`, `79991234567`, `9991234567`)
2. –°–∏—Å—Ç–µ–º–∞ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç (—É–±–∏—Ä–∞–µ—Ç –≤—Å—ë –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä)
3. –ò—â–µ—Ç –í–°–ï –∑–∞–∫–∞–∑—ã —Å —ç—Ç–∏–º —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º (LIKE –∑–∞–ø—Ä–æ—Å)
4. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ 20 –∑–∞–∫–∞–∑–æ–≤:
   ```
   üì± –ù–∞–π–¥–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤: 5

   üü¢ #123 ‚Ä¢ –ú–æ—Å–∫–≤–∞, –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π
      üë§ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤ (+79991234567)
      üìå ASSIGNED

   üîµ #456 ‚Ä¢ –ú–æ—Å–∫–≤–∞, –ó–∞–ø–∞–¥–Ω—ã–π
      üë§ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤ (+79991234567)
      üìå CLOSED
   
   ... –∏ –µ—â—ë 3 –∑–∞–∫–∞–∑–∞

   [#123] [#456] [#789] [#101] [#202]
   [üîç –ò—Å–∫–∞—Ç—å –¥—Ä—É–≥–æ–π] [üè† –í –º–µ–Ω—é]
   ```

**Features:**
- ‚úÖ –ì–∏–±–∫–∏–π –ø–æ–∏—Å–∫ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Ü–∏—Ñ—Ä)
- ‚úÖ –ü–æ–∫–∞–∑ –¥–æ 10 –∑–∞–∫–∞–∑–æ–≤ –≤ —Å–ø–∏—Å–∫–µ
- ‚úÖ –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–µ—Ä–≤—ã–º 5
- ‚úÖ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
- ‚úÖ –§–∏–ª—å—Ç—Ä –ø–æ –≥–æ—Ä–æ–¥–∞–º (CITY_ADMIN –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏)
- ‚úÖ –°—Ç–∞—Ç—É—Å —ç–º–æ–¥–∑–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è

**SQL Query:**
```sql
SELECT orders.id, orders.client_phone, orders.client_name, 
       orders.status, orders.created_at,
       cities.name as city_name, districts.name as district_name
FROM orders
JOIN cities ON cities.id = orders.city_id
LEFT JOIN districts ON districts.id = orders.district_id
WHERE (
    orders.client_phone LIKE '%1234567890%'
    OR orders.client_phone LIKE '%1234567890%'  -- –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Ü–∏—Ñ—Ä
)
AND orders.city_id IN (–¥–æ—Å—Ç—É–ø–Ω—ã–µ –≥–æ—Ä–æ–¥–∞)
ORDER BY orders.created_at DESC
LIMIT 20
```

---

### 4. **–ü–æ–∏—Å–∫ –ø–æ –º–∞—Å—Ç–µ—Ä—É** ‚≠ê NEW

**Callback:** `adm:q:search:type:master`  
**State:** `QueueActionFSM.search_by_master`

**Workflow:**
1. –ê–¥–º–∏–Ω –≤–≤–æ–¥–∏—Ç:
   - ID –º–∞—Å—Ç–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: `123`)
   - –ò–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: `–ò–≤–∞–Ω`)
   - –¢–µ–ª–µ—Ñ–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä: `+79997654321`)

2. –°–∏—Å—Ç–µ–º–∞ –∏—â–µ—Ç –º–∞—Å—Ç–µ—Ä–æ–≤ –ø–æ –≤—Å–µ–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

3. **–ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω 1 –º–∞—Å—Ç–µ—Ä** ‚Üí —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –µ–≥–æ –∑–∞–∫–∞–∑—ã

4. **–ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ >1 –º–∞—Å—Ç–µ—Ä–∞** ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞:
   ```
   üë• –ù–∞–π–¥–µ–Ω–æ –º–∞—Å—Ç–µ—Ä–æ–≤: 3

   ‚Ä¢ #45 –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω (+79991111111)
   ‚Ä¢ #67 –ò–≤–∞–Ω–æ–≤–∞ –ú–∞—Ä–∏—è (+79992222222)
   ‚Ä¢ #89 –ò–≤–∞–Ω—á–µ–Ω–∫–æ –ü–µ—Ç—Ä (+79993333333)

   –í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞:
   [#45 –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω]
   [#67 –ò–≤–∞–Ω–æ–≤–∞ –ú–∞—Ä–∏—è]
   [#89 –ò–≤–∞–Ω—á–µ–Ω–∫–æ –ü–µ—Ç]
   [üîç –ò—Å–∫–∞—Ç—å –¥—Ä—É–≥–æ–π] [üè† –í –º–µ–Ω—é]
   ```

5. –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∑–∞–∫–∞–∑—ã –º–∞—Å—Ç–µ—Ä–∞:
   ```
   üë§ –ó–∞–∫–∞–∑—ã –º–∞—Å—Ç–µ—Ä–∞ #45 –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω
   –ù–∞–π–¥–µ–Ω–æ: 7

   üü° #123 ‚Ä¢ –ú–æ—Å–∫–≤–∞, –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π
      üë§ –ö–ª–∏–µ–Ω—Ç –ê
      üìå ASSIGNED

   üöó #456 ‚Ä¢ –ú–æ—Å–∫–≤–∞, –ó–∞–ø–∞–¥–Ω—ã–π
      üë§ –ö–ª–∏–µ–Ω—Ç –ë
      üìå EN_ROUTE

   üîß #789 ‚Ä¢ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, –ù–µ–≤—Å–∫–∏–π
      üë§ –ö–ª–∏–µ–Ω—Ç –í
      üìå WORKING

   ... –∏ –µ—â—ë 4 –∑–∞–∫–∞–∑–∞

   [#123] [#456] [#789] [#101] [#202]
   [üîç –ò—Å–∫–∞—Ç—å –¥—Ä—É–≥–æ–π] [üè† –í –º–µ–Ω—é]
   ```

**Features:**
- ‚úÖ –ü–æ–∏—Å–∫ –ø–æ ID, –∏–º–µ–Ω–∏, —Ñ–∞–º–∏–ª–∏–∏, —Ç–µ–ª–µ—Ñ–æ–Ω—É
- ‚úÖ Case-insensitive –ø–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏
- ‚úÖ –í—ã–±–æ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞ –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ >1
- ‚úÖ –ü–æ–∫–∞–∑ –¥–æ 20 –∑–∞–∫–∞–∑–æ–≤ –º–∞—Å—Ç–µ—Ä–∞
- ‚úÖ –°—Ç–∞—Ç—É—Å —ç–º–æ–¥–∑–∏ (üü°üöóüîßüí∞‚úÖ)
- ‚úÖ –§–∏–ª—å—Ç—Ä –ø–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º –≥–æ—Ä–æ–¥–∞–º

**SQL Queries:**

*–®–∞–≥ 1: –ü–æ–∏—Å–∫ –º–∞—Å—Ç–µ—Ä–æ–≤*
```sql
SELECT masters.id, masters.first_name, masters.last_name, masters.phone
FROM masters
WHERE (
    masters.id = 123  -- –µ—Å–ª–∏ –≤–≤–µ–¥–µ–Ω–æ —á–∏—Å–ª–æ
    OR LOWER(masters.first_name) LIKE '%–∏–≤–∞–Ω%'
    OR LOWER(masters.last_name) LIKE '%–∏–≤–∞–Ω%'
    OR masters.phone LIKE '%1234567890%'  -- –µ—Å–ª–∏ 10+ —Ü–∏—Ñ—Ä
)
LIMIT 10
```

*–®–∞–≥ 2: –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤ –º–∞—Å—Ç–µ—Ä–∞*
```sql
SELECT orders.id, orders.client_phone, orders.client_name,
       orders.status, orders.created_at,
       cities.name, districts.name
FROM orders
JOIN cities ON cities.id = orders.city_id
LEFT JOIN districts ON districts.id = orders.district_id
WHERE orders.assigned_master_id = 45
AND orders.city_id IN (–¥–æ—Å—Ç—É–ø–Ω—ã–µ –≥–æ—Ä–æ–¥–∞)
ORDER BY orders.created_at DESC
LIMIT 20
```

---

## üóÇÔ∏è –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### 1. `field_service/bots/admin_bot/core/states.py`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
```python
class QueueActionFSM(StatesGroup):
    cancel_reason = State()
    search_by_id = State()  # P1-9: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π
    search_type_selection = State()  # P1-11: NEW
    search_by_phone = State()  # P1-11: NEW
    search_by_master = State()  # P1-11: NEW
```

### 2. `field_service/bots/admin_bot/handlers/orders/queue.py`

**–ò–∑–º–µ–Ω–µ–Ω–æ:**
- `_queue_menu_markup()` - —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏: "üîç –ü–æ–∏—Å–∫ –ø–æ ID" ‚Üí "üîç –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞"
- `cb_queue_search_start()` - —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞

**–î–æ–±–∞–≤–ª–µ–Ω–æ 6 –Ω–æ–≤—ã—Ö handlers:**
1. `cb_queue_search_by_id_start()` - –∑–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞ –ø–æ ID
2. `cb_queue_search_by_phone_start()` - –∑–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
3. `cb_queue_search_by_master_start()` - –∑–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞ –ø–æ –º–∞—Å—Ç–µ—Ä—É
4. `queue_search_cancel_all()` - –æ—Ç–º–µ–Ω–∞ –ø–æ–∏—Å–∫–∞ –¥–ª—è phone/master
5. `queue_search_by_phone()` - –ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
6. `queue_search_by_master()` - –ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ –º–∞—Å—Ç–µ—Ä—É
7. `cb_queue_search_master_selected()` - callback –≤—ã–±–æ—Ä–∞ –º–∞—Å—Ç–µ—Ä–∞ –∏–∑ —Å–ø–∏—Å–∫–∞

**–°—Ç—Ä–æ–∫–∏ –∫–æ–¥–∞:** +~450 —Å—Ç—Ä–æ–∫

---

## üéØ Callback —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
adm:q:search
‚îú‚îÄ adm:q:search:type:id ‚Üí –ø–æ–∏—Å–∫ –ø–æ ID
‚îú‚îÄ adm:q:search:type:phone ‚Üí –ø–æ–∏—Å–∫ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
‚îî‚îÄ adm:q:search:type:master ‚Üí –ø–æ–∏—Å–∫ –ø–æ –º–∞—Å—Ç–µ—Ä—É
    ‚îî‚îÄ adm:q:search:master:{master_id} ‚Üí –≤—ã–±–æ—Ä –º–∞—Å—Ç–µ—Ä–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
```

---

## üìä UX Flow

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
```
1. –ê–¥–º–∏–Ω: –û—á–µ—Ä–µ–¥—å –∑–∞—è–≤–æ–∫ ‚Üí üîç –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞
2. –ë–æ—Ç: –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–∏—Å–∫–∞
3. –ê–¥–º–∏–Ω: üì± –ü–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –∫–ª–∏–µ–Ω—Ç–∞
4. –ë–æ—Ç: –í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω
5. –ê–¥–º–∏–Ω: 9991234567
6. –ë–æ—Ç: –ù–∞–π–¥–µ–Ω–æ 3 –∑–∞–∫–∞–∑–∞ [–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ + –∫–Ω–æ–ø–∫–∏]
7. –ê–¥–º–∏–Ω: [–Ω–∞–∂–∏–º–∞–µ—Ç #123]
8. –ë–æ—Ç: [–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É –∑–∞–∫–∞–∑–∞]
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ–∏—Å–∫ –ø–æ –º–∞—Å—Ç–µ—Ä—É (1 –Ω–∞–π–¥–µ–Ω)
```
1. –ê–¥–º–∏–Ω: –û—á–µ—Ä–µ–¥—å –∑–∞—è–≤–æ–∫ ‚Üí üîç –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞
2. –ë–æ—Ç: –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–∏—Å–∫–∞
3. –ê–¥–º–∏–Ω: üë§ –ü–æ –º–∞—Å—Ç–µ—Ä—É
4. –ë–æ—Ç: –í–≤–µ–¥–∏—Ç–µ ID, –∏–º—è –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω
5. –ê–¥–º–∏–Ω: 45
6. –ë–æ—Ç: –ó–∞–∫–∞–∑—ã –º–∞—Å—Ç–µ—Ä–∞ #45 –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω [–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫]
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü–æ–∏—Å–∫ –ø–æ –º–∞—Å—Ç–µ—Ä—É (–Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–∞–π–¥–µ–Ω–æ)
```
1. –ê–¥–º–∏–Ω: –û—á–µ—Ä–µ–¥—å –∑–∞—è–≤–æ–∫ ‚Üí üîç –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞
2. –ë–æ—Ç: –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–∏—Å–∫–∞
3. –ê–¥–º–∏–Ω: üë§ –ü–æ –º–∞—Å—Ç–µ—Ä—É
4. –ë–æ—Ç: –í–≤–µ–¥–∏—Ç–µ ID, –∏–º—è –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω
5. –ê–¥–º–∏–Ω: –ò–≤–∞–Ω
6. –ë–æ—Ç: –ù–∞–π–¥–µ–Ω–æ –º–∞—Å—Ç–µ—Ä–æ–≤: 3 [–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏]
7. –ê–¥–º–∏–Ω: [–Ω–∞–∂–∏–º–∞–µ—Ç #45 –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω]
8. –ë–æ—Ç: –ó–∞–∫–∞–∑—ã –º–∞—Å—Ç–µ—Ä–∞ #45 –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω [–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∑–∞–∫–∞–∑—ã]
```

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã:**
- –§–∏–ª—å—Ç—Ä –ø–æ —Ä–æ–ª—è–º: `StaffRoleFilter(_ALLOWED_ROLES)`
- –§–∏–ª—å—Ç—Ä –ø–æ –≥–æ—Ä–æ–¥–∞–º: `visible_city_ids_for(staff)`
- CITY_ADMIN –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –≥–æ—Ä–æ–¥–∞
- GLOBAL_ADMIN –≤–∏–¥–∏—Ç –≤—Å—ë
- SQL Injection –∑–∞—â–∏—Ç–∞ (–ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)

‚úÖ **Edge cases –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã:**
- –¢–µ–ª–µ—Ñ–æ–Ω <10 —Ü–∏—Ñ—Ä ‚Üí –æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- –ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã ‚Üí –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ + –∫–Ω–æ–ø–∫–∏
- –ú–∞—Å—Ç–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ + –∫–Ω–æ–ø–∫–∏
- –£ –º–∞—Å—Ç–µ—Ä–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤ ‚Üí –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–æ—Ä–æ–¥—É ‚Üí "–Ω–µ –Ω–∞–π–¥–µ–Ω–æ"

---

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ò–Ω–¥–µ–∫—Å—ã –ë–î (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ):
```sql
-- orders
INDEX idx_orders_client_phone (client_phone)
INDEX idx_orders_assigned_master_id (assigned_master_id)
INDEX idx_orders_city_id (city_id)
INDEX idx_orders_created_at (created_at)

-- masters
INDEX idx_masters_phone (phone)
INDEX idx_masters_first_name (first_name)
INDEX idx_masters_last_name (last_name)
```

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- ‚úÖ `LIMIT 20` - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- ‚úÖ `LIMIT 10` - –¥–ª—è –ø–æ–∏—Å–∫–∞ –º–∞—Å—Ç–µ—Ä–æ–≤
- ‚úÖ –ü–æ–∫–∞–∑ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã—Ö 10 –≤ —Ç–µ–∫—Å—Ç–µ
- ‚úÖ –ö–Ω–æ–ø–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤—ã—Ö 5
- ‚úÖ `ORDER BY created_at DESC` —Å –∏–Ω–¥–µ–∫—Å–æ–º
- ‚úÖ –ù–µ—Ç N+1 queries - JOIN'—ã

### Benchmarks (–æ–∂–∏–¥–∞–µ–º—ã–µ):
- –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É: <100ms (LIKE —Å –∏–Ω–¥–µ–∫—Å–æ–º)
- –ü–æ–∏—Å–∫ –º–∞—Å—Ç–µ—Ä–æ–≤: <50ms (–∏–Ω–¥–µ–∫—Å—ã –ø–æ –∏–º–µ–Ω–∏)
- –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤ –º–∞—Å—Ç–µ—Ä–∞: <100ms (–∏–Ω–¥–µ–∫—Å –ø–æ assigned_master_id)

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç-–∫–µ–π—Å—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É:

1. **–ü–æ–ª–Ω—ã–π –Ω–æ–º–µ—Ä:** `+79991234567` ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç
2. **–ë–µ–∑ +:** `79991234567` ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç
3. **–ë–µ–∑ 7:** `9991234567` ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç
4. **–ö–æ—Ä–æ—Ç–∫–∏–π:** `1234567` ‚Üí –æ—à–∏–±–∫–∞
5. **–° –ø—Ä–æ–±–µ–ª–∞–º–∏:** `+7 999 123 45 67` ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç
6. **–° –¥–µ—Ñ–∏—Å–∞–º–∏:** `+7-999-123-45-67` ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç
7. **–ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π:** `1111111111` ‚Üí "–Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
8. **CITY_ADMIN:** –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –≥–æ—Ä–æ–¥–∞

### –¢–µ—Å—Ç-–∫–µ–π—Å—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –º–∞—Å—Ç–µ—Ä—É:

1. **–ü–æ ID:** `123` ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç –º–∞—Å—Ç–µ—Ä–∞ #123
2. **–ü–æ –∏–º–µ–Ω–∏ (—Ç–æ—á–Ω–æ):** `–ò–≤–∞–Ω` ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç –≤—Å–µ—Ö –ò–≤–∞–Ω–æ–≤
3. **–ü–æ –∏–º–µ–Ω–∏ (—á–∞—Å—Ç–∏—á–Ω–æ):** `–ò–≤–∞` ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç –ò–≤–∞–Ω–æ–≤/–ò–≤–∞–Ω–æ–≤—ã—Ö
4. **–ü–æ —Ñ–∞–º–∏–ª–∏–∏:** `–ü–µ—Ç—Ä–æ–≤` ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç –ü–µ—Ç—Ä–æ–≤—ã—Ö
5. **–ü–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É:** `+79991234567` ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç –º–∞—Å—Ç–µ—Ä–∞
6. **–ù–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π:** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—ã–±–æ—Ä–∞
7. **–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ —É –º–∞—Å—Ç–µ—Ä–∞:** "–Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤"
8. **–ú–∞—Å—Ç–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω:** "–Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

---

## üé® UI –≠–º–æ–¥–∑–∏ —Å—Ç–∞—Ç—É—Å—ã

| –°—Ç–∞—Ç—É—Å | –≠–º–æ–¥–∑–∏ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|--------|--------|----------|
| ASSIGNED | üü° | –ù–∞–∑–Ω–∞—á–µ–Ω–æ |
| EN_ROUTE | üöó | –í –ø—É—Ç–∏ |
| WORKING | üîß | –†–∞–±–æ—Ç–∞–µ—Ç |
| PAYMENT | üí∞ | –û–ø–ª–∞—Ç–∞ |
| CLOSED | ‚úÖ | –ó–∞–∫—Ä—ã—Ç |
| CREATED | üîµ | –°–æ–∑–¥–∞–Ω |
| SEARCHING | üîµ | –ü–æ–∏—Å–∫ –º–∞—Å—Ç–µ—Ä–∞ |
| CANCELED | üî¥ | –û—Ç–º–µ–Ω—ë–Ω |

---

## üêõ –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### Telegram Limits:
- **–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:** 4096 —Å–∏–º–≤–æ–ª–æ–≤
  - **–†–µ—à–µ–Ω–∏–µ:** –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ 10 –∑–∞–∫–∞–∑–æ–≤ –≤ —Ç–µ–∫—Å—Ç–µ
- **–ö–Ω–æ–ø–æ–∫ –≤ —Ä—è–¥:** –º–∞–∫—Å–∏–º—É–º ~8
  - **–†–µ—à–µ–Ω–∏–µ:** –ü–æ–∫–∞–∑—ã–≤–∞–µ–º 5 –∫–Ω–æ–ø–æ–∫ –≤ —Ä—è–¥

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- **LIKE –∑–∞–ø—Ä–æ—Å** –º–µ–¥–ª–µ–Ω–Ω–µ–µ —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
  - **–ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ:** LIMIT 20, –∏–Ω–¥–µ–∫—Å—ã
- **–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏** Case-insensitive
  - **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ:** LOWER() + –∏–Ω–¥–µ–∫—Å—ã

---

## üîÆ –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–±—É–¥—É—â–µ–µ)

1. **Full-text search** –¥–ª—è –∏–º—ë–Ω –º–∞—Å—Ç–µ—Ä–æ–≤ (PostgreSQL FTS)
2. **Autocomplete** –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ (—Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö)
3. **–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–æ–≤** –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
4. **–ü–∞–≥–∏–Ω–∞—Ü–∏—è** –¥–ª—è >20 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
5. **–≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤** –≤ CSV
6. **–ü–æ–∏—Å–∫ –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É –¥–∞—Ç**
7. **–ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–∫–∞–∑–∞**
8. **–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã**

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

- [x] –î–æ–±–∞–≤–ª–µ–Ω—ã states –≤ `QueueActionFSM`
- [x] –°–æ–∑–¥–∞–Ω–æ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –ø–æ–∏—Å–∫–∞
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–æ–∏—Å–∫ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–æ–∏—Å–∫ –ø–æ –º–∞—Å—Ç–µ—Ä—É
- [x] –û–±—Ä–∞–±–æ—Ç–∞–Ω—ã edge cases
- [x] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –ø—Ä–æ–π–¥–µ–Ω–∞
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞
- [ ] Unit —Ç–µ—Å—Ç—ã
- [ ] Integration —Ç–µ—Å—Ç—ã
- [ ] –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] Code review
- [ ] Deploy –≤ staging

---

**–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!** üöÄ
