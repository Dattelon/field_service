# üìã Session Summary: Watchdog –¥–ª—è –∏—Å—Ç—ë–∫—à–∏—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤

**–î–∞—Ç–∞ —Å–µ—Å—Å–∏–∏:** 2025-10-10  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ  
**–í–µ—Ä—Å–∏—è:** v1.2.2

---

## üéØ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞

### 1. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã
- –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞: –º–∞—Å—Ç–µ—Ä #86 –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª—Å—è –≤ —Å–ø–∏—Å–∫–µ —Ä—É—á–Ω–æ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
- –ù–∞–π–¥–µ–Ω–∞ –ø—Ä–∏—á–∏–Ω–∞: –∏—Å—Ç—ë–∫—à–∏–π –æ—Ñ—Ñ–µ—Ä #11 "–∑–∞–≤–∏—Å" –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `SENT` –Ω–∞ 13 –º–∏–Ω—É—Ç
- –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ dedicated watchdog –¥–ª—è –∏—Å—Ç—ë–∫—à–∏—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤
- –í—ã—è–≤–ª–µ–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–æ–≤

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞

#### A. –î–æ–±–∞–≤–ª–µ–Ω watchdog –¥–ª—è –∏—Å—Ç—ë–∫—à–∏—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤
**–§–∞–π–ª:** `field_service/services/watchdogs.py`
- –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è `watchdog_expired_offers()`
- –ò–Ω—Ç–µ—Ä–≤–∞–ª: 60 —Å–µ–∫—É–Ω–¥ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ)
- –ü–æ–º–µ—á–∞–µ—Ç –≤—Å–µ –∏—Å—Ç—ë–∫—à–∏–µ –æ—Ñ—Ñ–µ—Ä—ã –∫–∞–∫ `EXPIRED`
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `live_log` –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π logger

#### B. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –∞–¥–º–∏–Ω-–±–æ—Ç
**–§–∞–π–ª:** `field_service/bots/admin_bot/main.py`
- –ò–º–ø–æ—Ä—Ç `watchdog_expired_offers`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ watchdog –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∞–¥–º–∏–Ω-–±–æ—Ç–∞
- Graceful shutdown –≤–º–µ—Å—Ç–µ —Å –¥—Ä—É–≥–∏–º–∏ watchdog-–∞–º–∏

#### C. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç
**–§–∞–π–ª:** `field_service/bots/admin_bot/services/masters.py`
- –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `select_candidates` –∏–∑ `candidates.py`
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω `NameError` –ø—Ä–∏ —Ä—É—á–Ω–æ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –º–∞—Å—Ç–µ—Ä–æ–≤

### 3. –¢–µ—Å—Ç—ã
**–§–∞–π–ª:** `tests/test_watchdog_expired_offers.py`
- 6 test cases —Å –ø–æ–ª–Ω—ã–º –ø–æ–∫—Ä—ã—Ç–∏–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å—Ç—ë–∫—à–∏—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Å—Å–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

### 4. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
**–°–æ–∑–¥–∞–Ω—ã —Ñ–∞–π–ª—ã:**
- `docs/BUGFIX_EXPIRED_OFFERS_WATCHDOG.md` - –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
- `docs/BUGFIX_EXPIRED_OFFERS_QUICKSTART.md` - –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
- –û–±–Ω–æ–≤–ª—ë–Ω `CHANGELOG.md` - –≤–µ—Ä—Å–∏—è v1.2.2

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚è±Ô∏è –ò—Å—Ç—ë–∫—à–∏–µ –æ—Ñ—Ñ–µ—Ä—ã "–∑–∞–≤–∏—Å–∞–ª–∏" –¥–æ 15+ –º–∏–Ω—É—Ç
- üêõ –ú–∞—Å—Ç–µ—Ä–∞ –ø—Ä–æ–ø–∞–¥–∞–ª–∏ –∏–∑ —Å–ø–∏—Å–∫–æ–≤ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
- üìâ –°–Ω–∏–∂–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
- üî¥ –ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚è±Ô∏è –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: ‚â§60 —Å–µ–∫—É–Ω–¥
- ‚úÖ –ú–∞—Å—Ç–µ—Ä–∞ –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
- üìà –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
- ‚úÖ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –ø—Ä–æ—Ü–µ—Å—Å—ã

---

## üöÄ –î–µ–ø–ª–æ–π

### –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∑–∞–≤–∏—Å—à–∏—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤ (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ):
```sql
UPDATE offers 
SET state = 'EXPIRED' 
WHERE state = 'SENT' 
  AND expires_at < NOW();
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –û—Ñ—Ñ–µ—Ä #11 –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ EXPIRED

### –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ):
- –ü—Ä–æ—Ü–µ—Å—Å—ã PID: 14944, 31384, 4228, 7476
- –í—Å–µ —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã

### –ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã:
**–°—Ç–∞—Ç—É—Å:** ‚è≥ –û–∂–∏–¥–∞–µ—Ç —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

**–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞:**
```powershell
# –¢–µ—Ä–º–∏–Ω–∞–ª 1 - Admin Bot
cd C:\ProjectF\field-service
.venv\Scripts\Activate.ps1
python -m field_service.bots.admin_bot.main

# –¢–µ—Ä–º–∏–Ω–∞–ª 2 - Master Bot  
cd C:\ProjectF\field-service
.venv\Scripts\Activate.ps1
python -m field_service.bots.master_bot.main
```

---

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã:
```powershell
$env:PYTHONIOENCODING='utf-8'
pytest tests/test_watchdog_expired_offers.py -v
```
**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** 5 passed

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±–∞ –±–æ—Ç–∞
2. –ü–æ–¥–æ–∂–¥–∞—Ç—å 60+ —Å–µ–∫—É–Ω–¥ (—Ü–∏–∫–ª watchdog)
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞–≤–∏—Å—à–∏—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤:
```sql
SELECT COUNT(*) FROM offers 
WHERE state = 'SENT' AND expires_at < NOW();
```
**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** 0

4. –û—Ç–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω-–±–æ—Ç ‚Üí –ó–∞–∫–∞–∑—ã ‚Üí –û—á–µ—Ä–µ–¥—å
5. –í—ã–±—Ä–∞—Ç—å –∑–∞–∫–∞–∑ ‚Üí –ù–∞–∑–Ω–∞—á–∏—Ç—å ‚Üí –í—Ä—É—á–Ω—É—é
6. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –º–∞—Å—Ç–µ—Ä–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è**

---

## üìÇ –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

```
field_service/
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ watchdogs.py                          # +72 —Å—Ç—Ä–æ–∫–∏ (watchdog_expired_offers)
‚îú‚îÄ‚îÄ bots/
‚îÇ   ‚îî‚îÄ‚îÄ admin_bot/
‚îÇ       ‚îú‚îÄ‚îÄ main.py                           # +–∏–º–ø–æ—Ä—Ç, +task, +cleanup
‚îÇ       ‚îî‚îÄ‚îÄ services/
‚îÇ           ‚îî‚îÄ‚îÄ masters.py                    # +–∏–º–ø–æ—Ä—Ç select_candidates
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ BUGFIX_EXPIRED_OFFERS_WATCHDOG.md    # NEW (282 —Å—Ç—Ä–æ–∫–∏)
‚îÇ   ‚îî‚îÄ‚îÄ BUGFIX_EXPIRED_OFFERS_QUICKSTART.md  # NEW (300 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îî‚îÄ‚îÄ test_watchdog_expired_offers.py       # NEW (223 —Å—Ç—Ä–æ–∫–∏)
‚îî‚îÄ‚îÄ CHANGELOG.md                              # +–≤–µ—Ä—Å–∏—è v1.2.2
```

---

## üîç SQL –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å—à–∏—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 0):
```sql
SELECT id, order_id, master_id, expires_at, NOW() - expires_at AS overdue
FROM offers 
WHERE state = 'SENT' AND expires_at < NOW();
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å—Ç—ë–∫—à–∏—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å:
```sql
SELECT 
    DATE_TRUNC('minute', responded_at) AS minute,
    COUNT(*) AS expired_count
FROM offers
WHERE state = 'EXPIRED'
  AND responded_at > NOW() - INTERVAL '1 hour'
GROUP BY minute
ORDER BY minute DESC;
```

### –¢–æ–ø –∑–∞–∫–∞–∑–æ–≤ —Å —Å–∞–º—ã–º–∏ —Å—Ç–∞—Ä—ã–º–∏ –∏—Å—Ç—ë–∫—à–∏–º–∏ –æ—Ñ—Ñ–µ—Ä–∞–º–∏:
```sql
SELECT 
    o.id AS order_id,
    COUNT(*) AS expired_offers,
    MIN(of.expires_at) AS oldest_expired,
    NOW() - MIN(of.expires_at) AS max_delay
FROM orders o
JOIN offers of ON of.order_id = o.id
WHERE of.state = 'EXPIRED'
  AND of.responded_at > NOW() - INTERVAL '24 hours'
GROUP BY o.id
ORDER BY max_delay DESC
LIMIT 10;
```

---

## üéì –î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –≤ –Ω–æ–≤–æ–º —á–∞—Ç–µ

**–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏:**

1. **–ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞:** –ò—Å—Ç—ë–∫—à–∏–µ –æ—Ñ—Ñ–µ—Ä—ã "–∑–∞–≤–∏—Å–∞–ª–∏" –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ SENT, –º–∞—Å—Ç–µ—Ä–∞ –ø—Ä–æ–ø–∞–¥–∞–ª–∏ –∏–∑ —Å–ø–∏—Å–∫–æ–≤
2. **–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–Ω watchdog `watchdog_expired_offers()` —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 60 —Å–µ–∫
3. **–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:** watchdogs.py, main.py, masters.py
4. **–¢–µ—Å—Ç—ã:** test_watchdog_expired_offers.py (5 passed)
5. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** BUGFIX_EXPIRED_OFFERS_WATCHDOG.md, QUICKSTART

**–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞:**
```powershell
# –ß–∏—Ç–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
cat docs/BUGFIX_EXPIRED_OFFERS_QUICKSTART.md

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
pytest tests/test_watchdog_expired_offers.py -v

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å watchdog —Ä–∞–±–æ—Ç–∞–µ—Ç
docker exec field-service-postgres-1 psql -U fs_user -d field_service -c "
SELECT COUNT(*) FROM offers WHERE state = 'SENT' AND expires_at < NOW();
"
```

**–ï—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**
- –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ >10 –∏—Å—Ç—ë–∫—à–∏—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤/–º–∏–Ω—É—Ç—É
- –ú–µ—Ç—Ä–∏–∫–∏ –≤ Prometheus
- Dashboard –≤ Grafana

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

- [x] Watchdog —Å–æ–∑–¥–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ admin_bot –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
- [x] –ò–º–ø–æ—Ä—Ç select_candidates –¥–æ–±–∞–≤–ª–µ–Ω
- [x] –¢–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã (6 test cases)
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ (2 —Ñ–∞–π–ª–∞)
- [x] CHANGELOG –æ–±–Ω–æ–≤–ª—ë–Ω (v1.2.2)
- [x] –ó–∞–≤–∏—Å—à–∏–µ –æ—Ñ—Ñ–µ—Ä—ã –æ—á–∏—â–µ–Ω—ã –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
- [x] –î—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
- [ ] –ë–æ—Ç—ã –∑–∞–ø—É—â–µ–Ω—ã (—Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞)
- [ ] –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±–∞ –±–æ—Ç–∞ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ QUICKSTART

**–ê–≤—Ç–æ—Ä —Å–µ—Å—Å–∏–∏:** Claude Sonnet 4.5  
**–í—Ä–µ–º—è —Å–µ—Å—Å–∏–∏:** ~40 –º–∏–Ω—É—Ç  
**–¢–æ–∫–µ–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ:** ~84k / 190k
