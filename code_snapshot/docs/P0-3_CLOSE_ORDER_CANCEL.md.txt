# P0-3: –û—Ç–º–µ–Ω–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∑–∞–∫–∞–∑–∞

**–î–∞—Ç–∞**: 2025-10-08  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: P0 (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π)

---

## üìã –ü—Ä–æ–±–ª–µ–º–∞

**–ò—Å—Ö–æ–¥–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è**:
- –ú–∞—Å—Ç–µ—Ä –Ω–∞—á–∞–ª –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–∫—Ä—ã—Ç–∏—è –∑–∞–∫–∞–∑–∞ —á–µ—Ä–µ–∑ FSM `CloseOrderStates`
- –ü–µ—Ä–µ–¥—É–º–∞–ª –∏–ª–∏ –æ—à–∏–±—Å—è
- **–ù–ï–¢ —Å–ø–æ—Å–æ–±–∞ –æ—Ç–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å** –±–µ–∑ –≤–≤–æ–¥–∞ –º—É—Å–æ—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –û–±—â–∞—è –∫–Ω–æ–ø–∫–∞ "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å" (callback: `m:cancel`) –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é, –∞ –Ω–µ –∫ –∫–∞—Ä—Ç–æ—á–∫–µ –∑–∞–∫–∞–∑–∞

**–°—Ü–µ–Ω–∞—Ä–∏–π**:
```
–ú–∞—Å—Ç–µ—Ä: "–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑" (WORKING ‚Üí PAYMENT)
  ‚Üì
–ë–æ—Ç: "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É"
  ‚Üì
–ú–∞—Å—Ç–µ—Ä: [–ø–µ—Ä–µ–¥—É–º–∞–ª] ‚Üí ‚ùå –ù—É–∂–Ω–æ –≤—ã—Ö–æ–¥–∏—Ç—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∏ –∑–∞–Ω–æ–≤–æ –∏—Å–∫–∞—Ç—å –∑–∞–∫–∞–∑
```

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∑–∞–∫–∞–∑–∞:

### 1. –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞

**–§–∞–π–ª**: `field_service/bots/master_bot/keyboards.py`

```python
def close_order_cancel_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π –æ—Ç–º–µ–Ω—ã –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∑–∞–∫–∞–∑–∞."""
    return inline_keyboard([cancel_button(callback_data="m:act:cls:cancel")])
```

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π callback `m:act:cls:cancel` –≤–º–µ—Å—Ç–æ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ `m:cancel`

---

### 2. –î–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã

**–§–∞–π–ª**: `field_service/bots/master_bot/handlers/orders.py`

```python
@router.callback_query(F.data == "m:act:cls:cancel")
async def active_close_cancel(
    callback: CallbackQuery,
    state: FSMContext,
    session: AsyncSession,
    master: m.masters,
) -> None:
    """P0-3: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã –ø—Ä–æ—Ü–µ—Å—Å–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∑–∞–∫–∞–∑–∞."""
    _log.info("active_close_cancel: uid=%s", _callback_uid(callback))
    
    # –ü–æ–ª—É—á–∞–µ–º order_id –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π state
    data = await state.get_data()
    order_id = data.get("close_order_id")
    
    # –û—á–∏—â–∞–µ–º FSM state
    await state.clear()
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    await safe_answer_callback(callback, "‚ùå –ó–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–∫–∞–∑–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ")
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –∫–∞—Ä—Ç–æ—á–∫–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
    if order_id:
        await _render_active_order(callback, session, master, order_id=int(order_id))
    else:
        # –ï—Å–ª–∏ order_id –Ω–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
        await _render_active_order(callback, session, master, order_id=None)
```

**–õ–æ–≥–∏–∫–∞**:
1. –ü–æ–ª—É—á–∏—Ç—å `order_id` –∏–∑ FSM state **–ø–µ—Ä–µ–¥** –æ—á–∏—Å—Ç–∫–æ–π
2. –û—á–∏—Å—Ç–∏—Ç—å FSM state
3. –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "‚ùå –ó–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–∫–∞–∑–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ"
4. –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–∞—Ä—Ç–æ—á–∫–µ –∑–∞–∫–∞–∑–∞ (–∏–ª–∏ —Å–ø–∏—Å–∫—É –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤)

---

## üéØ –ù–æ–≤—ã–π UX Flow

```
–ú–∞—Å—Ç–µ—Ä: "–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑" (order #123, WORKING)
  ‚Üì
–ë–æ—Ç: "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Ä–∞–±–æ—Ç:"
     [‚ùå –û—Ç–º–µ–Ω–∏—Ç—å]  ‚Üê –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞
  ‚Üì
–ú–∞—Å—Ç–µ—Ä: [–Ω–∞–∂–∞–ª ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å]
  ‚Üì
–ë–æ—Ç: Alert "‚ùå –ó–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–∫–∞–∑–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ"
     + –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–∫–∞–∑–∞ #123
     [üèÅ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑] [‚Ü©Ô∏è –ù–∞–∑–∞–¥]
```

---

## üîÑ –ì–¥–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–º–µ–Ω–∞

–ö–Ω–æ–ø–∫–∞ "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å" –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ **–≤—Å–µ—Ö** —à–∞–≥–∞—Ö FSM –∑–∞–∫—Ä—ã—Ç–∏—è –∑–∞–∫–∞–∑–∞:

### 1. CloseOrderStates.amount
```
–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Ä–∞–±–æ—Ç (–≤ —Ä—É–±–ª—è—Ö):
[‚ùå –û—Ç–º–µ–Ω–∏—Ç—å] ‚Üê –î–æ—Å—Ç—É–ø–Ω–∞
```

### 2. CloseOrderStates.act
```
–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç (—Ñ–æ—Ç–æ –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç):
[‚ùå –û—Ç–º–µ–Ω–∏—Ç—å] ‚Üê –î–æ—Å—Ç—É–ø–Ω–∞
```

### 3. –ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–µ –∑–∞–∫–∞–∑—ã
```
–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç (—Ñ–æ—Ç–æ –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç):
[‚ùå –û—Ç–º–µ–Ω–∏—Ç—å] ‚Üê –î–æ—Å—Ç—É–ø–Ω–∞
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç-–∫–µ–π—Å 1: –û—Ç–º–µ–Ω–∞ –Ω–∞ —à–∞–≥–µ –≤–≤–æ–¥–∞ —Å—É–º–º—ã
```
1. –ú–∞—Å—Ç–µ—Ä: "–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑" (#123)
2. –ë–æ—Ç: "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Ä–∞–±–æ—Ç"
3. –ú–∞—Å—Ç–µ—Ä: [‚ùå –û—Ç–º–µ–Ω–∏—Ç—å]
4. ‚úÖ –û–∂–∏–¥–∞–µ—Ç—Å—è: 
   - Alert "‚ùå –ó–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–∫–∞–∑–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ"
   - –í–æ–∑–≤—Ä–∞—Ç –∫ –∫–∞—Ä—Ç–æ—á–∫–µ –∑–∞–∫–∞–∑–∞ #123
   - FSM state –æ—á–∏—â–µ–Ω
```

### –¢–µ—Å—Ç-–∫–µ–π—Å 2: –û—Ç–º–µ–Ω–∞ –Ω–∞ —à–∞–≥–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∞
```
1. –ú–∞—Å—Ç–µ—Ä: "–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑" (#123)
2. –ë–æ—Ç: "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Ä–∞–±–æ—Ç"
3. –ú–∞—Å—Ç–µ—Ä: "5000"
4. –ë–æ—Ç: "–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞–∫—Ç"
5. –ú–∞—Å—Ç–µ—Ä: [‚ùå –û—Ç–º–µ–Ω–∏—Ç—å]
6. ‚úÖ –û–∂–∏–¥–∞–µ—Ç—Å—è:
   - Alert "‚ùå –ó–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–∫–∞–∑–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ"
   - –í–æ–∑–≤—Ä–∞—Ç –∫ –∫–∞—Ä—Ç–æ—á–∫–µ –∑–∞–∫–∞–∑–∞ #123
   - FSM state –æ—á–∏—â–µ–Ω
   - –í–≤–µ–¥—ë–Ω–Ω–∞—è —Å—É–º–º–∞ –ù–ï —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
```

### –¢–µ—Å—Ç-–∫–µ–π—Å 3: –û—Ç–º–µ–Ω–∞ –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
```
1. –ú–∞—Å—Ç–µ—Ä: "–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑" (–≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π #124)
2. –ë–æ—Ç: "–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞–∫—Ç" (—Å—É–º–º–∞ = 0 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
3. –ú–∞—Å—Ç–µ—Ä: [‚ùå –û—Ç–º–µ–Ω–∏—Ç—å]
4. ‚úÖ –û–∂–∏–¥–∞–µ—Ç—Å—è:
   - Alert "‚ùå –ó–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–∫–∞–∑–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ"
   - –í–æ–∑–≤—Ä–∞—Ç –∫ –∫–∞—Ä—Ç–æ—á–∫–µ –∑–∞–∫–∞–∑–∞ #124
   - FSM state –æ—á–∏—â–µ–Ω
```

### –¢–µ—Å—Ç-–∫–µ–π—Å 4: –û—Ç–º–µ–Ω–∞ –±–µ–∑ order_id –≤ state (edge case)
```
1. FSM state –ø–æ–≤—Ä–µ–∂–¥—ë–Ω/–æ—á–∏—â–µ–Ω
2. –ú–∞—Å—Ç–µ—Ä: [‚ùå –û—Ç–º–µ–Ω–∏—Ç—å]
3. ‚úÖ –û–∂–∏–¥–∞–µ—Ç—Å—è:
   - Alert "‚ùå –ó–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–∫–∞–∑–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ"
   - –í–æ–∑–≤—Ä–∞—Ç –∫ —Å–ø–∏—Å–∫—É –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
   - –ë–µ–∑ –æ—à–∏–±–æ–∫
```

---

## üîç –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
_log.info("active_close_cancel: uid=%s", _callback_uid(callback))
```

**–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞**:
```
[INFO] master_bot.orders: active_close_cancel: uid=12345
```

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏

–û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å:
- **–ß–∞—Å—Ç–æ—Ç–∞ –æ—Ç–º–µ–Ω—ã**: —Å–∫–æ–ª—å–∫–æ % –º–∞—Å—Ç–µ—Ä–æ–≤ –æ—Ç–º–µ–Ω—è—é—Ç –∑–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–∫–∞–∑–∞
- **–ù–∞ –∫–∞–∫–æ–º —à–∞–≥–µ**: amount vs act
- **–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏**: –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –ª–∏ –º–∞—Å—Ç–µ—Ä–∞ –∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é –∑–∞–∫–∞–∑–∞

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

- [x] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ `close_order_cancel_keyboard()`
- [x] –î–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `active_close_cancel`
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞
- [ ] –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –î–µ–ø–ª–æ–π –Ω–∞ production
- [ ] –°–±–æ—Ä —Ñ–∏–¥–±–µ–∫–∞ –æ—Ç –º–∞—Å—Ç–µ—Ä–æ–≤

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `field_service/bots/master_bot/keyboards.py` - –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
- `field_service/bots/master_bot/handlers/orders.py` - –¥–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
- `field_service/bots/master_bot/states.py` - FSM states (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

---

## üéì –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –¥—Ä—É–≥–∏—Ö FSM

–≠—Ç–æ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –¥—Ä—É–≥–∏–º FSM –ø—Ä–æ—Ü–µ—Å—Å–∞–º:

```python
# 1. –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å cancel
def some_fsm_cancel_keyboard() -> InlineKeyboardMarkup:
    return inline_keyboard([cancel_button(callback_data="m:some:fsm:cancel")])

# 2. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
@router.callback_query(F.data == "m:some:fsm:cancel")
async def some_fsm_cancel(callback, state, session, ...):
    data = await state.get_data()
    context_id = data.get("context_id")
    
    await state.clear()
    await safe_answer_callback(callback, "‚ùå –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ")
    
    # –í–æ–∑–≤—Ä–∞—Ç –≤ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
    await _render_context(callback, session, context_id=context_id)
```

---

**–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫**: Claude Sonnet 4.5  
**–¢–∏–º–ª–∏–¥**: @username
