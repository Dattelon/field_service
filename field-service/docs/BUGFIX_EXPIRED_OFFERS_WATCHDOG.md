# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: Watchdog –¥–ª—è –∏—Å—Ç—ë–∫—à–∏—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤

**–î–∞—Ç–∞:** 2025-10-10  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P0 (–ö—Ä–∏—Ç–∏—á–Ω–∞—è –æ—à–∏–±–∫–∞)  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

---

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

### –û–ø–∏—Å–∞–Ω–∏–µ
–ú–∞—Å—Ç–µ—Ä #86 –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª—Å—è –≤ —Å–ø–∏—Å–∫–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ –∑–∞–∫–∞–∑ #15, —Ö–æ—Ç—è –≤—Å–µ —É—Å–ª–æ–≤–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª–∏:
- ‚úÖ –ì–æ—Ä–æ–¥: –ú–æ—Å–∫–≤–∞
- ‚úÖ –†–∞–π–æ–Ω: –Æ–ó–ê–û (–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–π –ê–û) 
- ‚úÖ –ù–∞–≤—ã–∫: –≠–ª–µ–∫—Ç—Ä–∏–∫–∞
- ‚úÖ –°—Ç–∞—Ç—É—Å: –∞–∫—Ç–∏–≤–µ–Ω, –Ω–∞ —Å–º–µ–Ω–µ, –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞
1. **–ò—Å—Ç—ë–∫—à–∏–π –æ—Ñ—Ñ–µ—Ä –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏**
   - –û—Ñ—Ñ–µ—Ä #11 –∏—Å—Ç—ë–∫ –≤ 08:38 UTC
   - –î–æ 08:51 UTC (13 –º–∏–Ω—É—Ç!) –æ—Å—Ç–∞–≤–∞–ª—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `SENT`
   - –õ–æ–≥–∏–∫–∞ `select_candidates()` –∏—Å–∫–ª—é—á–∞–ª–∞ –º–∞—Å—Ç–µ—Ä–∞ –∏–∑-–∑–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ—Ñ—Ñ–µ—Ä–∞

2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ dedicated watchdog**
   - –ò—Å—Ç—ë–∫—à–∏–µ –æ—Ñ—Ñ–µ—Ä—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ `distribution_scheduler`
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–∫–∞–∑–æ–≤ –≤ –æ—á–µ—Ä–µ–¥–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
   - –û—Ñ—Ñ–µ—Ä—ã –ø–æ –¥—Ä—É–≥–∏–º –∑–∞–∫–∞–∑–∞–º –º–æ–≥–ª–∏ "–∑–∞–≤–∏—Å–∞—Ç—å"

3. **–î—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–æ–≤**
   - –ó–∞–ø—É—â–µ–Ω–æ –ø–æ 2 –∫–æ–ø–∏–∏ admin_bot –∏ master_bot
   - –ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–∫–∞–∑–æ–≤ —á–µ—Ä–µ–∑ `FOR UPDATE SKIP LOCKED`

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `select_candidates`
**–§–∞–π–ª:** `field_service/bots/admin_bot/services/masters.py`

```python
from field_service.services.candidates import select_candidates
```

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ `NameError: name 'select_candidates' is not defined` –ø—Ä–∏ —Ä—É—á–Ω–æ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –º–∞—Å—Ç–µ—Ä–æ–≤.

### 2. –°–æ–∑–¥–∞–Ω watchdog –¥–ª—è –∏—Å—Ç—ë–∫—à–∏—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤
**–§–∞–π–ª:** `field_service/services/watchdogs.py`

```python
async def watchdog_expired_offers(
    interval_seconds: int = 60,
    *,
    iterations: int | None = None,
) -> None:
    """Periodically mark expired offers as EXPIRED."""
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ **60 —Å–µ–∫—É–Ω–¥** (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ)
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç **–≤—Å–µ** –∏—Å—Ç—ë–∫—à–∏–µ –æ—Ñ—Ñ–µ—Ä—ã, –Ω–µ —Ç–æ–ª—å–∫–æ –≤ –æ—á–µ—Ä–µ–¥–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `live_log` –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π logger
- Graceful shutdown —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä `iterations`

**SQL –∑–∞–ø—Ä–æ—Å:**
```sql
UPDATE offers
SET state = 'EXPIRED', responded_at = NOW()
WHERE state = 'SENT'
  AND expires_at <= NOW()
RETURNING id, order_id, master_id
```

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è watchdog –≤ admin_bot
**–§–∞–π–ª:** `field_service/bots/admin_bot/main.py`

```python
# –ò–º–ø–æ—Ä—Ç
from field_service.services.watchdogs import (
    watchdog_commissions_overdue,
    watchdog_commission_deadline_reminders,
    watchdog_expired_offers,  # ‚Üê –ù–æ–≤—ã–π watchdog
)

# –ó–∞–ø—É—Å–∫
expired_offers_task = asyncio.create_task(
    watchdog_expired_offers(
        interval_seconds=60,  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
    ),
    name="expired_offers_watchdog",
)

# Graceful shutdown
finally:
    for task in (
        heartbeat_task,
        scheduler_task,
        watchdog_task,
        autoclose_task,
        deadline_reminders_task,
        expired_offers_task,  # ‚Üê –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Å–ø–∏—Å–æ–∫
        unassigned_task,
    ):
        if task:
            task.cancel()
```

---

## üß™ –¢–µ—Å—Ç—ã

**–§–∞–π–ª:** `tests/test_watchdog_expired_offers.py`

–ü–æ–∫—Ä—ã—Ç–∏–µ:
- ‚úÖ –ü–æ–º–µ—á–∞–µ—Ç –∏—Å—Ç—ë–∫—à–∏–µ –æ—Ñ—Ñ–µ—Ä—ã –∫–∞–∫ EXPIRED
- ‚úÖ –ù–µ —Ç—Ä–æ–≥–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –æ—Ñ—Ñ–µ—Ä—ã (expires_at –≤ –±—É–¥—É—â–µ–º)
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—Ñ—Ñ–µ—Ä–æ–≤ –∑–∞ —Ä–∞–∑
- ‚úÖ –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —É–∂–µ EXPIRED –æ—Ñ—Ñ–µ—Ä—ã
- ‚úÖ –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç DECLINED –æ—Ñ—Ñ–µ—Ä—ã

**–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:**
```powershell
$env:PYTHONIOENCODING='utf-8'; pytest tests/test_watchdog_expired_offers.py -v
```

---

## üöÄ –î–µ–ø–ª–æ–π

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

1. **–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–æ–≤:**
```powershell
Get-Process python | Where-Object { 
    $_.MainWindowTitle -like '*bot*' 
} | Stop-Process -Force
```

2. **–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–º–µ—Ç–∏—Ç—å –∑–∞–≤–∏—Å—à–∏–µ –æ—Ñ—Ñ–µ—Ä—ã:**
```sql
docker exec field-service-postgres-1 psql -U fs_user -d field_service -c "
UPDATE offers 
SET state = 'EXPIRED' 
WHERE state = 'SENT' 
  AND expires_at < NOW();
"
```

### –ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

**–¢–µ—Ä–º–∏–Ω–∞–ª 1 - Admin Bot:**
```powershell
cd C:\ProjectF\field-service
.venv\Scripts\Activate.ps1
python -m field_service.bots.admin_bot.main
```

**–¢–µ—Ä–º–∏–Ω–∞–ª 2 - Master Bot:**
```powershell
cd C:\ProjectF\field-service
.venv\Scripts\Activate.ps1
python -m field_service.bots.master_bot.main
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ watchdog

**–£—Å–ø–µ—à–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:**
```
[watchdog] expired_offers count=3
[watchdog] offer_expired oid=123 order=45 master=67
```

**–û—à–∏–±–∫–∞:**
```
[watchdog] watchdog_expired_offers error: <Exception details>
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

1. **–ß–µ—Ä–µ–∑ –ë–î:**
```sql
-- –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å 0 —Å—Ç—Ä–æ–∫
SELECT id, order_id, master_id, expires_at 
FROM offers 
WHERE state = 'SENT' 
  AND expires_at < NOW();
```

2. **–ß–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–±–æ—Ç:**
- –û—Ç–∫—Ä—ã—Ç—å –∑–∞–∫–∞–∑ —Å –∏—Å—Ç—ë–∫—à–∏–º –æ—Ñ—Ñ–µ—Ä–æ–º
- –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –Ω–∞–∑–Ω–∞—á–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞ –≤—Ä—É—á–Ω—É—é
- –ú–∞—Å—Ç–µ—Ä –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –≤ —Å–ø–∏—Å–∫–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤

---

## üîÑ Rollback

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –ø—Ä–æ–±–ª–µ–º—ã:

1. **–û—Ç–∫–ª—é—á–∏—Ç—å watchdog** (–≤—Ä–µ–º–µ–Ω–Ω–æ):
```python
# –í main.py –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å:
# expired_offers_task = asyncio.create_task(...)
```

2. **–û—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
```bash
git revert <commit-hash>
```

3. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç—ã**

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚è±Ô∏è –í—Ä–µ–º—è "–∑–∞–≤–∏—Å–∞–Ω–∏—è" –∏—Å—Ç—ë–∫—à–∏—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤: **–¥–æ 15+ –º–∏–Ω—É—Ç**
- üêõ –ú–∞—Å—Ç–µ—Ä–∞ –ø—Ä–æ–ø–∞–¥–∞–ª–∏ –∏–∑ —Å–ø–∏—Å–∫–æ–≤ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
- üìâ –°–Ω–∏–∂–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚è±Ô∏è –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: **‚â§60 —Å–µ–∫—É–Ω–¥**
- ‚úÖ –ú–∞—Å—Ç–µ—Ä–∞ –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
- üìà –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è

---

## üéØ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –±—É–¥—É—â–µ–µ

1. **–ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ —á–∞—Å—Ç—ã—Ö –∏—Å—Ç–µ—á–µ–Ω–∏—è—Ö:**
   - –ï—Å–ª–∏ >10 –æ—Ñ—Ñ–µ—Ä–æ–≤ –∏—Å—Ç–µ–∫–∞—é—Ç –∑–∞ –º–∏–Ω—É—Ç—É ‚Üí —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ alerts_channel
   - –ú–æ–∂–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å SLA

2. **–ú–µ—Ç—Ä–∏–∫–∏ –≤ Prometheus:**
   ```python
   expired_offers_total = Counter('expired_offers_total', 'Total expired offers')
   expired_offers_processing_time = Histogram('expired_offers_processing_seconds')
   ```

3. **Dashboard –≤ Grafana:**
   - –ì—Ä–∞—Ñ–∏–∫ –∏—Å—Ç—ë–∫—à–∏—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
   - –°—Ä–µ–¥–Ω–∏–π –≤–æ–∑—Ä–∞—Å—Ç –∏—Å—Ç—ë–∫—à–∏—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ
   - –¢–æ–ø-5 –∑–∞–∫–∞–∑–æ–≤ —Å —Å–∞–º—ã–º –¥–æ–ª–≥–∏–º "–∑–∞–≤–∏—Å–∞–Ω–∏–µ–º" –æ—Ñ—Ñ–µ—Ä–æ–≤

---

## üìù Changelog

### Added
- Watchdog `watchdog_expired_offers()` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å—Ç—ë–∫—à–∏—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤
- –¢–µ—Å—Ç—ã `test_watchdog_expired_offers.py` (6 test cases)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `live_log` –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π logger

### Fixed
- –ú–∞—Å—Ç–µ—Ä–∞ –ø—Ä–æ–ø–∞–¥–∞–ª–∏ –∏–∑ —Å–ø–∏—Å–∫–æ–≤ —Ä—É—á–Ω–æ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
- –ò—Å—Ç—ë–∫—à–∏–µ –æ—Ñ—Ñ–µ—Ä—ã "–∑–∞–≤–∏—Å–∞–ª–∏" –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ SENT
- `NameError: select_candidates not defined` –≤ `masters.py`

### Changed
- Watchdog –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–º–µ—Å—Ç–µ —Å –∞–¥–º–∏–Ω-–±–æ—Ç–æ–º
- –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏: 60 —Å–µ–∫—É–Ω–¥ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ)

---

## üë• –°–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

- **P0-5:** –ê–≤—Ç–æ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ (distribution_scheduler)
- **P1-10:** Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –Ω–æ–≤—ã—Ö –æ—Ñ—Ñ–µ—Ä–∞—Ö
- **P1-21:** –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –¥–µ–¥–ª–∞–π–Ω–µ –∫–æ–º–∏—Å—Å–∏–π

---

**–ê–≤—Ç–æ—Ä:** Claude + Simzikov  
**Reviewers:** ‚Äî  
**Deployed:** 2025-10-10
