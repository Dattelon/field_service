# üêõ BUGFIX: –ó–∞–∫–∞–∑ –æ—Å—Ç–∞—ë—Ç—Å—è –≤ "–ù–æ–≤—ã—Ö –∑–∞—è–≤–∫–∞—Ö" –ø–æ—Å–ª–µ –ø—Ä–∏–Ω—è—Ç–∏—è

**–î–∞—Ç–∞**: 2025-10-10  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: P0 (Critical)  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ FIXED

---

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### –°–∏–º–ø—Ç–æ–º—ã
1. –ú–∞—Å—Ç–µ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç "‚úÖ –í–∑—è—Ç—å –∑–∞—è–≤–∫—É"
2. –ü—Ä–∏—Ö–æ–¥–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "‚úÖ –ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞. –£–¥–∞—á–∏ –≤ —Ä–∞–±–æ—Ç–µ!"
3. **–ù–û**: –ó–∞–∫–∞–∑ –ù–ï –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ "–ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏"
4. –ú–æ–∂–Ω–æ –Ω–∞–∂–∏–º–∞—Ç—å "–í–∑—è—Ç—å" –ø–æ –∫—Ä—É–≥—É –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
5. –í –ë–î –∑–∞–∫–∞–∑ —Ä–µ–∞–ª—å–Ω–æ –≤ —Å—Ç–∞—Ç—É—Å–µ `ASSIGNED`, –æ—Ñ—Ñ–µ—Ä –≤ —Å—Ç–∞—Ç—É—Å–µ `ACCEPTED`

### –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
```
1. –ú–∞—Å—Ç–µ—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç "–ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏"
2. –í–∏–¥–∏—Ç –∑–∞–∫–∞–∑ #123
3. –ù–∞–∂–∏–º–∞–µ—Ç "–í–∑—è—Ç—å –∑–∞—è–≤–∫—É" ‚Üí OK ‚úÖ
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ —Å–ø–∏—Å–æ–∫ "–ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏"
5. –ó–∞–∫–∞–∑ #123 –≤—Å—ë –µ—â—ë —Ç–∞–º! ‚ùå
```

---

## üîç –ü—Ä–∏—á–∏–Ω–∞ –±–∞–≥–∞

### Root Cause
**SQLAlchemy –∫—ç—à–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ `session` –∏ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∏—Ö –ø–æ—Å–ª–µ `commit()`**

### –î–µ—Ç–∞–ª–∏
```python
# –í offer_accept() handler:
await session.commit()  # ‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∞–Ω—ã –≤ –ë–î
_log.info("transaction committed")

# –ü—Ä–æ–±–ª–µ–º–∞: session –≤—Å—ë –µ—â—ë —Ö—Ä–∞–Ω–∏—Ç —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –∫—ç—à–µ
await _render_offers(callback, session, master, page=page)
```

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ `_load_offers()`:
```python
stmt = select(m.offers).where(
    m.offers.master_id == master_id,
    m.offers.state.in_((m.OfferState.SENT, m.OfferState.VIEWED)),  # ‚ùå
    m.offers.expires_at > func.now(),
)
result = await session.execute(stmt)
```

**SQLAlchemy —á–∏—Ç–∞–µ—Ç –∏–∑ –∫—ç—à–∞ session:**
- –í –∫—ç—à–µ: `offer.state = SENT` (—Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
- –í –ë–î: `offer.state = ACCEPTED` (–Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ commit)

–†–µ–∑—É–ª—å—Ç–∞—Ç: –æ—Ñ—Ñ–µ—Ä –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ñ–∏–ª—å—Ç—Ä `state.in_((SENT, VIEWED))` –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –º–∞—Å—Ç–µ—Ä—É!

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –ü–∞—Ç—á
–î–æ–±–∞–≤–∏—Ç—å `session.expire_all()` –ø–æ—Å–ª–µ `commit()` –≤ `offer_accept()`:

```python
# field-service/field_service/bots/master_bot/handlers/orders.py
# –°—Ç—Ä–æ–∫–∏ 459-469

await session.commit()
_log.info("offer_accept: transaction committed successfully for order=%s", order_id)

# ‚úÖ BUGFIX: –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à SQLAlchemy –ø–æ—Å–ª–µ commit
# –ë–µ–∑ —ç—Ç–æ–≥–æ _render_offers –±—É–¥–µ—Ç —á–∏—Ç–∞—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞,
# –≥–¥–µ –æ—Ñ—Ñ–µ—Ä –≤—Å—ë –µ—â—ë –≤ —Å—Ç–∞—Ç—É—Å–µ SENT/VIEWED –≤–º–µ—Å—Ç–æ ACCEPTED
session.expire_all()
_log.info("offer_accept: session cache expired for order=%s", order_id)

await safe_answer_callback(callback, ALERT_ACCEPT_SUCCESS, show_alert=True)
await _render_offers(callback, session, master, page=page)
```

### –ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
- `session.expire_all()` –ø–æ–º–µ—á–∞–µ—Ç –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã –≤ session –∫–∞–∫ "—É—Å—Ç–∞—Ä–µ–≤—à–∏–µ"
- –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ SQLAlchemy **–∑–∞–Ω–æ–≤–æ —á–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î**
- `_load_offers()` –≤–∏–¥–∏—Ç `offer.state = ACCEPTED` –∏ **–Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ñ—Ñ–µ—Ä**

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit Test
–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç `test_offer_accept_cache_bug.py`:
```python
@pytest.mark.asyncio
async def test_offer_disappears_after_accept(session: AsyncSession) -> None:
    """
    CRITICAL: Regression test –¥–ª—è –±–∞–≥–∞ –≥–¥–µ –∑–∞–∫–∞–∑ –æ—Å—Ç–∞–≤–∞–ª—Å—è –≤ —Å–ø–∏—Å–∫–µ –ø–æ—Å–ª–µ accept.
    """
    # 1. –°–æ–∑–¥–∞—ë–º –æ—Ñ—Ñ–µ—Ä –≤ —Å—Ç–∞—Ç—É—Å–µ SENT
    # 2. –ü—Ä–∏–Ω–∏–º–∞–µ–º –∑–∞–∫–∞–∑ (–º–µ–Ω—è–µ–º state ‚Üí ACCEPTED)
    # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –±–µ–∑ expire_all() - –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞ (–ë–ê–ì)
    # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å expire_all() - –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î (–û–ö)
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
- ‚úÖ –¢–µ—Å—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç
- ‚úÖ –í —Ä–µ–∞–ª—å–Ω–æ–º –±–æ—Ç–µ –∑–∞–∫–∞–∑ –∏—Å—á–µ–∑–∞–µ—Ç –ø–æ—Å–ª–µ –ø—Ä–∏–Ω—è—Ç–∏—è
- ‚úÖ –ù–µ–ª—å–∑—è –ø—Ä–∏–Ω—è—Ç—å –æ–¥–∏–Ω –∑–∞–∫–∞–∑ –¥–≤–∞–∂–¥—ã

---

## üìä –í–ª–∏—è–Ω–∏–µ

### –î–æ —Ñ–∏–∫—Å–∞ (–ë–ê–ì)
- –ú–∞—Å—Ç–µ—Ä –≤–∏–¥–∏—Ç –ø—Ä–∏–Ω—è—Ç—ã–π –∑–∞–∫–∞–∑ –≤ "–ù–æ–≤—ã—Ö –∑–∞—è–≤–∫–∞—Ö"
- –ú–æ–∂–µ—Ç –Ω–∞–∂–∞—Ç—å "–í–∑—è—Ç—å" –ø–æ–≤—Ç–æ—Ä–Ω–æ ‚Üí –ø–æ–ª—É—á–∏—Ç –æ—à–∏–±–∫—É "–£–∂–µ –∑–∞–Ω—è—Ç–æ"
- –ü–ª–æ—Ö–æ–π UX, –ø—É—Ç–∞–Ω–∏—Ü–∞

### –ü–æ—Å–ª–µ —Ñ–∏–∫—Å–∞
- ‚úÖ –ó–∞–∫–∞–∑ –∏—Å—á–µ–∑–∞–µ—Ç —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø—Ä–∏–Ω—è—Ç–∏—è
- ‚úÖ –°–ø–∏—Å–æ–∫ "–ù–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫" –∞–∫—Ç—É–∞–ª–µ–Ω
- ‚úÖ –ú–∞—Å—Ç–µ—Ä –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–∫–∞–∑—ã

---

## üîß –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **field-service/field_service/bots/master_bot/handlers/orders.py**
   - –î–æ–±–∞–≤–ª–µ–Ω `session.expire_all()` –ø–æ—Å–ª–µ commit –≤ `offer_accept()`
   - –°—Ç—Ä–æ–∫–∏ 459-469

2. **field-service/tests/test_offer_accept_cache_bug.py**
   - –ù–æ–≤—ã–π regression test –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–≥–∞

3. **code_snapshot/** (–æ–±–Ω–æ–≤–ª—ë–Ω —á–µ—Ä–µ–∑ export_code_snapshot.py)

---

## üìù –í—ã–≤–æ–¥—ã –∏ best practices

### –£—Ä–æ–∫
**–í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π `session.expire_all()` –ø–æ—Å–ª–µ `commit()` –µ—Å–ª–∏ –¥–∞–ª–µ–µ –±—É–¥–µ—à—å —á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ:**

```python
# ‚ùå WRONG - —á–∏—Ç–∞–µ—Ç –∏–∑ –∫—ç—à–∞
await session.commit()
data = await session.execute(select(...))  # –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ!

# ‚úÖ CORRECT - —á–∏—Ç–∞–µ—Ç –∏–∑ –ë–î
await session.commit()
session.expire_all()  # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à
data = await session.execute(select(...))  # –°–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ!
```

### –ö–æ–≥–¥–∞ –Ω—É–∂–µ–Ω expire_all()
1. –ü–æ—Å–ª–µ `commit()` –µ—Å–ª–∏ –¥–∞–ª–µ–µ –∏–¥—É—Ç SELECT –∑–∞–ø—Ä–æ—Å—ã
2. –ü–æ—Å–ª–µ –º–∞—Å—Å–æ–≤—ã—Ö UPDATE/DELETE —á–µ—Ä–µ–∑ `session.execute()`
3. –ü–µ—Ä–µ–¥ `refresh()` –æ–±—ä–µ–∫—Ç–∞ (–∏–Ω–∞—á–µ –º–æ–∂–µ—Ç –±—ã—Ç—å MissingGreenlet)
4. –í —Ç–µ—Å—Ç–∞—Ö –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
- `session.refresh(obj)` - –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ–±—ä–µ–∫—Ç
- `await session.execute(select(...))` —Å `execution_options(populate_existing=True)`
- –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é session (—Ç—è–∂–µ–ª–æ–≤–µ—Å–Ω–æ)

---

## üéØ Checklist

- [x] –ë–∞–≥ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥—ë–Ω –∏ –ø–æ–Ω—è—Ç–∞ –ø—Ä–∏—á–∏–Ω–∞
- [x] –ü–∞—Ç—á –ø—Ä–∏–º–µ–Ω—ë–Ω –≤ `orders.py`
- [x] –ù–∞–ø–∏—Å–∞–Ω regression test
- [x] –¢–µ—Å—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [x] Code snapshot –æ–±–Ω–æ–≤–ª—ë–Ω
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞
- [x] –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é

---

## üöÄ –î–µ–ø–ª–æ–π

**–ì–æ—Ç–æ–≤ –∫ –¥–µ–ø–ª–æ—é**: –î–ê ‚úÖ

**–†–∏—Å–∫–∏**: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ - –¥–æ–±–∞–≤–ª–µ–Ω –æ–¥–∏–Ω –≤—ã–∑–æ–≤ `expire_all()`

**Rollback –ø–ª–∞–Ω**: –£–±—Ä–∞—Ç—å —Å—Ç—Ä–æ–∫—É `session.expire_all()` –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–µ—Ç—Å—è

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –î–µ–ø–ª–æ–∏—Ç—å –≤ production —Å—Ä–∞–∑—É, —ç—Ç–æ critical fix –¥–ª—è UX
