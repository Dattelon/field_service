# HOTFIX v2: GLOBAL_ADMIN FK-constraint fix

## –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ `staff.id` –≤—ã—è—Å–Ω–∏–ª–æ—Å—å, —á—Ç–æ GLOBAL_ADMIN —Å `tg_id=332786197` **–Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ `staff_users`**, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –æ—à–∏–±–∫–µ FK-constraint –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–ø–∏—Å–∏ –≤ `order_status_history`:

```
ForeignKeyViolationError: Key (changed_by_staff_id)=(0) is not present in table "staff_users"
```

## –†–µ—à–µ–Ω–∏–µ
‚úÖ –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å GLOBAL_ADMIN –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ SQL-—Å–∫—Ä–∏–ø—Ç  
‚úÖ –û–±–Ω–æ–≤–∏—Ç—å middleware –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ superuser –∏–∑ –ë–î –≤–º–µ—Å—Ç–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞

## –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL-—Å–∫—Ä–∏–ø—Ç
```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î (–ø—Ä–∏–º–µ—Ä —Å psql)
psql -h 127.0.0.1 -p 5439 -U fs_user -d field_service

# –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å–∫—Ä–∏–ø—Ç
\i C:/ProjectF/field-service/scripts/init_global_admin.sql

# –ò–ª–∏ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π –∏–∑ PowerShell
cat scripts/init_global_admin.sql | docker exec -i field-service-postgres-1 psql -U fs_user -d field_service
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏
```sql
SELECT id, tg_user_id, full_name, role, is_active 
FROM staff_users 
WHERE tg_user_id = 332786197;
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
```
 id | tg_user_id  | full_name  |     role      | is_active
----+-------------+------------+---------------+-----------
  1 | 332786197   | Superuser  | GLOBAL_ADMIN  | t
```

### 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–¥–º–∏–Ω-–±–æ—Ç
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å (Ctrl+C)
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ
python -m field_service.bots.admin_bot.main
```

### 4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
```
1. –û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç –∫–∞–∫ GLOBAL_ADMIN (tg_id=332786197)
2. –ú–µ–Ω—é ‚Üí üí∞ –§–∏–Ω–∞–Ω—Å—ã ‚Üí –û–∂–∏–¥–∞—é—Ç –æ–ø–ª–∞—Ç—ã
3. –í—ã–±—Ä–∞—Ç—å –∫–æ–º–∏—Å—Å–∏—é ‚Üí ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å <—Å—É–º–º–∞> ‚ÇΩ
4. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–ø–µ—Ä–∞—Ü–∏—è –ø—Ä–æ—Ö–æ–¥–∏—Ç –ë–ï–ó –æ—à–∏–±–æ–∫ FK-constraint
```

## –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- `field_service/bots/admin_bot/handlers_finance.py` ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è staff.id
- `field_service/bots/admin_bot/middlewares.py` ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ superuser –∏–∑ –ë–î
- `scripts/init_global_admin.sql` ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è GLOBAL_ADMIN (–ù–û–í–´–ô –§–ê–ô–õ)

## –í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏
1. **–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π superuser –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** ‚Äî —Ç–µ–ø–µ—Ä—å GLOBAL_ADMIN –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –ë–î
2. **FK-constraint —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** ‚Äî `changed_by_staff_id` —Ç–µ–ø–µ—Ä—å —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –∑–∞–ø–∏—Å—å
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** ‚Äî –µ—Å–ª–∏ superuser –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î, –¥–æ—Å—Ç—É–ø –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ–± –æ—à–∏–±–∫–µ

## –°—Ç–∞—Ç—É—Å
üü¢ **–ì–û–¢–û–í–û –ö –î–ï–ü–õ–û–Æ**

## –î–∞—Ç–∞
03.10.2025, 22:10
