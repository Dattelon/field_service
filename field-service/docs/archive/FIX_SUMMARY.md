# üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –í–´–ü–û–õ–ù–ï–ù–û

## –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –æ–ø–ª–∞—Ç—ã –∫–æ–º–∏—Å—Å–∏–∏ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞ FK violation –∏–∑-–∑–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ `staff_id=0`.

## –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### ‚úÖ 1. Middleware (middlewares.py)
- –£–±—Ä–∞–Ω —Ñ–µ–π–∫–æ–≤—ã–π `StaffUser(id=0)`
- Superuser'—ã –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –ë–î
- –ï—Å–ª–∏ –Ω–µ—Ç –≤ –ë–î ‚Üí –æ—Ç–∫–∞–∑ —Å –ø–æ–Ω—è—Ç–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º

### ‚úÖ 2. –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (handlers_finance.py)
–î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è `staff.id > 0` –≤ —Ç—Ä—ë—Ö –º–µ—Å—Ç–∞—Ö:
- `cb_finance_approve_instant` - –±—ã—Å—Ç—Ä–æ–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ
- `finance_approve_amount` - –æ–¥–æ–±—Ä–µ–Ω–∏–µ —Å –∫–∞—Å—Ç–æ–º–Ω–æ–π —Å—É–º–º–æ–π
- `finance_reject_reason` - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–∏

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

```
field_service/bots/admin_bot/
‚îú‚îÄ‚îÄ middlewares.py          ‚úÖ –ò–ó–ú–ï–ù–Å–ù
‚îî‚îÄ‚îÄ handlers_finance.py     ‚úÖ –ò–ó–ú–ï–ù–Å–ù (3 —Ñ—É–Ω–∫—Ü–∏–∏)
```

## ‚ö†Ô∏è –í–ê–ñ–ù–û: –î–µ–π—Å—Ç–≤–∏—è –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å superuser'–æ–≤ –≤ –ë–î
```sql
SELECT id, tg_user_id, full_name, role 
FROM staff_users 
WHERE role = 'ADMIN' AND is_active = true;
```

### –®–∞–≥ 2–ê: –ï—Å–ª–∏ –ø—É—Å—Ç–æ - –≤—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
```bash
psql -d your_database -f migrations/2025-10-03_register_superusers.sql
```

**–ò–õ–ò**

### –®–∞–≥ 2–ë: –î–æ–±–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ –∫–æ–¥
```python
from field_service.bots.admin_bot.services_db import DBStaffService

staff_service = DBStaffService()
await staff_service.seed_global_admins([
    123456789,  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ TG ID
    987654321,  # –∏–∑ .env ADMIN_TG_IDS
])
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É
1. –í–æ–π—Ç–∏ –∫–∞–∫ superuser ‚Üí –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø ‚úÖ
2. –§–∏–Ω–∞–Ω—Å—ã ‚Üí –û–¥–æ–±—Ä–∏—Ç—å –∫–æ–º–∏—Å—Å–∏—é ‚Üí –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å ‚úÖ

## üìã –ß–µ–∫–ª–∏—Å—Ç

- [ ] –ö–æ–¥ –∑–∞–¥–µ–ø–ª–æ–µ–Ω
- [ ] Superuser'—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `staff_users`
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω –≤—Ö–æ–¥ superuser'–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –æ–¥–æ–±—Ä–µ–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–∏
- [ ] –í –ª–æ–≥–∞—Ö –Ω–µ—Ç FK violation
- [ ] –ö–æ–º–∞–Ω–¥–µ —Å–æ–æ–±—â–µ–Ω–æ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- `BUGFIX_2025-10-03_FK_VIOLATION.md` - –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
- `HOTFIX_INSTRUCTIONS.md` - –±—ã—Å—Ç—Ä–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
- `migrations/2025-10-03_register_superusers.sql` - SQL –º–∏–≥—Ä–∞—Ü–∏—è

## –ê–≤—Ç–æ—Ä

Fix by Claude (–≤–µ–¥—É—â–∏–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –∏ —Ç–∏–º–ª–∏–¥ –ø—Ä–æ–µ–∫—Ç–∞)
