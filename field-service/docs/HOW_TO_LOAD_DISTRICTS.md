# üìö –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –ö–∞–∫ –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å —Ä–∞–π–æ–Ω—ã –¥–ª—è –ò—Ä–∫—É—Ç—Å–∫–∞, –ú–æ—Å–∫–≤—ã –∏ –°–ü–±

## üéØ –ù–∞–π–¥–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç

**–ü—É—Ç—å:** `tools/load_geo_catalog.py`

–≠—Ç–æ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö (–≥–æ—Ä–æ–¥–∞, —Ä–∞–π–æ–Ω—ã, —É–ª–∏—Ü—ã) –∏–∑ CSV —Ñ–∞–π–ª–∞.

---

## üìã –§–æ—Ä–º–∞—Ç CSV –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏

–°–∫—Ä–∏–ø—Ç –æ–∂–∏–¥–∞–µ—Ç CSV —Ñ–∞–π–ª —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏:

```csv
type,city,district,name,centroid_lat,centroid_lon
city,,,–ú–æ—Å–∫–≤–∞,55.7558,37.6173
district,–ú–æ—Å–∫–≤–∞,,–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω,,
district,–ú–æ—Å–∫–≤–∞,,–°–µ–≤–µ—Ä–Ω—ã–π —Ä–∞–π–æ–Ω,,
street,–ú–æ—Å–∫–≤–∞,–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω,–¢–≤–µ—Ä—Å–∫–∞—è —É–ª–∏—Ü–∞,,
```

### –ö–æ–ª–æ–Ω–∫–∏:
- **type** - —Ç–∏–ø –∑–∞–ø–∏—Å–∏: `city` | `district` | `street`
- **city** - –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è district/street)
- **district** - –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–π–æ–Ω–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è street)
- **name** - –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞
- **centroid_lat** - —à–∏—Ä–æ—Ç–∞ —Ü–µ–Ω—Ç—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- **centroid_lon** - –¥–æ–ª–≥–æ—Ç–∞ —Ü–µ–Ω—Ç—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## üîß –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç

### 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
```bash
python -m tools.load_geo_catalog --input geo_catalog.csv
```

### 2. –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ RapidFuzz
–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã:
- **score ‚â• 93%** - –¥—É–±–ª–∏–∫–∞—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è
- **85% ‚â§ score < 93%** - "questionable", —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
- **score < 85%** - –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è

### 3. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π
–ß–µ—Ä–µ–∑ –º–æ–¥—É–ª—å `field_service.data.cities`:
- –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –∞–ª–∏–∞—Å—ã: "–°–ü–±" ‚Üí "–°–∞–Ω–∫—Ç –ü–µ—Ç–µ—Ä–±—É—Ä–≥"
- –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä –∏ –ø—Ä–æ–±–µ–ª—ã
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ –±–µ–ª–æ–º—É —Å–ø–∏—Å–∫—É `ALLOWED_CITIES`

---

## üìä –û—Ç–∫—É–¥–∞ –≤–∑—è–ª–∏—Å—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ò—Ä–∫—É—Ç—Å–∫–∞, –ú–æ—Å–∫–≤—ã –∏ –°–ü–±?

### –í–æ–∑–º–æ–∂–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏:

1. **OpenStreetMap (OSM)** ‚úÖ –ù–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω–æ
   - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã
   - –†–∞–π–æ–Ω—ã, –∫–≤–∞—Ä—Ç–∞–ª—ã, –º–∏–∫—Ä–æ—Ä–∞–π–æ–Ω—ã
   - API: Overpass Turbo

2. **–§–ò–ê–° (–ì–ò–° –ñ–ö–•)** ‚úÖ –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–µ—Å—Ç—Ä
   - –§–µ–¥–µ—Ä–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –∞–¥—Ä–µ—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
   - –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –∏ —Ä–∞–π–æ–Ω—ã –†–§
   - [fias.nalog.ru](https://fias.nalog.ru)

3. **–ì–µ–æ–∫–æ–¥–µ—Ä—ã**
   - Yandex Geocoder API
   - Dadata API
   - 2GIS API

4. **–†—É—á–Ω–æ–π —ç–∫—Å–ø–æ—Ä—Ç –∏–∑ –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã—Ö —Å–∞–π—Ç–æ–≤**

---

## üé¨ –ö–∞–∫ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞–π–æ–Ω—ã –¥–ª—è –¥—Ä—É–≥–∏—Ö –≥–æ—Ä–æ–¥–æ–≤

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å load_geo_catalog.py (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

#### –®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ CSV —Ñ–∞–π–ª

**–ü—Ä–∏–º–µ—Ä –¥–ª—è –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞:**
```csv
type,city,district,name,centroid_lat,centroid_lon
district,–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫,,–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω,55.0415,82.9346
district,–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫,,–ñ–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π —Ä–∞–π–æ–Ω,55.0451,82.8934
district,–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫,,–ó–∞–µ–ª—å—Ü–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω,54.9884,83.0065
district,–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫,,–õ–µ–Ω–∏–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω,55.0271,82.9557
district,–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫,,–î–∑–µ—Ä–∂–∏–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω,55.0530,82.8934
district,–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫,,–ö–∞–ª–∏–Ω–∏–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω,54.8996,82.9863
district,–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫,,–ö–∏—Ä–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω,54.9924,83.0868
district,–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫,,–û–∫—Ç—è–±—Ä—å—Å–∫–∏–π —Ä–∞–π–æ–Ω,55.0828,82.9478
district,–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫,,–ü–µ—Ä–≤–æ–º–∞–π—Å–∫–∏–π —Ä–∞–π–æ–Ω,54.9721,82.8934
district,–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫,,–°–æ–≤–µ—Ç—Å–∫–∏–π —Ä–∞–π–æ–Ω,55.0656,83.0198
```

#### –®–∞–≥ 2: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏–º–ø–æ—Ä—Ç
```bash
# –¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–≥–æ–Ω (–±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è)
python -m tools.load_geo_catalog --input data/novosibirsk.csv --dry-run

# –†–µ–∞–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç
python -m tools.load_geo_catalog --input data/novosibirsk.csv
```

#### –®–∞–≥ 3: –£–¥–∞–ª–∏—Ç–µ "–ì–æ—Ä–æ–¥ —Ü–µ–ª–∏–∫–æ–º"
```bash
python scripts/import_districts.py --remove-placeholder
```

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç import_districts.py

#### –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –ø—Ä–æ—Å—Ç–æ–π CSV:
```csv
city_name,district_name
–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫,–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω
–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫,–ñ–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π —Ä–∞–π–æ–Ω
```

#### –ó–∞–ø—É—Å—Ç–∏—Ç–µ:
```bash
python scripts/import_districts.py --file data/districts.csv
```

---

## üåê –ì–¥–µ –≤–∑—è—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–π–æ–Ω–æ–≤?

### 1. OpenStreetMap (–°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π)

**Overpass Turbo Query:**
```overpass
[out:json];
area["name"="–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫"]["admin_level"="6"]->.city;
(
  relation(area.city)["admin_level"="9"];
);
out geom;
```

**–®–∞–≥–∏:**
1. –ó–∞–π—Ç–∏ –Ω–∞ [overpass-turbo.eu](https://overpass-turbo.eu/)
2. –í—Å—Ç–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å
3. –ù–∞–∂–∞—Ç—å "–í—ã–ø–æ–ª–Ω–∏—Ç—å"
4. –≠–∫—Å–ø–æ—Ä—Ç ‚Üí GeoJSON –∏–ª–∏ CSV

### 2. –§–ò–ê–° (–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–µ—Å—Ç—Ä –†–§)

**–°—Å—ã–ª–∫–∞:** https://fias.nalog.ru/

**–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
1. –°–∫–∞—á–∞—Ç—å –ø–æ–ª–Ω—É—é –±–∞–∑—É (XML/DBF)
2. –ò–∑–≤–ª–µ—á—å —Ä–∞–π–æ–Ω—ã –¥–ª—è –Ω—É–∂–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞
3. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ CSV

### 3. Yandex Geocoder API

```python
import requests

def get_districts(city_name):
    url = "https://geocode-maps.yandex.ru/1.x/"
    params = {
        "apikey": "YOUR_API_KEY",
        "geocode": city_name,
        "kind": "district",
        "format": "json"
    }
    response = requests.get(url, params=params)
    # Parse response...
```

### 4. 2GIS API

```python
import requests

def get_districts_2gis(city_id):
    url = f"https://catalog.api.2gis.com/3.0/items"
    params = {
        "q": "—Ä–∞–π–æ–Ω",
        "region_id": city_id,
        "type": "district",
        "key": "YOUR_API_KEY"
    }
    # ...
```

---

## üîç –ö–∞–∫ —É–∑–Ω–∞—Ç—å —á—Ç–æ –±—ã–ª–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –¥–ª—è –ò—Ä–∫—É—Ç—Å–∫–∞?

### SQL –∑–∞–ø—Ä–æ—Å:
```sql
-- –í—Å–µ —Ä–∞–π–æ–Ω—ã –ò—Ä–∫—É—Ç—Å–∫–∞
SELECT name 
FROM districts 
WHERE city_id = 4 
ORDER BY name;

-- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Ç–∏–ø—É
SELECT 
    CASE 
        WHEN name LIKE '%–º–∏–∫—Ä–æ—Ä–∞–π–æ–Ω%' THEN '–º–∏–∫—Ä–æ—Ä–∞–π–æ–Ω'
        WHEN name LIKE '%–∫–≤–∞—Ä—Ç–∞–ª%' THEN '–∫–≤–∞—Ä—Ç–∞–ª'
        WHEN name LIKE '%–ñ–ö%' THEN '–ñ–ö'
        WHEN name LIKE '%–°–ù–¢%' THEN '–°–ù–¢'
        WHEN name LIKE '%—Ä–∞–π–æ–Ω%' THEN '—Ä–∞–π–æ–Ω'
        WHEN name LIKE '%–æ–∫—Ä—É–≥%' THEN '–æ–∫—Ä—É–≥'
        ELSE '–¥—Ä—É–≥–æ–µ'
    END as type,
    COUNT(*) as count
FROM districts 
WHERE city_id = 4
GROUP BY type
ORDER BY count DESC;
```

---

## üìù –ü—Ä–∏–º–µ—Ä—ã –≥–æ—Ç–æ–≤—ã—Ö CSV –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏

–Ø —Å–æ–∑–¥–∞–ª –¥–ª—è –≤–∞—Å:

1. **`data/districts_sample.csv`** - –ü—Ä–∏–º–µ—Ä—ã –¥–ª—è 5 –≥–æ—Ä–æ–¥–æ–≤ (45 —Ä–∞–π–æ–Ω–æ–≤)
2. **`scripts/import_districts.py`** - –ù–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞

---

## ‚ö° –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –¥–ª—è –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥–∞

```bash
# 1. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª
cat > data/kaliningrad.csv << EOF
type,city,district,name
district,–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥,,–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω
district,–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥,,–ë–∞–ª—Ç–∏–π—Å–∫–∏–π —Ä–∞–π–æ–Ω  
district,–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥,,–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–π —Ä–∞–π–æ–Ω
district,–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥,,–ú–æ—Å–∫–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω
EOF

# 2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ
python -m tools.load_geo_catalog --input data/kaliningrad.csv

# 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ
psql -U postgres -d field_service -c "SELECT * FROM districts WHERE city_id = 40;"
```

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è –∫—Ä—É–ø–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤ (1+ –º–ª–Ω):
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—É—é —Ä–∞–∑–±–∏–≤–∫—É –ø–æ —Ä–∞–π–æ–Ω–∞–º
- ‚úÖ –î–æ–±–∞–≤–ª—è–π—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–æ–≤ (–¥–ª—è –±—É–¥—É—â–µ–≥–æ)
- ‚úÖ –ò—Å—Ç–æ—á–Ω–∏–∫: OSM + –§–ò–ê–°

### –î–ª—è —Å—Ä–µ–¥–Ω–∏—Ö –≥–æ—Ä–æ–¥–æ–≤ (500–∫ - 1 –º–ª–Ω):
- ‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ä–∞–π–æ–Ω—ã (5-10 —à—Ç—É–∫)
- ‚ö†Ô∏è –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ

### –î–ª—è –º–∞–ª—ã—Ö –≥–æ—Ä–æ–¥–æ–≤ (<500–∫):
- ‚úÖ "–ì–æ—Ä–æ–¥ —Ü–µ–ª–∏–∫–æ–º" –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
- ‚ÑπÔ∏è –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

---

## üéØ –ò—Ç–æ–≥

**–°–∫—Ä–∏–ø—Ç –Ω–∞–π–¥–µ–Ω:** `tools/load_geo_catalog.py`  
**–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö:** CSV —Å —Ç–∏–ø–æ–º, –≥–æ—Ä–æ–¥–æ–º, –Ω–∞–∑–≤–∞–Ω–∏–µ–º  
**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:** OSM, –§–ò–ê–°, –ì–µ–æ–∫–æ–¥–µ—Ä—ã  
**–ù–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç:** `scripts/import_districts.py` (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)  

**–î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞–π–æ–Ω–æ–≤ –Ω—É–∂–Ω–æ:**
1. –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–∞–π–æ–Ω–æ–≤ (OSM/–§–ò–ê–°)
2. –°–æ–∑–¥–∞—Ç—å CSV —Ñ–∞–π–ª
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å `load_geo_catalog.py`
4. –£–¥–∞–ª–∏—Ç—å "–ì–æ—Ä–æ–¥ —Ü–µ–ª–∏–∫–æ–º" –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

–•–æ—Ç–∏—Ç–µ —á—Ç–æ–±—ã —è –ø–æ–º–æ–≥ –Ω–∞–π—Ç–∏ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞–π–æ–Ω—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞? üöÄ
