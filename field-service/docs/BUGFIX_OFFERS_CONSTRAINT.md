# –ò–∑–º–µ–Ω–µ–Ω–∏–µ Constraint –¥–ª—è –æ—Ñ—Ñ–µ—Ä–æ–≤

**–î–∞—Ç–∞:** 2025-10-10  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ

---

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

### –û–ø–∏—Å–∞–Ω–∏–µ
Constraint `uq_offers__order_master UNIQUE (order_id, master_id)` –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤ –¥–ª—è —Ç–æ–π –∂–µ –ø–∞—Ä—ã (–∑–∞–∫–∞–∑ + –º–∞—Å—Ç–µ—Ä), –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ñ—Ñ–µ—Ä –±—ã–ª EXPIRED –∏–ª–∏ DECLINED.

### –°—Ü–µ–Ω–∞—Ä–∏–π:
1. –ú–∞—Å—Ç–µ—Ä –ø–æ–ª—É—á–∏–ª –æ—Ñ—Ñ–µ—Ä –Ω–∞ –∑–∞–∫–∞–∑ #15
2. –û—Ñ—Ñ–µ—Ä –∏—Å—Ç—ë–∫ (EXPIRED)
3. –ê–¥–º–∏–Ω –ø—ã—Ç–∞–µ—Ç—Å—è –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ç–æ–≥–æ –∂–µ –º–∞—Å—Ç–µ—Ä–∞ —Å–Ω–æ–≤–∞
4. ‚ùå –û—à–∏–±–∫–∞: `duplicate key value violates unique constraint`

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –ò–∑–º–µ–Ω—ë–Ω constraint –Ω–∞ partial unique index

```sql
-- –£–¥–∞–ª—ë–Ω —Å—Ç–∞—Ä—ã–π constraint
ALTER TABLE offers DROP CONSTRAINT uq_offers__order_master;

-- –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π partial unique index
CREATE UNIQUE INDEX uq_offers__order_master_active 
ON offers (order_id, master_id) 
WHERE state IN ('SENT', 'VIEWED', 'ACCEPTED');
```

### –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:

**–î–æ:**
- Constraint –ø—Ä–∏–º–µ–Ω—è–ª—Å—è –∫–æ **–≤—Å–µ–º** –æ—Ñ—Ñ–µ—Ä–∞–º
- –ù–µ–ª—å–∑—è –±—ã–ª–æ —Å–æ–∑–¥–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –æ—Ñ—Ñ–µ—Ä –¥–∞–∂–µ –ø–æ—Å–ª–µ EXPIRED/DECLINED

**–ü–æ—Å–ª–µ:**
- Index –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –∫ –∞–∫—Ç–∏–≤–Ω—ã–º** –æ—Ñ—Ñ–µ—Ä–∞–º (SENT, VIEWED, ACCEPTED)
- ‚úÖ –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ –æ—Ñ—Ñ–µ—Ä—ã –ø–æ—Å–ª–µ EXPIRED/DECLINED
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –æ—Ñ—Ñ–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç ‚úÖ
```sql
-- –°–æ–∑–¥–∞—ë–º EXPIRED –æ—Ñ—Ñ–µ—Ä
INSERT INTO offers (order_id, master_id, state, ...) 
VALUES (15, 86, 'EXPIRED', ...);
-- ‚úÖ –£—Å–ø–µ—à–Ω–æ

-- –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π SENT –æ—Ñ—Ñ–µ—Ä –¥–ª—è —Ç–æ–π –∂–µ –ø–∞—Ä—ã
INSERT INTO offers (order_id, master_id, state, ...) 
VALUES (15, 86, 'SENT', ...);
-- ‚úÖ –£—Å–ø–µ—à–Ω–æ (—Ä–∞–Ω—å—à–µ —É–ø–∞–ª–æ –±—ã —Å –æ—à–∏–±–∫–æ–π)
```

### –¢–µ—Å—Ç 2: –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤ ‚úÖ
```sql
-- –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å –≤—Ç–æ—Ä–æ–π –∞–∫—Ç–∏–≤–Ω—ã–π –æ—Ñ—Ñ–µ—Ä
INSERT INTO offers (order_id, master_id, state, ...) 
VALUES (15, 86, 'SENT', ...);
-- ‚ùå –û—à–∏–±–∫–∞: duplicate key (–∑–∞—â–∏—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç)
```

---

## üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ:
- ‚úÖ –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ –Ω–∞–∑–Ω–∞—á–∞—Ç—å –º–∞—Å—Ç–µ—Ä–æ–≤ –Ω–∞ –∑–∞–∫–∞–∑—ã
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–æ–∂–µ—Ç –ø–µ—Ä–µ—Å—ã–ª–∞—Ç—å –æ—Ñ—Ñ–µ—Ä—ã –ø–æ—Å–ª–µ —Ç–∞–π–º–∞—É—Ç–∞
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–µ –∑–∞–∫–∞–∑—ã –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –ø—Ä–µ–∂–Ω–µ–º—É –º–∞—Å—Ç–µ—Ä—É

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ:
- ‚úÖ –ú–µ–Ω—å—à–µ —Ä–∞–∑–º–µ—Ä –∏–Ω–¥–µ–∫—Å–∞ (–Ω–µ –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç EXPIRED/DECLINED)
- ‚úÖ –ë–æ–ª–µ–µ –±—ã—Å—Ç—Ä—ã–µ –≤—Å—Ç–∞–≤–∫–∏ (–º–µ–Ω—å—à–µ –ø—Ä–æ–≤–µ—Ä–æ–∫)
- ‚úÖ –õ–æ–≥–∏—á–Ω–∞—è —Å–µ–º–∞–Ω—Ç–∏–∫–∞ (–∑–∞—â–∏—Ç–∞ —Ç–æ–ª—å–∫–æ –≥–¥–µ –Ω—É–∂–Ω–∞)

---

## üîÑ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

### –í–ª–∏—è–Ω–∏–µ –Ω–∞ –∫–æ–¥:
- ‚úÖ –ö–æ–¥ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ SQL –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- ‚úÖ `ON CONFLICT ON CONSTRAINT uq_offers__order_master DO NOTHING` –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å

### –í–ª–∏—è–Ω–∏–µ –Ω–∞ –¥–∞–Ω–Ω—ã–µ:
- ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –æ—Ñ—Ñ–µ—Ä–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å

---

## üìù –ú–∏–≥—Ä–∞—Ü–∏—è

**–§–∞–π–ª:** `migrations/2025-10-10_fix_offers_constraint.sql`

**–ü—Ä–∏–º–µ–Ω–µ–Ω–æ:**
```bash
docker exec field-service-postgres-1 psql -U fs_user -d field_service \
  -f migrations/2025-10-10_fix_offers_constraint.sql
```

**–û—Ç–∫–∞—Ç (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω):**
```sql
-- –£–¥–∞–ª–∏—Ç—å –Ω–æ–≤—ã–π index
DROP INDEX IF EXISTS uq_offers__order_master_active;

-- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–π constraint
ALTER TABLE offers 
ADD CONSTRAINT uq_offers__order_master 
UNIQUE (order_id, master_id);
```

---

## üéØ Use Cases

### 1. –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è
```
–ó–∞–∫–∞–∑ #15 ‚Üí –ú–∞—Å—Ç–µ—Ä #86 ‚Üí EXPIRED (—Ç–∞–π–º–∞—É—Ç)
                ‚Üì
–ê–¥–º–∏–Ω –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –≤—Ä—É—á–Ω—É—é ‚Üí –ú–∞—Å—Ç–µ—Ä #86 ‚Üí SENT ‚úÖ
```

### 2. –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
```
–ó–∞–∫–∞–∑ #20 ‚Üí –ú–∞—Å—Ç–µ—Ä #50 ‚Üí DECLINED (–∑–∞–Ω—è—Ç)
                ‚Üì
–ü–æ–∑–∂–µ –º–∞—Å—Ç–µ—Ä –æ—Å–≤–æ–±–æ–¥–∏–ª—Å—è
                ‚Üì
–ê–≤—Ç–æ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ‚Üí –ú–∞—Å—Ç–µ—Ä #50 ‚Üí SENT ‚úÖ
```

### 3. –ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–µ –∑–∞–∫–∞–∑—ã
```
–ó–∞–∫–∞–∑ #30 (–≥–∞—Ä–∞–Ω—Ç–∏—è) ‚Üí –ò—â–µ–º –ø—Ä–µ–∂–Ω–µ–≥–æ –º–∞—Å—Ç–µ—Ä–∞ #60
                ‚Üì
–ë—ã–ª —Å—Ç–∞—Ä—ã–π –æ—Ñ—Ñ–µ—Ä EXPIRED
                ‚Üì
–°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π ‚Üí –ú–∞—Å—Ç–µ—Ä #60 ‚Üí SENT ‚úÖ
```

---

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ constraint:
```sql
SELECT 
    indexname,
    indexdef
FROM pg_indexes 
WHERE tablename = 'offers' 
  AND indexname = 'uq_offers__order_master_active';
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤:
```sql
SELECT 
    order_id,
    master_id,
    COUNT(*) as offer_count,
    STRING_AGG(state::text, ' ‚Üí ' ORDER BY id) as state_history
FROM offers
GROUP BY order_id, master_id
HAVING COUNT(*) > 1
ORDER BY offer_count DESC
LIMIT 10;
```

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

- **P0-BUGFIX-EXPIRED-OFFERS**: Watchdog –¥–ª—è –∏—Å—Ç—ë–∫—à–∏—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤
- **IMPORT-FIX-MASTERS**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç select_candidates
- **MIDDLEWARE-FIX**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω DbSessionMiddleware –≤ –º–∞—Å—Ç–µ—Ä-–±–æ—Ç–µ

---

**–ê–≤—Ç–æ—Ä:** Claude + Simzikov  
**–ü—Ä–∏–º–µ–Ω–µ–Ω–æ:** 2025-10-10  
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** ‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ
