# üöÄ –ú–ò–ì–†–ê–¶–ò–Ø –†–ê–ô–û–ù–û–í - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é

## üìÅ –§–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏
`2025-10-04_cleanup_districts.sql`

## üéØ –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—è

–£–ø—Ä–æ—â–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ä–∞–π–æ–Ω–æ–≤ –≤ –ë–î:
- **–ò—Ä–∫—É—Ç—Å–∫:** 654 —Ä–∞–π–æ–Ω–∞ ‚Üí **4 –ê–û** (—É–¥–∞–ª—è–µ—Ç 650 –ª–∏—à–Ω–∏—Ö)
- **–ú–æ—Å–∫–≤–∞:** 139 —Ä–∞–π–æ–Ω–æ–≤ ‚Üí **12 –ê–û** (–¥–æ–±–∞–≤–ª—è–µ—Ç 7 –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö)
- **–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥:** 111 –ú–û + –¥—É–±–ª—å –≥–æ—Ä–æ–¥–∞ ‚Üí **18 —Ä–∞–π–æ–Ω–æ–≤**
- **–ö—Ä—É–ø–Ω—ã–µ –≥–æ—Ä–æ–¥–∞:** –¥–æ–±–∞–≤–ª—è–µ—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–∞–π–æ–Ω—ã (7-10 —à—Ç.)
- **–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥:** –¥–æ–±–∞–≤–ª—è–µ—Ç "–ì–æ—Ä–æ–¥ —Ü–µ–ª–∏–∫–æ–º" (—Å–µ–π—á–∞—Å 0 —Ä–∞–π–æ–Ω–æ–≤)

**–ò—Ç–æ–≥–æ:** –° ~904 —Ä–∞–π–æ–Ω–æ–≤ ‚Üí ~138 —Ä–∞–π–æ–Ω–æ–≤ (**–≤ 6.5 —Ä–∞–∑ –º–µ–Ω—å—à–µ!**)

---

## ‚ö†Ô∏è –ü–ï–†–ï–î –í–´–ü–û–õ–ù–ï–ù–ò–ï–ú

### 1. –°–¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø –ë–î

```bash
# –ò–∑ –ø–∞–ø–∫–∏ field-service
cd C:\ProjectF\field-service

# –ü–æ–ª–Ω—ã–π –±—ç–∫–∞–ø
pg_dump -h localhost -U postgres handy_master_system > backup_before_districts_$(date +%Y%m%d_%H%M%S).sql

# –ò–ª–∏ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è DATABASE_URL
pg_dump $DATABASE_URL > backup_before_districts.sql
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```sql
-- –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î
psql handy_master_system

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ –∑–∞–∫–∞–∑—ã –≤ —É–¥–∞–ª—è–µ–º—ã—Ö —Ä–∞–π–æ–Ω–∞—Ö
SELECT COUNT(*) 
FROM orders 
WHERE city_id = 4 
  AND district_id NOT IN (1262, 1263, 1264, 1265);

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥—É–±–ª—å –°–ü–±
SELECT COUNT(*) FROM orders WHERE city_id = 5;
SELECT COUNT(*) FROM masters WHERE city_id = 5;
```

**–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–Ω–µ—Å—ë—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ!** –ù–æ –ª—É—á—à–µ —É–±–µ–¥–∏—Ç—å—Å—è.

---

## üîß –í–´–ü–û–õ–ù–ï–ù–ò–ï –ú–ò–ì–†–ê–¶–ò–ò

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ psql (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î
psql handy_master_system

# –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
\i migrations/2025-10-04_cleanup_districts.sql

# –í—ã–π—Ç–∏
\q
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä—è–º–∞—è –∫–æ–º–∞–Ω–¥–∞

```bash
# –ò–∑ –ø–∞–ø–∫–∏ field-service
psql handy_master_system -f migrations/2025-10-04_cleanup_districts.sql
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ß–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –ï—Å–ª–∏ DATABASE_URL –Ω–∞—Å—Ç—Ä–æ–µ–Ω
psql $DATABASE_URL -f migrations/2025-10-04_cleanup_districts.sql
```

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í

–ú–∏–≥—Ä–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–≤–µ–¥–µ—Ç –æ—Ç—á—ë—Ç:

```
========================================
–§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ú–ò–ì–†–ê–¶–ò–ò
========================================
–í—Å–µ–≥–æ —Ä–∞–π–æ–Ω–æ–≤ –≤ –ë–î: 138

–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –≥–æ—Ä–æ–¥–æ–≤:
  –ú–æ—Å–∫–≤–∞:       12 (–æ–∂–∏–¥–∞–µ—Ç—Å—è 12)
  –°–ü–±:          18 (–æ–∂–∏–¥–∞–µ—Ç—Å—è 18)
  –ò—Ä–∫—É—Ç—Å–∫:      4 (–æ–∂–∏–¥–∞–µ—Ç—Å—è 4)
  –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫:  10 (–æ–∂–∏–¥–∞–µ—Ç—Å—è 10)

–î—É–±–ª–µ–π –≥–æ—Ä–æ–¥–æ–≤: 0 (–æ–∂–∏–¥–∞–µ—Ç—Å—è 0)
========================================

‚úì‚úì‚úì –ú–ò–ì–†–ê–¶–ò–Ø –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–ê ‚úì‚úì‚úì
```

### –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

```sql
-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
SELECT 
    c.name AS city,
    COUNT(d.id) AS districts
FROM cities c
LEFT JOIN districts d ON d.city_id = c.id
GROUP BY c.id, c.name
ORDER BY COUNT(d.id) DESC;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –≥–æ—Ä–æ–¥–æ–≤
SELECT * FROM districts WHERE city_id = 4;  -- –ò—Ä–∫—É—Ç—Å–∫: 4
SELECT * FROM districts WHERE city_id = 1;  -- –ú–æ—Å–∫–≤–∞: 12
SELECT * FROM districts WHERE city_id = 2;  -- –°–ü–±: 18

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–µ–π
SELECT name, COUNT(*) 
FROM cities 
GROUP BY name 
HAVING COUNT(*) > 1;
-- –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å 0 —Å—Ç—Ä–æ–∫!
```

---

## üìä –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –≥–æ—Ä–æ–¥–∞

| –ì–æ—Ä–æ–¥ | –î–æ | –ü–æ—Å–ª–µ | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |
|-------|-----|-------|-----------|
| –ò—Ä–∫—É—Ç—Å–∫ | 654 | 4 –ê–û | ‚úÖ -650 |
| –ú–æ—Å–∫–≤–∞ | 139 | 12 –ê–û | ‚úÖ -127 |
| –°–ü–± | 111+–¥—É–±–ª—å | 18 | ‚úÖ -93 |

### –ö—Ä—É–ø–Ω—ã–µ –≥–æ—Ä–æ–¥–∞ (–¥–æ–±–∞–≤–ª–µ–Ω—ã —Ä–∞–π–æ–Ω—ã)

| –ì–æ—Ä–æ–¥ | –†–∞–π–æ–Ω–æ–≤ |
|-------|---------|
| –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫ | 10 |
| –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ | 7 |
| –ö–∞–∑–∞–Ω—å | 7 |
| –ù.–ù–æ–≤–≥–æ—Ä–æ–¥ | 8 |
| –ß–µ–ª—è–±–∏–Ω—Å–∫ | 7 |
| –ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫ | 7 |
| –°–∞–º–∞—Ä–∞ | 9 |
| –£—Ñ–∞ | 7 |
| –†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É | 8 |

### –û—Å—Ç–∞–ª—å–Ω—ã–µ –≥–æ—Ä–æ–¥–∞

28 –≥–æ—Ä–æ–¥–æ–≤ –æ—Å—Ç–∞—é—Ç—Å—è —Å "–ì–æ—Ä–æ–¥ —Ü–µ–ª–∏–∫–æ–º" (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è —Å—Ä–µ–¥–Ω–∏—Ö –≥–æ—Ä–æ–¥–æ–≤).

---

## üîÑ –û–¢–ö–ê–¢ –ú–ò–ì–†–ê–¶–ò–ò (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

### –ò–∑ –±—ç–∫–∞–ø–∞

```bash
# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–Ω—É—é –ë–î
psql handy_master_system < backup_before_districts_YYYYMMDD_HHMMSS.sql
```

---

## üìû Troubleshooting

### –û—à–∏–±–∫–∞: "duplicate key value violates unique constraint"

**–ü—Ä–∏—á–∏–Ω–∞:** –†–∞–π–æ–Ω —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.

**–†–µ—à–µ–Ω–∏–µ:** –°–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `ON CONFLICT DO NOTHING`, –ø–æ—ç—Ç–æ–º—É –æ—à–∏–±–∫–∏ –±—ã—Ç—å –Ω–µ –¥–æ–ª–∂–Ω–æ. –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∞ - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å constraint –≤ —Ç–∞–±–ª–∏—Ü–µ `districts`.

### –û—à–∏–±–∫–∞: "update or delete on table violates foreign key"

**–ü—Ä–∏—á–∏–Ω–∞:** –ï—Å—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –≤ –¥—Ä—É–≥–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö.

**–†–µ—à–µ–Ω–∏–µ:** –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç –¥–∞–Ω–Ω—ã–µ. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –≤—Å—ë —Ä–∞–≤–Ω–æ –µ—Å—Ç—å:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å—Å—ã–ª–∞—é—Ç—Å—è –Ω–∞ districts
SELECT 
    tc.table_name, 
    kcu.column_name
FROM information_schema.table_constraints tc
JOIN information_schema.key_column_usage kcu 
    ON tc.constraint_name = kcu.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY'
    AND kcu.column_name = 'district_id';
```

---

## ‚úÖ –ß–ï–ö–õ–ò–°–¢ –í–´–ü–û–õ–ù–ï–ù–ò–Ø

- [ ] –ë—ç–∫–∞–ø –ë–î —Å–æ–∑–¥–∞–Ω
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ
- [ ] –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –≥–æ—Ä–æ–¥–æ–≤ OK
- [ ] –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥ –∏–º–µ–µ—Ç 1 —Ä–∞–π–æ–Ω
- [ ] –î—É–±–ª–µ–π –≥–æ—Ä–æ–¥–æ–≤ –Ω–µ—Ç (0)

---

## üéâ –ü–û–°–õ–ï –ú–ò–ì–†–ê–¶–ò–ò

‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–ø—Ä–æ—â–µ–Ω–∞ (–≤ 6.5 —Ä–∞–∑ –º–µ–Ω—å—à–µ —Ä–∞–π–æ–Ω–æ–≤)  
‚úÖ –£–¥–æ–±–Ω–µ–µ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–º–∏ –æ–∫—Ä—É–≥–∞–º–∏  
‚úÖ –õ–µ–≥—á–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ  
‚úÖ –ë—ã—Å—Ç—Ä–µ–µ —Ä–∞–±–æ—Ç–∞–µ—Ç UI (–º–µ–Ω—å—à–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤—ã–±–æ—Ä–∞)  

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~5-10 –º–∏–Ω—É—Ç  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è  
**–†–∏—Å–∫:** –ù–∏–∑–∫–∏–π (–ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –±—ç–∫–∞–ø–∞)

---

## üìù –î–µ—Ç–∞–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ò—Ä–∫—É—Ç—Å–∫ (city_id=4)
–û—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ 4 –ê–û:
- –õ–µ–Ω–∏–Ω—Å–∫–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –æ–∫—Ä—É–≥ (id: 1262)
- –°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –æ–∫—Ä—É–≥ (id: 1263)
- –û–∫—Ç—è–±—Ä—å—Å–∫–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –æ–∫—Ä—É–≥ (id: 1264)
- –ü—Ä–∞–≤–æ–±–µ—Ä–µ–∂–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –æ–∫—Ä—É–≥ (id: 1265)

### –ú–æ—Å–∫–≤–∞ (city_id=1)
–î–æ–±–∞–≤–ª–µ–Ω—ã 7 –ê–û –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º 5:
- –°–í–ê–û, –Æ–í–ê–û, –Æ–ó–ê–û, –°–ó–ê–û, –ó–µ–ª–ê–û, –ù–ê–û, –¢–ê–û

### –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ (city_id=2)
–ü–æ–ª–Ω–∞—è –∑–∞–º–µ–Ω–∞ –Ω–∞ 18 –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Ä–∞–π–æ–Ω–æ–≤:
- –ê–¥–º–∏—Ä–∞–ª—Ç–µ–π—Å–∫–∏–π, –í–∞—Å–∏–ª–µ–æ—Å—Ç—Ä–æ–≤—Å–∫–∏–π, –í—ã–±–æ—Ä–≥—Å–∫–∏–π, –ö–∞–ª–∏–Ω–∏–Ω—Å–∫–∏–π, –ö–∏—Ä–æ–≤—Å–∫–∏–π, –ö–æ–ª–ø–∏–Ω—Å–∫–∏–π, –ö—Ä–∞—Å–Ω–æ–≥–≤–∞—Ä–¥–µ–π—Å–∫–∏–π, –ö—Ä–∞—Å–Ω–æ—Å–µ–ª—å—Å–∫–∏–π, –ö—Ä–æ–Ω—à—Ç–∞–¥—Ç—Å–∫–∏–π, –ö—É—Ä–æ—Ä—Ç–Ω—ã–π, –ú–æ—Å–∫–æ–≤—Å–∫–∏–π, –ù–µ–≤—Å–∫–∏–π, –ü–µ—Ç—Ä–æ–≥—Ä–∞–¥—Å–∫–∏–π, –ü–µ—Ç—Ä–æ–¥–≤–æ—Ä—Ü–æ–≤—ã–π, –ü—Ä–∏–º–æ—Ä—Å–∫–∏–π, –ü—É—à–∫–∏–Ω—Å–∫–∏–π, –§—Ä—É–Ω–∑–µ–Ω—Å–∫–∏–π, –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π

+ –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª—è –≥–æ—Ä–æ–¥–∞ (city_id=5)

---

**–ê–≤—Ç–æ—Ä:** –¢–∏–º–ª–∏–¥ –ø—Ä–æ–µ–∫—Ç–∞  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-10-04  
**–í–µ—Ä—Å–∏—è:** 1.0
