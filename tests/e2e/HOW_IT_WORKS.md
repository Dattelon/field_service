# 🎯 КАК ЭТО РАБОТАЕТ - ВИЗУАЛЬНАЯ СХЕМА

## 📊 Архитектура тестовой системы

```
┌─────────────────────────────────────────────────────────────────────┐
│                         ПОЛЬЗОВАТЕЛЬ                                │
│                             👤                                       │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      quick_start.py                                 │
│                    Точка входа (UI)                                 │
│   ┌─────────────────────────────────────────────────────┐          │
│   │  1. Красивое приветствие                            │          │
│   │  2. Запуск run_all_tests.py                         │          │
│   │  3. Вывод итоговой статистики                       │          │
│   └─────────────────────────────────────────────────────┘          │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      run_all_tests.py                               │
│                    RUNNER (оркестратор)                             │
│   ┌─────────────────────────────────────────────────────┐          │
│   │  FOR каждый сценарий:                               │          │
│   │    1. Создать моки (bot, db)                        │          │
│   │    2. Запустить test_scenario_N()                   │          │
│   │    3. Собрать логи                                  │          │
│   │    4. Проверить assertions                          │          │
│   │    5. Сохранить результат                           │          │
│   │                                                      │          │
│   │  Генерация HTML-отчёта                              │          │
│   └─────────────────────────────────────────────────────┘          │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│              test_order_lifecycle_all_scenarios.py                  │
│                    СЦЕНАРИИ ТЕСТОВ                                  │
│   ┌──────────────────┬──────────────────┬──────────────────┐       │
│   │  test_scenario_1 │  test_scenario_2 │  test_scenario_3 │  ...  │
│   │   (Happy Path)   │  (2 раунда)      │  (Отмены)        │       │
│   └────────┬─────────┴────────┬─────────┴────────┬─────────┘       │
│            │                  │                  │                  │
│            ▼                  ▼                  ▼                  │
│   ┌─────────────────────────────────────────────────────┐          │
│   │           TestLogger (визуализация)                 │          │
│   │  ┌───────────────────────────────────────────────┐ │          │
│   │  │ .action()       👤 Кто делает что             │ │          │
│   │  │ .button_click() 🔵 Нажатие кнопки             │ │          │
│   │  │ .message_sent() 📱 Отправка сообщения         │ │          │
│   │  │ .db_write()     💾 Запись в БД                │ │          │
│   │  │ .fsm_transition() 🔄 FSM переход              │ │          │
│   │  │ .assertion()    ✅ Проверка                   │ │          │
│   │  └───────────────────────────────────────────────┘ │          │
│   └─────────────────────────────────────────────────────┘          │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        conftest.py                                  │
│                    МОКИ и ФИКСТУРЫ                                  │
│   ┌──────────────────┬──────────────────┬──────────────────┐       │
│   │   MockBot        │  MockDatabase    │  TestDataFactory │       │
│   │                  │                  │                  │       │
│   │ .send_message()  │ .fetchrow()      │ .create_order()  │       │
│   │ .send_photo()    │ .execute()       │ .create_master() │       │
│   │ .get_messages()  │ .insert_test_..()│                  │       │
│   └──────────────────┴──────────────────┴──────────────────┘       │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 🔄 Жизненный цикл одного теста (СЦЕНАРИЙ 1)

```
START
  │
  ├─► 1. SETUP (conftest.py)
  │     ├─ Создать MockBot (client, master, admin)
  │     ├─ Создать MockDatabase
  │     ├─ Предзагрузить тестовых мастеров
  │     └─ Создать FSM контексты
  │
  ├─► 2. EXECUTE TEST (test_scenario_1_happy_path)
  │     │
  │     ├─► ЭТАП 1: Создание заказа
  │     │    ├─ log.action("Клиент", "Открывает бота")
  │     │    ├─ bot_client.send("/start") → MockBot
  │     │    ├─ log.message_sent("Клиент", "Добро пожаловать...")
  │     │    ├─ log.button_click("Клиент", "Создать заказ")
  │     │    ├─ db.execute("INSERT INTO orders...") → MockDB
  │     │    ├─ log.db_write("orders", "INSERT", {...})
  │     │    └─ log.assertion("Заказ создан", True)
  │     │
  │     ├─► ЭТАП 2: Автораспределение
  │     │    ├─ db.fetch("SELECT masters...") → Топ-2 мастера
  │     │    ├─ log.timing("Тик 0", 0s)
  │     │    ├─ bot_master.send("Новый заказ...") x2
  │     │    ├─ await asyncio.sleep(35) → эмуляция ожидания
  │     │    ├─ log.button_click("Мастер Иван", "Принять")
  │     │    ├─ db.execute("UPDATE orders...") → assigned
  │     │    └─ log.success("SLA выполнен")
  │     │
  │     ├─► ЭТАП 3-6: Выполнение, оценка, финансы
  │     │    └─ ... (аналогично)
  │     │
  │     └─► RETURN logs (массив всех событий)
  │
  ├─► 3. COLLECT RESULTS (run_all_tests.py)
  │     ├─ Посчитать assertions (сколько ✅)
  │     ├─ Определить статус (PASS/FAIL)
  │     └─ Сохранить в results[]
  │
  ├─► 4. CLEANUP (conftest.py)
  │     ├─ bot_client.reset()
  │     ├─ bot_master.reset()
  │     └─ db.reset()
  │
  └─► 5. GENERATE REPORT (run_all_tests.py)
        ├─ HTML с логами
        ├─ Статистика покрытия
        └─ Итоговая таблица PASS/FAIL

END
```

---

## 📱 Пример: Как логируется одно действие

```python
# В тесте пишем:
log.button_click("Клиент", "Создать заказ", "create_order")

# TestLogger внутри делает:
1. Формирует строку:
   "🔵 Клиент нажал кнопку: 'Создать заказ' (callback: create_order)"

2. Выводит в консоль:
   print("  🔵 Клиент нажал кнопку: 'Создать заказ' ...")

3. Сохраняет в массив logs:
   logs.append({
       "type": "button_click",
       "who": "Клиент",
       "button": "Создать заказ",
       "callback_data": "create_order",
       "timestamp": datetime.now()
   })

4. В HTML-отчёте это отобразится как:
   <div class="log-entry action">
     🔵 Клиент нажал: 'Создать заказ' (create_order)
   </div>
```

---

## 🎨 Цветовое кодирование в выводе

```
👤 Синий   - Действия пользователя (action)
🔵 Синий   - Нажатия кнопок (button_click)
📱 Оранжевый - Сообщения ботов (message_sent)
📥 Зелёный - Входящие от пользователя (message_received)
💾 Фиолетовый - Операции БД (db_write/read)
🔄 Голубой - FSM переходы (fsm_transition)
⚙️  Серый   - Системные события (system_event)
⏱️  Жёлтый - Тайминги (timing)
✅ Зелёный - Успехи (success, assertion=True)
❌ Красный - Ошибки (error, assertion=False)
⚠️  Оранжевый - Предупреждения (warning)
```

---

## 📊 Пример HTML-отчёта (структура)

```html
<!DOCTYPE html>
<html>
<head>
  <title>E2E Test Report</title>
  <style>
    .scenario.pass { border-left: 5px solid green; }
    .scenario.fail { border-left: 5px solid red; }
    .log-entry.action { color: #2196F3; }
    .log-entry.db { color: #9C27B0; }
    ...
  </style>
</head>
<body>
  <h1>🧪 E2E Test Report</h1>
  <p>Всего: 4 теста | ✅ Пройдено: 4 | ❌ Провалено: 0</p>
  
  <div class="scenario pass">
    <h2>СЦЕНАРИЙ 1: Happy Path - PASS</h2>
    
    <div class="log-entry action">
      👤 Клиент: Открывает бота
    </div>
    
    <div class="log-entry db">
      💾 БД[orders].INSERT: {...}
    </div>
    
    <div class="log-entry assertion">
      ✓ Заказ создан в БД
    </div>
    
    ...
  </div>
  
  <div class="scenario pass">
    <h2>СЦЕНАРИЙ 2: Автораспределение - PASS</h2>
    ...
  </div>
</body>
</html>
```

---

## 🚀 Поток данных при запуске

```
USER запускает quick_start.py
    │
    ├─ Инициализация
    │    ├─ import run_all_tests
    │    └─ Вывод приветствия
    │
    ├─ asyncio.run(main())
    │    │
    │    └─ run_all_tests.main()
    │         │
    │         ├─ TestRunner.__init__()
    │         │    └─ results = []
    │         │
    │         ├─ FOR каждый сценарий:
    │         │    │
    │         │    ├─ Создать моки (conftest)
    │         │    │    ├─ MockBot("client")
    │         │    │    ├─ MockBot("master")
    │         │    │    ├─ MockDatabase()
    │         │    │    └─ Предзагрузка мастеров
    │         │    │
    │         │    ├─ Запустить test_scenario_N()
    │         │    │    │
    │         │    │    ├─ TestLogger создаёт logs[]
    │         │    │    │
    │         │    │    ├─ Симуляция действий:
    │         │    │    │    ├─ bot.send() → MockBot
    │         │    │    │    ├─ db.execute() → MockDB
    │         │    │    │    └─ log.X() → добавление в logs[]
    │         │    │    │
    │         │    │    └─ return logs
    │         │    │
    │         │    ├─ Сохранить результат:
    │         │    │    results.append({
    │         │    │        "name": "СЦЕНАРИЙ N",
    │         │    │        "status": "PASS",
    │         │    │        "logs": [...],
    │         │    │        "assertions": 15
    │         │    │    })
    │         │    │
    │         │    └─ Очистить моки
    │         │
    │         ├─ Вывод статистики в консоль
    │         │    ├─ Всего: 4
    │         │    ├─ ✅ Пройдено: 4
    │         │    └─ Покрытие: 88%
    │         │
    │         └─ Генерация HTML
    │              └─ test_report.html
    │
    └─ Вывод финального сообщения
```

---

## 💡 Ключевые возможности

### 1. **Изолированность**
- Каждый тест использует свои моки
- После теста → reset()
- Тесты не влияют друг на друга

### 2. **Детализация**
- Видно **каждое** действие
- Не просто "статус changed"
- А "кто → что нажал → что отправилось → что записалось"

### 3. **Отладка**
- При падении → весь контекст
- Последние 10-20 действий перед ошибкой
- Точный шаг где упало

### 4. **Документация**
- Читая тест = понимаешь флоу
- Новый разработчик видит все кейсы
- Живая спецификация

### 5. **Масштабируемость**
- Легко добавить новый сценарий
- Скопировал шаблон → описал флоу
- Всё остальное автоматически

---

## 🎯 Что дальше?

1. ✅ **Запустите** `quick_start.py`
2. ✅ **Изучите** вывод в консоли
3. ✅ **Откройте** test_report.html
4. ✅ **Допишите** оставшиеся 16 сценариев
5. ✅ **Интегрируйте** в CI/CD

**Результат:** Полная автоматизация тестирования + 100% уверенность в системе! 🚀
